<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureRoad PKI - Control Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        /* Horizontal Navigation Menu */
        .top-nav {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-container {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

        .nav-brand {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
            padding: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-menu {
            display: flex;
            list-style: none;
            gap: 5px;
        }

        .nav-item {
            position: relative;
        }

        .nav-link {
            display: block;
            padding: 20px 20px;
            color: #333;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s;
            cursor: pointer;
        }

        .nav-link:hover {
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .nav-link.active {
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        /* Dropdown Menu */
        .dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            min-width: 250px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            border-radius: 0 0 8px 8px;
            overflow: hidden;
            z-index: 1001;
        }

        .nav-item:hover .dropdown-content {
            display: block;
        }

        .dropdown-item {
            padding: 12px 20px;
            color: #333;
            text-decoration: none;
            display: block;
            transition: all 0.3s;
            cursor: pointer;
        }

        .dropdown-item:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding-left: 25px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        /* Status Bar - Simplified */
        .status-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .status-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .status-card h3 {
            color: #667eea;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .status-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }

        .status-card.success .value {
            color: #10b981;
        }

        .status-card.warning .value {
            color: #f59e0b;
        }

        .status-card.error .value {
            color: #ef4444;
        }

        /* Main Content Area */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .panel h2 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        /* Instance Cards */
        .instance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }

        .instance-card {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            padding: 20px;
            border-radius: 10px;
            color: white;
        }

        .instance-card.aa {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .instance-card.tlm {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .instance-card.rootca {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        .instance-card h3 {
            font-size: 1.1em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .instance-count {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .instance-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .instance-list {
            font-size: 0.85em;
            opacity: 0.95;
            max-height: 150px;
            overflow-y: auto;
            overflow-x: hidden; /* Prevent horizontal scrollbar */
        }

        .instance-item {
            padding: 8px;
            background: rgba(255,255,255,0.15);
            border-radius: 5px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative; /* For pseudo-element positioning */
        }
        
        .instance-item:hover {
            background: rgba(255,255,255,0.25);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        /* Hover indicator without causing scrollbar */
        .instance-item:hover::before {
            content: '→';
            position: absolute;
            left: -15px;
            opacity: 0.8;
            animation: pulse 1s infinite;
        }
        
        /* Stat row for TLM/RootCA info */
        .stat-row {
            padding: 6px 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            margin-bottom: 4px;
            font-size: 0.85em;
        }
        
        .stat-row span:first-child {
            opacity: 0.85;
            font-weight: 500;
        }
        
        .stat-row span:last-child {
            font-weight: 600;
            text-align: right;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 0.3; }
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes flashUpdate {
            0% { background-color: rgba(16, 185, 129, 0.3); }
            100% { background-color: transparent; }
        }
        
        .stat-box.updating {
            animation: flashUpdate 0.5s ease-out;
        }
        
        #statsRefreshIndicator {
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        /* Entity Stats Modal */
        .entity-stats-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            overflow-y: auto;
        }
        
        .entity-stats-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            max-width: 900px;
            margin: 50px auto;
            border-radius: 15px;
            padding: 30px;
            color: white;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        
        .entity-stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255,255,255,0.3);
        }
        
        .entity-stats-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .entity-stats-close:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-box {
            background: rgba(255,255,255,0.15);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .stats-section {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .stats-section h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .stats-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .stats-table th,
        .stats-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .stats-table th {
            font-weight: 600;
            opacity: 0.9;
        }

        /* Log Viewer */
        .log-viewer {
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .log-line {
            margin-bottom: 5px;
            padding: 3px 0;
        }

        .log-line.info {
            color: #10b981;
        }

        .log-line.warning {
            color: #f59e0b;
        }

        .log-line.error {
            color: #ef4444;
        }

        /* View Sections - Hidden by default */
        .view-section {
            display: none;
        }

        .view-section.active {
            display: block;
        }

        /* Endpoints Display */
        .endpoint-list {
            display: grid;
            gap: 8px;
        }

        .endpoint-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f9fafb;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .method {
            padding: 4px 10px;
            border-radius: 4px;
            font-weight: bold;
            margin-right: 12px;
            font-size: 0.85em;
            min-width: 50px;
            text-align: center;
        }

        .method.GET {
            background: #dbeafe;
            color: #1e40af;
        }

        .method.POST {
            background: #d1fae5;
            color: #065f46;
        }

        .endpoint-path {
            color: #666;
            flex: 1;
        }

        .endpoint-entity {
            color: #999;
            font-size: 0.85em;
            margin-left: 10px;
        }

        /* Test Coverage */
        .test-grid {
            display: grid;
            gap: 15px;
        }

        .test-category {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .test-category h4 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .test-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: bold;
            background: #d1fae5;
            color: #065f46;
        }

        .test-description {
            color: #666;
            font-size: 0.9em;
            line-height: 1.6;
            margin-top: 10px;
        }

        /* Features Display */
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .feature-card {
            background: #f9fafb;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            border-top: 3px solid #667eea;
            transition: all 0.3s;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .feature-card .icon {
            font-size: 2.5em;
            margin-bottom: 15px;
        }

        .feature-card h4 {
            color: #333;
            margin-bottom: 10px;
        }

        .feature-card p {
            color: #666;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .feature-card .check {
            color: #10b981;
            font-size: 1.5em;
            margin-top: 10px;
        }

        /* Metrics Display */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .metric-card {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .metric-card .label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }

        .metric-card .value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* API Tester Styles */
        .api-category-card {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .api-test-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 600;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }

        .api-test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .api-test-btn:active {
            transform: translateY(0);
        }


        /* Responsive */
        @media (max-width: 768px) {
            .nav-menu {
                display: none;
            }
            
            .nav-brand {
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="nav-container">
            <div class="nav-brand">
                🔐 SecureRoad PKI
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a class="nav-link active" onclick="showView('dashboard')">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link">Documentation</a>
                    <div class="dropdown-content">
                        <a class="dropdown-item" onclick="showView('endpoints')">📡 API Endpoints</a>
                        <a class="dropdown-item" onclick="showView('features')">✨ Implemented Features</a>
                        <a class="dropdown-item" onclick="window.open('/api/docs', '_blank')">📖 OpenAPI/Swagger</a>
                    </div>
                </li>
                <li class="nav-item">
                    <a class="nav-link">Testing</a>
                    <div class="dropdown-content">
                        <a class="dropdown-item" onclick="showView('api-tester')">🔧 API Tester</a>
                        <a class="dropdown-item" onclick="showView('daily-scenarios')">🎯 Scenari Quotidiani</a>
                        <a class="dropdown-item" onclick="showView('test-coverage')">📊 Test Coverage</a>
                        <a class="dropdown-item" onclick="showView('metrics')">📈 Real-Time Metrics</a>
                        <a class="dropdown-item" onclick="showView('test-results')">🧪 Test Results</a>
                    </div>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <!-- Dashboard View (Default) -->
        <div id="view-dashboard" class="view-section active">
            <!-- Header -->
            <div class="header">
                <h1>🔐 SecureRoad PKI Control Panel</h1>
                <p>ETSI TS 102941 Compliant - Real-time Monitoring Dashboard</p>
            </div>

            <!-- Status Bar -->
            <div class="status-bar">
                <div class="status-card error" id="systemStatusCard">
                    <h3>System Status</h3>
                    <div class="value" id="systemStatus">Inactive</div>
                </div>
                <div class="status-card success">
                    <h3>Running Instances</h3>
                    <div class="value" id="activeInstancesTotal">0</div>
                </div>
                <div class="status-card">
                    <h3>Total Tests</h3>
                    <div class="value">115</div>
                </div>
                <div class="status-card success">
                    <h3>Tests Passing</h3>
                    <div class="value">115</div>
                </div>
                <div class="status-card">
                    <h3>API Endpoints</h3>
                    <div class="value">11</div>
                </div>
                <div class="status-card">
                    <h3>Last Scan</h3>
                    <div class="value" id="lastScanTime">Never</div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <!-- Running Instances Panel -->
                <div class="panel full-width">
                    <h2>🔌 Running Instances</h2>
                    <p style="color: #666; margin-bottom: 20px; font-size: 0.9em;">Real-time monitoring of all active PKI entities</p>
                    
                    <div class="instance-grid">
                        <!-- EA Instances -->
                        <div class="instance-card">
                            <h3>📝 Enrollment Authority</h3>
                            <div class="instance-count" id="instanceCount-EA">0</div>
                            <div class="instance-label">Active Instances</div>
                            <div class="instance-list" id="instanceList-EA">
                                <div class="instance-item" style="opacity: 0.7;">Scanning...</div>
                            </div>
                        </div>

                        <!-- AA Instances -->
                        <div class="instance-card aa">
                            <h3>🎫 Authorization Authority</h3>
                            <div class="instance-count" id="instanceCount-AA">0</div>
                            <div class="instance-label">Active Instances</div>
                            <div class="instance-list" id="instanceList-AA">
                                <div class="instance-item" style="opacity: 0.7;">Scanning...</div>
                            </div>
                        </div>

                        <!-- TLM Instances -->
                        <div class="instance-card tlm">
                            <h3>📋 Trust List Manager</h3>
                            <div class="instance-count" id="instanceCount-TLM">0</div>
                            <div class="instance-label">Active Instances</div>
                            <div class="instance-list" id="instanceList-TLM">
                                <div class="instance-item" style="opacity: 0.7;">Scanning...</div>
                            </div>
                        </div>

                        <!-- RootCA Instances -->
                        <div class="instance-card rootca">
                            <h3>🏛️ Root CA</h3>
                            <div class="instance-count" id="instanceCount-RootCA">0</div>
                            <div class="instance-label">Active Instances</div>
                            <div class="instance-list" id="instanceList-RootCA">
                                <div class="instance-item" style="opacity: 0.7;">Scanning...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bulk Entity Generator Panel -->
                <div class="panel full-width">
                    <h2>🏗️ Bulk Entity Generator</h2>
                    <p style="color: #666; margin-bottom: 20px; font-size: 0.9em;">Generate multiple PKI entities at once with automatic terminal startup</p>
                    
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 10px; color: white; text-align: center;">
                        <div style="font-size: 2.5em; margin-bottom: 15px;">🏗️</div>
                        <h3 style="margin-bottom: 15px;">Quick Entity Setup</h3>
                        <p style="font-size: 0.95em; opacity: 0.95; margin-bottom: 20px; line-height: 1.6;">
                            Create multiple Enrollment Authorities, Authorization Authorities, and Trust List Manager with custom names. 
                            All entities will automatically start in separate terminal windows.
                        </p>
                        <button class="btn btn-success" style="width: 100%; max-width: 400px; background: white; color: #667eea; font-weight: bold; font-size: 1.1em; padding: 15px;" onclick="showEntityGeneratorForm()">
                            ➕ Generate Multiple Entities
                        </button>
                    </div>
                </div>

                <!-- TLM & RootCA Statistics Panel -->
                <div class="panel full-width">
                    <h2>📋 Trust List Manager & 🏛️ Root CA</h2>
                    <p style="color: #666; margin-bottom: 20px; font-size: 0.9em;">System-level PKI hierarchy and trust list management</p>
                    
                    <div class="instance-grid">
                        <!-- TLM Stats -->
                        <div class="instance-card tlm">
                            <h3>📋 Trust List Manager</h3>
                            <div class="instance-label">Status</div>
                            <div class="instance-list">
                                <div class="stat-row">
                                    <span>📍 Endpoint:</span>
                                    <span id="tlm-endpoint">http://localhost:5050</span>
                                </div>
                                <div class="stat-row">
                                    <span>📝 Enrolled EAs:</span>
                                    <span id="tlm-ea-count">-</span>
                                </div>
                                <div class="stat-row">
                                    <span>🎫 Enrolled AAs:</span>
                                    <span id="tlm-aa-count">-</span>
                                </div>
                                <div class="stat-row">
                                    <span>📊 Trust List Version:</span>
                                    <span id="tlm-version">-</span>
                                </div>
                                <div class="stat-row">
                                    <span>🕐 Last Update:</span>
                                    <span id="tlm-last-update">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- RootCA Stats -->
                        <div class="instance-card rootca">
                            <h3>🏛️ Root CA</h3>
                            <div class="instance-label">Certificate Hierarchy</div>
                            <div class="instance-list">
                                <div class="stat-row">
                                    <span>📍 Endpoint:</span>
                                    <span id="rootca-endpoint">http://localhost:5999</span>
                                </div>
                                <div class="stat-row">
                                    <span>📜 Issued Certs:</span>
                                    <span id="rootca-issued-count">-</span>
                                </div>
                                <div class="stat-row">
                                    <span>🏢 Sub-CAs:</span>
                                    <span id="rootca-subca-count">-</span>
                                </div>
                                <div class="stat-row">
                                    <span>📊 Certificate Chain:</span>
                                    <span id="rootca-chain-depth">Root → EA/AA</span>
                                </div>
                                <div class="stat-row">
                                    <span>✅ Status:</span>
                                    <span id="rootca-status">Active</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Logs Panel -->
                <div class="panel full-width">
                    <h2>📋 System Logs</h2>
                    <div class="log-viewer" id="logViewer">
                        <div class="log-line info">[INFO] Dashboard initialized</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Endpoints View -->
        <div id="view-endpoints" class="view-section">
            <div class="panel" style="margin-top: 20px;">
                <h2>📡 API Endpoints</h2>
                <p style="color: #666; margin-bottom: 20px;">Complete list of REST API endpoints conforming to ETSI TS 102941</p>
                
                <div class="endpoint-list">
                    <div class="endpoint-item">
                        <span class="method POST">POST</span>
                        <span class="endpoint-path">/api/enrollment/request</span>
                        <span class="endpoint-entity">EA - ✅ ETSI Conforme (ASN.1 OER)</span>
                    </div>
                    <div class="endpoint-item">
                        <span class="method POST">POST</span>
                        <span class="endpoint-path">/api/enrollment/request/simple</span>
                        <span class="endpoint-entity">EA - ⚠️ Testing Only (JSON)</span>
                    </div>
                    <div class="endpoint-item">
                        <span class="method POST">POST</span>
                        <span class="endpoint-path">/api/enrollment/validation</span>
                        <span class="endpoint-entity">EA - 🔒 mTLS Required (AA→EA)</span>
                    </div>
                    <div class="endpoint-item">
                        <span class="method POST">POST</span>
                        <span class="endpoint-path">/api/authorization/request</span>
                        <span class="endpoint-entity">AA - Single AT Request</span>
                    </div>
                    <div class="endpoint-item">
                        <span class="method POST">POST</span>
                        <span class="endpoint-path">/api/authorization/request/butterfly</span>
                        <span class="endpoint-entity">AA - Batch 20 AT (Privacy)</span>
                    </div>
                    <div class="endpoint-item">
                        <span class="method GET">GET</span>
                        <span class="endpoint-path">/api/crl/full</span>
                        <span class="endpoint-entity">EA, AA - Full CRL</span>
                    </div>
                    <div class="endpoint-item">
                        <span class="method GET">GET</span>
                        <span class="endpoint-path">/api/crl/delta</span>
                        <span class="endpoint-entity">EA, AA - Delta CRL</span>
                    </div>
                    <div class="endpoint-item">
                        <span class="method GET">GET</span>
                        <span class="endpoint-path">/api/trust-list/full</span>
                        <span class="endpoint-entity">TLM - Full CTL</span>
                    </div>
                    <div class="endpoint-item">
                        <span class="method GET">GET</span>
                        <span class="endpoint-path">/api/trust-list/delta</span>
                        <span class="endpoint-entity">TLM - Delta CTL</span>
                    </div>
                    <div class="endpoint-item">
                        <span class="method GET">GET</span>
                        <span class="endpoint-path">/health</span>
                        <span class="endpoint-entity">All - Health Check</span>
                    </div>
                    <div class="endpoint-item">
                        <span class="method GET">GET</span>
                        <span class="endpoint-path">/api/docs</span>
                        <span class="endpoint-entity">All - Swagger UI</span>
                    </div>
                </div>

                <div style="background: #fef3c7; padding: 20px; border-radius: 8px; border-left: 4px solid #f59e0b; margin-top: 20px;">
                    <h3 style="color: #92400e; margin-bottom: 15px;">🔒 mTLS Authentication Info</h3>
                    <p style="color: #78350f; line-height: 1.6; margin-bottom: 10px;">
                        <strong>/api/enrollment/validation</strong> requires mutual TLS (mTLS) authentication with a valid client certificate.
                    </p>
                    <p style="color: #78350f; line-height: 1.6; font-size: 0.9em;">
                        This endpoint is used for inter-authority communication where an Authorization Authority (AA) requests 
                        validation of an Enrollment Certificate (EC) from an Enrollment Authority (EA). 
                        Only authorized AA entities with valid certificates can access this endpoint.
                    </p>
                </div>
            </div>
        </div>

        <!-- API Tester View -->
        <div id="view-api-tester" class="view-section">
            <div class="panel" style="margin-top: 20px;">
                <h2>🔧 API Tester - Test Individual Endpoints</h2>
                <p style="color: #666; margin-bottom: 20px;">Test PKI API endpoints interactively</p>
                
                <!-- Configuration Section -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">Configuration</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Base URL:</label>
                            <input type="text" id="apiBaseUrl" value="http://localhost:5000" 
                                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">API Key:</label>
                            <input type="text" id="apiKey" value="test-api-key-123" 
                                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                    </div>
                </div>

                <!-- API Categories -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
                    
                    <!-- Enrollment APIs -->
                    <div class="api-category-card">
                        <h3 style="color: #10b981; margin-bottom: 15px;">📝 Enrollment APIs</h3>
                        
                        <button class="api-test-btn" onclick="testEnrollmentRequest()">
                            POST /api/enrollment/request
                        </button>
                        <p style="font-size: 0.85em; color: #666; margin: 5px 0 15px 0;">
                            ⚠️ <strong>ETSI TS 102941 Compliant</strong> - Requires ASN.1 OER encoding<br>
                            Use Python scripts for testing
                        </p>

                        <button class="api-test-btn" onclick="testSimpleEnrollmentRequest()" 
                                style="background: linear-gradient(135deg, #10b981, #059669);">
                            🧪 POST /api/enrollment/request/simple
                        </button>
                        <p style="font-size: 0.85em; color: #666; margin: 5px 0 15px 0;">
                            <strong>✅ JSON API for Dashboard Testing</strong><br>
                            Generate EC with web form - copy/paste workflow
                        </p>

                        <button class="api-test-btn" onclick="testEnrollmentValidation()">
                            POST /api/enrollment/validation
                        </button>
                        <p style="font-size: 0.85em; color: #666; margin: 5px 0;">
                            ⚠️ <strong>ETSI TS 102941 Compliant</strong> - Requires mTLS and ASN.1 OER<br>
                            Use Python scripts for testing
                        </p>
                    </div>

                    <!-- Authorization APIs -->
                    <div class="api-category-card">
                        <h3 style="color: #3b82f6; margin-bottom: 15px;">🎫 Authorization APIs</h3>
                        
                        <button class="api-test-btn" onclick="testAuthorizationRequest()">
                            POST /api/authorization/request
                        </button>
                        <p style="font-size: 0.85em; color: #666; margin: 5px 0 15px 0;">
                            ⚠️ <strong>ETSI TS 102941 Compliant</strong> - Requires signed ASN.1 OER request<br>
                            Use Python scripts for testing
                        </p>

                        <button class="api-test-btn" onclick="testSimpleAuthorizationRequest()"
                                style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
                            🧪 POST /api/authorization/request/simple
                        </button>
                        <p style="font-size: 0.85em; color: #666; margin: 5px 0 15px 0;">
                            <strong>✅ JSON API for Dashboard Testing</strong><br>
                            Request AT using EC from enrollment step
                        </p>

                        <button class="api-test-btn" onclick="testButterflyRequest()">
                            POST /api/authorization/butterfly-request
                        </button>
                        <p style="font-size: 0.85em; color: #666; margin: 5px 0 15px 0;">
                            ⚠️ <strong>ETSI TS 102941 Compliant</strong> - Requires HMAC keys and ASN.1 OER<br>
                            Use Python scripts for testing
                        </p>

                        <button class="api-test-btn" onclick="testSimpleButterflyRequest()"
                                style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                            🧪 POST /api/authorization/butterfly-request/simple
                        </button>
                        <p style="font-size: 0.85em; color: #666; margin: 5px 0;">
                            <strong>✅ JSON API for Dashboard Testing</strong><br>
                            Request 20 ATs via Butterfly expansion
                        </p>
                    </div>

                    <!-- CRL APIs -->
                    <div class="api-category-card">
                        <h3 style="color: #8b5cf6; margin-bottom: 15px;">📋 CRL APIs</h3>
                        
                        <button class="api-test-btn" onclick="testGetFullCRL()">
                            GET /api/crl/full
                        </button>
                        <p style="font-size: 0.85em; color: #666; margin: 5px 0 15px 0;">
                            Download Full Certificate Revocation List
                        </p>

                        <button class="api-test-btn" onclick="testGetDeltaCRL()">
                            GET /api/crl/delta
                        </button>
                        <p style="font-size: 0.85em; color: #666; margin: 5px 0;">
                            Download Delta CRL
                        </p>
                    </div>

                    <!-- Trust List APIs -->
                    <div class="api-category-card">
                        <h3 style="color: #f59e0b; margin-bottom: 15px;">🔐 Trust List APIs</h3>
                        
                        <button class="api-test-btn" onclick="testGetFullCTL()">
                            GET /api/trust-list/full
                        </button>
                        <p style="font-size: 0.85em; color: #666; margin: 5px 0 15px 0;">
                            Download Full Certificate Trust List
                        </p>

                        <button class="api-test-btn" onclick="testGetDeltaCTL()">
                            GET /api/trust-list/delta
                        </button>
                        <p style="font-size: 0.85em; color: #666; margin: 5px 0;">
                            Download Delta CTL
                        </p>
                    </div>

                    <!-- System APIs -->
                    <div class="api-category-card">
                        <h3 style="color: #667eea; margin-bottom: 15px;">⚙️ System APIs</h3>
                        
                        <button class="api-test-btn" onclick="testHealthCheck()">
                            GET /health
                        </button>
                        <p style="font-size: 0.85em; color: #666; margin: 5px 0 15px 0;">
                            Check system health status
                        </p>

                        <button class="api-test-btn" onclick="testRootEndpoint()">
                            GET /
                        </button>
                        <p style="font-size: 0.85em; color: #666; margin: 5px 0;">
                            Get API information
                        </p>
                    </div>

                    <!-- Monitoring APIs -->
                    <div class="api-category-card">
                        <h3 style="color: #ef4444; margin-bottom: 15px;">📊 Monitoring APIs</h3>
                        
                        <button class="api-test-btn" onclick="testGetMetrics()">
                            GET /api/monitoring/metrics
                        </button>
                        <p style="font-size: 0.85em; color: #666; margin: 5px 0;">
                            Get real-time system metrics
                        </p>
                    </div>

                </div>

                <!-- Results Section -->
                <div style="margin-top: 30px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">Test Results</h3>
                    <div id="apiTestResults" class="log-viewer" style="min-height: 300px;">
                        <div style="color: #888;">Click a button above to test an API endpoint...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Coverage View -->
        <div id="view-test-coverage" class="view-section">
            <div class="panel" style="margin-top: 20px;">
                <h2>📊 Test Coverage</h2>
                <p style="color: #666; margin-bottom: 20px;">Comprehensive test suite with 115 passing tests</p>
                
                <div class="test-grid">
                    <div class="test-category">
                        <h4>
                            <span>🔐 PKI Entity Tests</span>
                            <span class="test-badge">25 tests</span>
                        </h4>
                        <div class="test-description">
                            <strong>Validates:</strong> Root CA initialization, EA/AA certificate issuance, entity lifecycle management, certificate chain validation, key pair generation.
                        </div>
                    </div>

                    <div class="test-category">
                        <h4>
                            <span>📡 REST API Tests</span>
                            <span class="test-badge">20 tests</span>
                        </h4>
                        <div class="test-description">
                            <strong>Validates:</strong> Endpoint responses, authentication (API Key, mTLS), rate limiting, CORS headers, content negotiation, error handling.
                        </div>
                    </div>

                    <div class="test-category">
                        <h4>
                            <span>🦋 Butterfly Key Expansion Tests</span>
                            <span class="test-badge">15 tests</span>
                        </h4>
                        <div class="test-description">
                            <strong>Validates:</strong> Batch AT generation (20 tickets), key derivation, unlinkability properties, HMAC-based expansion, privacy preservation.
                        </div>
                    </div>

                    <div class="test-category">
                        <h4>
                            <span>🔗 ETSI Link Certificate Tests</span>
                            <span class="test-badge">12 tests</span>
                        </h4>
                        <div class="test-description">
                            <strong>Validates:</strong> Link certificate creation, EA→RootCA linking, certificate verification, trust chain building, cross-certification.
                        </div>
                    </div>

                    <div class="test-category">
                        <h4>
                            <span>📋 CRL/CTL Manager Tests</span>
                            <span class="test-badge">18 tests</span>
                        </h4>
                        <div class="test-description">
                            <strong>Validates:</strong> CRL generation (Full/Delta), certificate revocation, CTL creation, trust list updates, delta list computation.
                        </div>
                    </div>

                    <div class="test-category">
                        <h4>
                            <span>🚗 ITS Station Tests</span>
                            <span class="test-badge">10 tests</span>
                        </h4>
                        <div class="test-description">
                            <strong>Validates:</strong> Vehicle enrollment, AT requests, certificate storage, V2X message signing, certificate renewal.
                        </div>
                    </div>

                    <div class="test-category">
                        <h4>
                            <span>📝 ETSI Protocol Compliance</span>
                            <span class="test-badge">15 tests</span>
                        </h4>
                        <div class="test-description">
                            <strong>Validates:</strong> ETSI TS 102941 compliance, ASN.1 OER encoding/decoding, message structure, response codes, IEEE 1609.2 compatibility.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Daily Scenarios View (NEW SEPARATE VIEW) -->
        <div id="view-daily-scenarios" class="view-section">
            <div class="panel" style="margin-top: 20px;">
                <h2>🎯 Scenari Quotidiani - Interactive PKI Tester</h2>
                <p style="color: #666; margin-bottom: 20px;">
                    Lo script <code style="background: #f3f4f6; padding: 2px 8px; border-radius: 4px;">interactive_pki_tester.py</code> 
                    simula scenari reali di utilizzo della PKI V2X
                </p>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    
                    <!-- Scenario 1 -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 15px 0; font-size: 1.3em;">✈️ Test 1: Enrollment Singolo</h3>
                        <p style="margin: 0 0 10px 0; opacity: 0.9; line-height: 1.6;">
                            Simula l'enrollment di un nuovo veicolo nella PKI:
                        </p>
                        <ul style="margin: 0; padding-left: 20px; opacity: 0.9; line-height: 1.8;">
                            <li>Genera coppia di chiavi EC P-256</li>
                            <li>POST /api/enrollment/request all'EA</li>
                            <li>Riceve e valida l'Enrollment Certificate</li>
                            <li>Verifica firma digitale del certificato</li>
                            <li>Salva EC in memoria per test successivi</li>
                        </ul>
                        <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 6px; font-size: 0.9em;">
                            <strong>Output:</strong> Enrollment Certificate (PEM) valido per 365 giorni
                        </div>
                    </div>

                    <!-- Scenario 2 -->
                    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 12px; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 15px 0; font-size: 1.3em;">🎫 Test 2: Authorization Ticket</h3>
                        <p style="margin: 0 0 10px 0; opacity: 0.9; line-height: 1.6;">
                            Richiesta di Authorization Ticket usando l'EC del Test 1:
                        </p>
                        <ul style="margin: 0; padding-left: 20px; opacity: 0.9; line-height: 1.8;">
                            <li>Usa EC ottenuto dal Test 1</li>
                            <li>Genera nuova chiave per AT</li>
                            <li>POST /api/authorization/request all'AA</li>
                            <li>Riceve Authorization Ticket</li>
                            <li>Valida permissions (CAM, DENM)</li>
                        </ul>
                        <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 6px; font-size: 0.9em;">
                            <strong>Output:</strong> Authorization Ticket valido per 7 giorni con HMAC key
                        </div>
                    </div>

                    <!-- Scenario 3 -->
                    <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 20px; border-radius: 12px; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 15px 0; font-size: 1.3em;">🚗 Test 3: Flotta Veicoli</h3>
                        <p style="margin: 0 0 10px 0; opacity: 0.9; line-height: 1.6;">
                            Enrollment simultaneo di 5 veicoli (stress test):
                        </p>
                        <ul style="margin: 0; padding-left: 20px; opacity: 0.9; line-height: 1.8;">
                            <li>Loop su 5 veicoli (VEHICLE_001 → VEHICLE_005)</li>
                            <li>Enrollment parallelo all'EA</li>
                            <li>Verifica che tutti ricevano EC validi</li>
                            <li>Test di scalabilità del sistema</li>
                            <li>Misura tempo di risposta medio</li>
                        </ul>
                        <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 6px; font-size: 0.9em;">
                            <strong>Output:</strong> 5 EC validi + statistiche performance
                        </div>
                    </div>

                    <!-- Scenario 4 -->
                    <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 20px; border-radius: 12px; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 15px 0; font-size: 1.3em;">📡 Test 4: Comunicazione V2V</h3>
                        <p style="margin: 0 0 10px 0; opacity: 0.9; line-height: 1.6;">
                            Simula scambio di messaggi tra 2 veicoli:
                        </p>
                        <ul style="margin: 0; padding-left: 20px; opacity: 0.9; line-height: 1.8;">
                            <li>Enrollment di VEHICLE_A e VEHICLE_B</li>
                            <li>Richiesta AT per entrambi</li>
                            <li>VEHICLE_A firma messaggio CAM</li>
                            <li>VEHICLE_B verifica la firma</li>
                            <li>Test di trust chain completa</li>
                        </ul>
                        <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 6px; font-size: 0.9em;">
                            <strong>Output:</strong> Messaggio V2X firmato e verificato ✅
                        </div>
                    </div>

                    <!-- Scenario 5 -->
                    <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); padding: 20px; border-radius: 12px; color: #333; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 15px 0; font-size: 1.3em;">✔️ Test 5: Validazione Certificati</h3>
                        <p style="margin: 0 0 10px 0; opacity: 0.9; line-height: 1.6;">
                            Verifica la validità dei certificati ottenuti:
                        </p>
                        <ul style="margin: 0; padding-left: 20px; opacity: 0.9; line-height: 1.8;">
                            <li>Check scadenza certificati</li>
                            <li>Verifica firma digitale con Root CA</li>
                            <li>Controllo trust chain (AT → EC → EA → Root CA)</li>
                            <li>Verifica che non siano revocati (CRL check)</li>
                            <li>Validazione campi ETSI obbligatori</li>
                        </ul>
                        <div style="margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.1); border-radius: 6px; font-size: 0.9em;">
                            <strong>Output:</strong> Report validazione completo
                        </div>
                    </div>

                    <!-- Scenario 6 -->
                    <div style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); padding: 20px; border-radius: 12px; color: #333; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 15px 0; font-size: 1.3em;">⚡ Test 6: Performance Test</h3>
                        <p style="margin: 0 0 10px 0; opacity: 0.9; line-height: 1.6;">
                            Test di carico su 10 enrollment simultanei:
                        </p>
                        <ul style="margin: 0; padding-left: 20px; opacity: 0.9; line-height: 1.8;">
                            <li>10 richieste di enrollment concorrenti</li>
                            <li>Misura tempo di risposta (min/max/avg)</li>
                            <li>Verifica tasso di successo</li>
                            <li>Test di rate limiting</li>
                            <li>Analisi throughput del sistema</li>
                        </ul>
                        <div style="margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.1); border-radius: 6px; font-size: 0.9em;">
                            <strong>Output:</strong> Statistiche performance dettagliate
                        </div>
                    </div>

                </div>

                <!-- Command Section -->
                <div style="background: #1e293b; color: #e2e8f0; padding: 25px; border-radius: 12px; margin-top: 30px;">
                    <h3 style="color: #60a5fa; margin-top: 0;">💻 Come Eseguire i Test</h3>
                    
                    <div style="margin-bottom: 20px;">
                        <p style="margin: 0 0 10px 0; opacity: 0.9;">
                            <strong style="color: #fbbf24;">1. Menu Interattivo (Raccomandato):</strong>
                        </p>
                        <pre style="background: #0f172a; padding: 15px; border-radius: 8px; overflow-x: auto; border: 1px solid #334155; margin: 0;">python examples/interactive_pki_tester.py</pre>
                        <p style="margin: 10px 0 0 0; opacity: 0.7; font-size: 0.9em;">
                            • Mostra menu con tutti i 6 test<br>
                            • Scegli test singolo o esegui tutti<br>
                            • Avvia automaticamente le entities PKI se non attive
                        </p>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <p style="margin: 0 0 10px 0; opacity: 0.9;">
                            <strong style="color: #fbbf24;">2. Esecuzione Automatica Completa:</strong>
                        </p>
                        <pre style="background: #0f172a; padding: 15px; border-radius: 8px; overflow-x: auto; border: 1px solid #334155; margin: 0;">python examples/interactive_pki_tester.py --auto</pre>
                        <p style="margin: 10px 0 0 0; opacity: 0.7; font-size: 0.9em;">
                            • Esegue tutti i 6 test in sequenza<br>
                            • Report finale con statistiche<br>
                            • Ideale per CI/CD e regression testing
                        </p>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <p style="margin: 0 0 10px 0; opacity: 0.9;">
                            <strong style="color: #fbbf24;">3. Con Entities Già Attive:</strong>
                        </p>
                        <pre style="background: #0f172a; padding: 15px; border-radius: 8px; overflow-x: auto; border: 1px solid #334155; margin: 0;">python examples/interactive_pki_tester.py --no-start</pre>
                        <p style="margin: 10px 0 0 0; opacity: 0.7; font-size: 0.9em;">
                            • Usa entities PKI già avviate (da start_all_entities.ps1)<br>
                            • Più veloce per test ripetuti<br>
                            • Non avvia nuovi processi Python
                        </p>
                    </div>

                    <div>
                        <p style="margin: 0 0 10px 0; opacity: 0.9;">
                            <strong style="color: #fbbf24;">4. Configurazione Custom:</strong>
                        </p>
                        <pre style="background: #0f172a; padding: 15px; border-radius: 8px; overflow-x: auto; border: 1px solid #334155; margin: 0;">python examples/interactive_pki_tester.py --ea-url http://localhost:5000 --aa-url http://localhost:5020</pre>
                        <p style="margin: 10px 0 0 0; opacity: 0.7; font-size: 0.9em;">
                            • Specifica URL custom per EA e AA<br>
                            • Utile per test su deployment remoti
                        </p>
                    </div>
                </div>

                <!-- Expected Output Section -->
                <div style="background: #f0fdf4; border: 2px solid #86efac; padding: 25px; border-radius: 12px; margin-top: 30px;">
                    <h3 style="color: #16a34a; margin-top: 0;">✅ Output Atteso</h3>
                    <p style="color: #166534; margin-bottom: 15px; line-height: 1.6;">
                        Quando esegui <code>interactive_pki_tester.py</code>, dovresti vedere:
                    </p>
                    <ul style="color: #166534; line-height: 1.8; margin: 0;">
                        <li><strong>Avvio entities:</strong> Tutte le entities (EA, AA, TLM) si avviano correttamente</li>
                        <li><strong>Menu interattivo:</strong> Lista dei 6 test con numerazione 1-6</li>
                        <li><strong>Test esecuzione:</strong> Ogni test mostra progress real-time con emoji e colori</li>
                        <li><strong>Risultati:</strong> ✅ PASS o ❌ FAIL per ogni test</li>
                        <li><strong>Statistiche:</strong> Numero veicoli enrollati, test eseguiti, tempo di risposta</li>
                        <li><strong>Report finale:</strong> Riepilogo con successi/fallimenti totali</li>
                    </ul>
                </div>

            </div>
        </div>

        <!-- Real-Time Metrics View -->
        <div id="view-metrics" class="view-section">
            <div class="panel" style="margin-top: 20px;">
                <h2>📈 Real-Time Metrics</h2>
                <p style="color: #666; margin-bottom: 20px;">Live performance and operational metrics</p>
                
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="label">Certificates Issued</div>
                        <div class="value" id="metric-certs">0</div>
                    </div>
                    <div class="metric-card">
                        <div class="label">Active Certificates</div>
                        <div class="value" id="metric-active-certs">0</div>
                    </div>
                    <div class="metric-card">
                        <div class="label">Revoked Certificates</div>
                        <div class="value" id="metric-revoked">0</div>
                    </div>
                    <div class="metric-card">
                        <div class="label">API Requests/min</div>
                        <div class="value" id="metric-requests">0</div>
                    </div>
                    <div class="metric-card">
                        <div class="label">Avg Response Time</div>
                        <div class="value" id="metric-response-time">0ms</div>
                    </div>
                    <div class="metric-card">
                        <div class="label">System Uptime</div>
                        <div class="value" id="metric-uptime">0s</div>
                    </div>
                </div>

                <div style="margin-top: 30px; padding: 20px; background: #f9fafb; border-radius: 8px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">📊 Metrics Collection</h3>
                    <p style="color: #666; line-height: 1.6;">
                        Real-time metrics are collected from all active PKI entities. Data is aggregated every 5 seconds and displayed here.
                        For detailed metrics analysis, use the Prometheus endpoint: <code style="background: white; padding: 2px 8px; border-radius: 4px; color: #667eea;">/api/monitoring/metrics/prometheus</code>
                    </p>
                </div>
            </div>
        </div>

        <!-- Implemented Features View -->
        <div id="view-features" class="view-section">
            <div class="panel" style="margin-top: 20px;">
                <h2>✨ Implemented Features</h2>
                <p style="color: #666; margin-bottom: 20px;">Production-ready PKI implementation with ~90% completion</p>
                
                <div class="feature-grid">
                    <div class="feature-card">
                        <div class="icon">📜</div>
                        <h4>ETSI TS 102941 Compliance</h4>
                        <p>Full implementation of ETSI security management standards for V2X communications</p>
                        <div class="check">✓</div>
                    </div>

                    <div class="feature-card">
                        <div class="icon">🔐</div>
                        <h4>Certificate Management</h4>
                        <p>Complete lifecycle: enrollment, authorization, revocation, renewal with CRL/CTL support</p>
                        <div class="check">✓</div>
                    </div>

                    <div class="feature-card">
                        <div class="icon">🦋</div>
                        <h4>Butterfly Key Expansion</h4>
                        <p>Privacy-preserving batch generation of 20 Authorization Tickets with unlinkability</p>
                        <div class="check">✓</div>
                    </div>

                    <div class="feature-card">
                        <div class="icon">📡</div>
                        <h4>REST API (11 Endpoints)</h4>
                        <p>Production-ready APIs with authentication, rate limiting, CORS, and OpenAPI docs</p>
                        <div class="check">✓</div>
                    </div>

                    <div class="feature-card">
                        <div class="icon">🔗</div>
                        <h4>Link Certificates</h4>
                        <p>Trust chain building with link certificates between EA and Root CA</p>
                        <div class="check">✓</div>
                    </div>

                    <div class="feature-card">
                        <div class="icon">📋</div>
                        <h4>CRL/CTL Distribution</h4>
                        <p>Full and Delta CRLs, Certificate Trust Lists with automatic updates</p>
                        <div class="check">✓</div>
                    </div>

                    <div class="feature-card">
                        <div class="icon">🔒</div>
                        <h4>mTLS Authentication</h4>
                        <p>Mutual TLS for secure inter-authority communication (EA ↔ AA)</p>
                        <div class="check">✓</div>
                    </div>

                    <div class="feature-card">
                        <div class="icon">🧪</div>
                        <h4>Comprehensive Testing</h4>
                        <p>115 automated tests covering all major functionality and edge cases</p>
                        <div class="check">✓</div>
                    </div>

                    <div class="feature-card">
                        <div class="icon">⚡</div>
                        <h4>Auto-Setup System</h4>
                        <p>Automated PKI initialization with configurable entities and ports</p>
                        <div class="check">✓</div>
                    </div>

                    <div class="feature-card">
                        <div class="icon">📊</div>
                        <h4>Monitoring & Metrics</h4>
                        <p>Real-time metrics, logging, and Prometheus integration</p>
                        <div class="check">✓</div>
                    </div>

                    <div class="feature-card">
                        <div class="icon">🎯</div>
                        <h4>Rate Limiting</h4>
                        <p>Configurable rate limits per endpoint to prevent abuse</p>
                        <div class="check">✓</div>
                    </div>

                    <div class="feature-card">
                        <div class="icon">📝</div>
                        <h4>ASN.1 OER Encoding</h4>
                        <p>Binary encoding/decoding for ETSI message structures</p>
                        <div class="check">✓</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Results View -->
        <div id="view-test-results" class="view-section">
            <div class="panel" style="margin-top: 20px;">
                <h2>🧪 Test Results</h2>
                <p style="color: #666; margin-bottom: 20px;">Latest test execution results from the test suite</p>
                
                <div style="background: #dcfce7; padding: 20px; border-radius: 8px; border-left: 4px solid #10b981; margin-bottom: 20px;">
                    <h3 style="color: #065f46; margin-bottom: 15px;">📊 Test Suite Summary</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="text-align: center;">
                            <div style="font-size: 2em; font-weight: bold; color: #10b981;">115</div>
                            <div style="color: #047857; font-size: 0.9em;">Total Tests</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2em; font-weight: bold; color: #10b981;">115</div>
                            <div style="color: #047857; font-size: 0.9em;">Passed</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2em; font-weight: bold; color: #6b7280;">0</div>
                            <div style="color: #4b5563; font-size: 0.9em;">Failed</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2em; font-weight: bold; color: #10b981;">100%</div>
                            <div style="color: #047857; font-size: 0.9em;">Success Rate</div>
                        </div>
                    </div>
                </div>

                <div style="background: #f9fafb; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="color: #333; margin-bottom: 15px;">🎯 How to Run Tests</h3>
                    <p style="color: #666; margin-bottom: 15px; line-height: 1.6;">
                        To execute the full test suite and see detailed results, run the following command in your terminal:
                    </p>
                    <div style="background: #1f2937; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <code style="color: #10b981; display: block; font-family: 'Courier New', monospace;">python tests/run_all_tests.py</code>
                    </div>
                    <p style="color: #666; font-size: 0.9em; line-height: 1.6;">
                        Test results are automatically saved in the <code style="background: #e5e7eb; padding: 2px 6px; border-radius: 4px;">test_results/</code> directory with detailed logs and assertions.
                    </p>
                </div>

                <div class="test-grid">
                    <div class="test-category">
                        <h4>
                            <span>✅ PKI Entity Tests (25 tests)</span>
                            <span class="test-badge">PASSED</span>
                        </h4>
                        <div class="test-description">
                            Tests root CA, EA, AA initialization and certificate issuance workflows
                        </div>
                    </div>

                    <div class="test-category">
                        <h4>
                            <span>✅ REST API Tests (20 tests)</span>
                            <span class="test-badge">PASSED</span>
                        </h4>
                        <div class="test-description">
                            Validates all 11 endpoints, authentication, rate limiting, and error handling
                        </div>
                    </div>

                    <div class="test-category">
                        <h4>
                            <span>✅ Butterfly Key Expansion (15 tests)</span>
                            <span class="test-badge">PASSED</span>
                        </h4>
                        <div class="test-description">
                            Tests batch AT generation, unlinkability, and privacy preservation
                        </div>
                    </div>

                    <div class="test-category">
                        <h4>
                            <span>✅ ETSI Protocol Compliance (15 tests)</span>
                            <span class="test-badge">PASSED</span>
                        </h4>
                        <div class="test-description">
                            Verifies ASN.1 OER encoding/decoding and ETSI TS 102941 conformance
                        </div>
                    </div>

                    <div class="test-category">
                        <h4>
                            <span>✅ CRL/CTL Management (18 tests)</span>
                            <span class="test-badge">PASSED</span>
                        </h4>
                        <div class="test-description">
                            Tests certificate revocation lists and trust list distribution
                        </div>
                    </div>

                    <div class="test-category">
                        <h4>
                            <span>✅ Link Certificates (12 tests)</span>
                            <span class="test-badge">PASSED</span>
                        </h4>
                        <div class="test-description">
                            Validates EA-RootCA linking and trust chain verification
                        </div>
                    </div>

                    <div class="test-category">
                        <h4>
                            <span>✅ ITS Station Tests (10 tests)</span>
                            <span class="test-badge">PASSED</span>
                        </h4>
                        <div class="test-description">
                            Tests vehicle enrollment, AT requests, and V2X message signing
                        </div>
                    </div>
                </div>

                <div style="background: #eff6ff; padding: 20px; border-radius: 8px; border-left: 4px solid #3b82f6; margin-top: 20px;">
                    <h3 style="color: #1e40af; margin-bottom: 10px;">📝 Test Reports</h3>
                    <p style="color: #1e3a8a; font-size: 0.9em; line-height: 1.6;">
                        Detailed test reports with timestamps, assertions, and failure analysis are available in:
                        <code style="background: white; padding: 2px 8px; border-radius: 4px; color: #3b82f6; display: inline-block; margin-top: 5px;">test_results/test_report_YYYYMMDD_HHMMSS.json</code>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Entity port configuration
        const ENTITY_PORTS = {
            'EA': Array.from({length: 20}, (_, i) => 5000 + i),
            'AA': Array.from({length: 20}, (_, i) => 5020 + i),
            'TLM': [5050],
            'RootCA': [5999]
        };

        // Track active instances
        let activeInstances = {
            'EA': [],
            'AA': [],
            'TLM': [],
            'RootCA': []
        };

        // System state
        let systemActive = false;
        let scanInterval = null;
        let metricsInterval = null;
        let entityStatsRefreshInterval = null; // For auto-refresh in modal
        let currentEntityStats = null; // Store current entity data for refresh

        // Initialize on load
        window.onload = function() {
            addLog('✅ Dashboard initialized successfully', 'info');
            scanAllInstances();
            updateMetrics();
            
            // Auto-refresh every 5 seconds
            scanInterval = setInterval(scanAllInstances, 5000);
            metricsInterval = setInterval(updateMetrics, 10000);
        };

        // View Management
        function showView(viewName) {
            // Hide all views
            document.querySelectorAll('.view-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected view
            document.getElementById(`view-${viewName}`).classList.add('active');
            
            // Update nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');
            
            addLog(`📄 Switched to ${viewName} view`, 'info');
        }

        // Scan all instances
        async function scanAllInstances() {
            addLog('🔍 Scanning for active instances...', 'info');
            
            const scanPromises = [];
            
            for (const entityType of Object.keys(ENTITY_PORTS)) {
                const ports = ENTITY_PORTS[entityType];
                
                const entityScanPromise = Promise.all(
                    ports.map(async (port) => {
                        const baseUrl = `http://localhost:${port}`;
                        const isActive = await checkInstanceHealth(baseUrl);
                        
                        if (isActive) {
                            const entityInfo = await getEntityInfo(baseUrl);
                            return {
                                port: port,
                                url: baseUrl,
                                id: entityInfo.id || `${entityType}_${port}`,
                                uptime: entityInfo.uptime || 'N/A'
                            };
                        }
                        return null;
                    })
                ).then(results => ({
                    entityType,
                    activeList: results.filter(r => r !== null)
                }));
                
                scanPromises.push(entityScanPromise);
            }
            
            const allResults = await Promise.all(scanPromises);
            
            // Update displays
            for (const {entityType, activeList} of allResults) {
                activeInstances[entityType] = activeList;
                updateInstanceDisplay(entityType, activeList);
            }
            
            // Update total count and system status
            const totalActive = Object.values(activeInstances).reduce((sum, list) => sum + list.length, 0);
            document.getElementById('activeInstancesTotal').textContent = totalActive;
            
            // Update system status
            const systemStatusEl = document.getElementById('systemStatus');
            const systemStatusCard = document.getElementById('systemStatusCard');
            if (totalActive > 0) {
                systemStatusEl.textContent = 'Active';
                systemStatusCard.className = 'status-card success';
                systemActive = true;
            } else {
                systemStatusEl.textContent = 'Inactive';
                systemStatusCard.className = 'status-card error';
                systemActive = false;
            }
            
            // Update last scan time
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            document.getElementById('lastScanTime').textContent = timeStr;
            
            addLog(`✅ Scan complete: ${totalActive} active instances found`, 'info');
        }

        // Check instance health
        async function checkInstanceHealth(baseUrl) {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 2000);
                
                const response = await fetch(`${baseUrl}/health`, {
                    method: 'GET',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                return response.ok;
            } catch (error) {
                return false;
            }
        }

        // Get entity information
        async function getEntityInfo(baseUrl) {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 2000);
                
                const response = await fetch(`${baseUrl}/health`, {
                    method: 'GET',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const data = await response.json();
                    return {
                        id: data.entity_id || data.id || null,
                        uptime: data.uptime || null
                    };
                }
            } catch (error) {
                // Silent fail
            }
            return {};
        }

        // Update instance display
        function updateInstanceDisplay(entityType, instances) {
            const countEl = document.getElementById(`instanceCount-${entityType}`);
            const listEl = document.getElementById(`instanceList-${entityType}`);
            
            if (!countEl || !listEl) return;
            
            countEl.textContent = instances.length;
            
            if (instances.length === 0) {
                listEl.innerHTML = '<div class="instance-item" style="opacity: 0.7;">No active instances</div>';
            } else {
                listEl.innerHTML = instances.map(inst => `
                    <div class="instance-item" onclick="showEntityStats('${entityType}', '${inst.id}', ${inst.port})">
                        <div>
                            <div style="font-weight: bold;">${inst.id}</div>
                            <div style="font-size: 0.85em; opacity: 0.8;">Port ${inst.port}</div>
                        </div>
                        <div style="text-align: right; font-size: 0.85em;">
                            ${inst.uptime || 'N/A'}
                        </div>
                    </div>
                `).join('');
            }
        }
        
        // Show Entity Statistics Modal
        async function showEntityStats(entityType, entityId, port) {
            const modal = document.getElementById('entityStatsModal');
            const title = document.getElementById('statsEntityTitle');
            const subtitle = document.getElementById('statsEntitySubtitle');
            
            // Store current entity for refresh
            currentEntityStats = { entityType, entityId, port };
            
            // Set title based on entity type
            const typeNames = {
                'EA': '📝 Enrollment Authority',
                'AA': '🎫 Authorization Authority',
                'ITSS': '🚗 ITS Station',
                'TLM': '📋 Trust List Manager'
            };
            
            title.textContent = `${typeNames[entityType] || entityType} Statistics`;
            
            // Show modal
            modal.style.display = 'block';
            
            // Load initial data
            await loadEntityStats(entityType, entityId, port);
            
            // Setup auto-refresh every 3 seconds
            if (entityStatsRefreshInterval) {
                clearInterval(entityStatsRefreshInterval);
            }
            entityStatsRefreshInterval = setInterval(async () => {
                if (modal.style.display === 'block') {
                    await loadEntityStats(entityType, entityId, port);
                }
            }, 3000);
        }
        
        // Load Entity Statistics (separated for refresh)
        async function loadEntityStats(entityType, entityId, port) {
            console.log(`🔄 Refreshing stats for ${entityId} at ${new Date().toLocaleTimeString('it-IT')}`);
            
            const subtitle = document.getElementById('statsEntitySubtitle');
            const indicator = document.getElementById('statsRefreshIndicator');
            
            // Show loading indicator
            if (indicator) indicator.style.display = 'inline-block';
            
            // Fetch stats from entity
            try {
                const response = await fetch(`http://localhost:${port}/api/monitoring/metrics`);
                const data = await response.json();
                
                console.log('✅ Entity metrics received:', data);
                
                // Hide loading indicator and update timestamp
                if (indicator) indicator.style.display = 'none';
                const now = new Date();
                const timeStr = now.toLocaleTimeString('it-IT');
                subtitle.innerHTML = `${entityId} - Port ${port} | 🔄 Last update: <strong>${timeStr}</strong>`;
                
                // Add flash animation to stat boxes
                document.querySelectorAll('.stat-box').forEach(box => {
                    box.classList.remove('updating');
                    void box.offsetWidth; // Trigger reflow
                    box.classList.add('updating');
                });
                
                // Update statistics (using data.overall from monitoring_bp.py)
                const overall = data.overall || {};
                const counters = data.counters || {};
                
                document.getElementById('stat-total-requests').textContent = overall.total_requests || 0;
                document.getElementById('stat-success-rate').textContent = 
                    overall.error_rate_percent !== undefined 
                        ? `${(100 - overall.error_rate_percent).toFixed(1)}%` 
                        : 'N/A';
                document.getElementById('stat-response-time').textContent = 
                    overall.avg_latency_ms 
                        ? `${overall.avg_latency_ms.toFixed(0)}ms` 
                        : 'N/A';
                document.getElementById('stat-active-certs').textContent = 
                    (counters.active_certificates !== undefined) ? counters.active_certificates : 0;
                
                // Health checks (always shown)
                document.getElementById('stat-health-checks').textContent = 
                    (counters.health_checks !== undefined) ? counters.health_checks : 0;
                
                // Show/hide and update EC/AT counters based on entity type
                const ecBox = document.getElementById('stat-box-ec-issued');
                const atBox = document.getElementById('stat-box-at-issued');
                
                if (entityType === 'EA') {
                    // Show EC counter for Enrollment Authorities
                    ecBox.style.display = 'block';
                    atBox.style.display = 'none';
                    document.getElementById('stat-ec-issued').textContent = 
                        (counters.enrollment_certificates_issued !== undefined) ? counters.enrollment_certificates_issued : 0;
                } else if (entityType === 'AA') {
                    // Show AT counter for Authorization Authorities
                    ecBox.style.display = 'none';
                    atBox.style.display = 'block';
                    document.getElementById('stat-at-issued').textContent = 
                        (counters.authorization_tickets_issued !== undefined) ? counters.authorization_tickets_issued : 0;
                } else {
                    // Hide both for other entity types
                    ecBox.style.display = 'none';
                    atBox.style.display = 'none';
                }
                
                // Update endpoints table
                const endpointsTable = document.getElementById('stats-endpoints-table');
                if (data.endpoints && Object.keys(data.endpoints).length > 0) {
                    endpointsTable.innerHTML = Object.entries(data.endpoints).map(([endpoint, stats]) => `
                        <tr>
                            <td><code>${endpoint}</code></td>
                            <td>${stats.count || 0}</td>
                            <td style="color: #10b981;">${stats.success_count || 0}</td>
                            <td style="color: #ef4444;">${stats.error_count || 0}</td>
                            <td>${stats.avg_latency_ms ? stats.avg_latency_ms.toFixed(0) + 'ms' : 'N/A'}</td>
                        </tr>
                    `).join('');
                } else {
                    endpointsTable.innerHTML = '<tr><td colspan="5" style="text-align: center; opacity: 0.7;">No endpoint data available yet</td></tr>';
                }
                
                // Update recent activity (note: actual endpoint doesn't return recent_requests, we'll use last_5_minutes data)
                const activityDiv = document.getElementById('stats-recent-activity');
                const last5min = data.last_5_minutes || {};
                activityDiv.innerHTML = `
                    <div style="padding: 15px; background: rgba(255,255,255,0.1); border-radius: 5px;">
                        <h4 style="margin-top: 0;">Last 5 Minutes Activity</h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div>
                                <div style="font-size: 1.5em; font-weight: bold;">${last5min.total_requests || 0}</div>
                                <div style="opacity: 0.8;">Requests</div>
                            </div>
                            <div>
                                <div style="font-size: 1.5em; font-weight: bold;">${last5min.error_rate_percent ? last5min.error_rate_percent.toFixed(1) + '%' : 'N/A'}</div>
                                <div style="opacity: 0.8;">Error Rate</div>
                            </div>
                            <div>
                                <div style="font-size: 1.5em; font-weight: bold;">${last5min.avg_latency_ms ? last5min.avg_latency_ms.toFixed(0) + 'ms' : 'N/A'}</div>
                                <div style="opacity: 0.8;">Avg Latency</div>
                            </div>
                            <div>
                                <div style="font-size: 1.5em; font-weight: bold;">${last5min.requests_per_second ? last5min.requests_per_second.toFixed(2) : 'N/A'}</div>
                                <div style="opacity: 0.8;">Req/sec</div>
                            </div>
                        </div>
                        ${data.status_codes && Object.keys(data.status_codes).length > 0 ? `
                            <div style="margin-top: 15px;">
                                <h4>Status Codes Distribution</h4>
                                ${Object.entries(data.status_codes).map(([code, count]) => `
                                    <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                        <span style="color: ${code < 400 ? '#10b981' : '#ef4444'};">HTTP ${code}</span>
                                        <span>${count} requests</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
                
                // Format uptime
                const uptimeSeconds = data.uptime_seconds || 0;
                const hours = Math.floor(uptimeSeconds / 3600);
                const minutes = Math.floor((uptimeSeconds % 3600) / 60);
                const seconds = Math.floor(uptimeSeconds % 60);
                const uptimeStr = `${hours}h ${minutes}m ${seconds}s`;
                
                console.log(`⏱️ Uptime: ${uptimeSeconds}s = ${uptimeStr}`);
                
                // Update entity info
                const infoTable = document.getElementById('stats-entity-info');
                infoTable.innerHTML = `
                    <tr><td><strong>Entity ID</strong></td><td>${entityId}</td></tr>
                    <tr><td><strong>Entity Type</strong></td><td>${entityType}</td></tr>
                    <tr><td><strong>Port</strong></td><td>${port}</td></tr>
                    <tr><td><strong>Status</strong></td><td><span style="color: #10b981;">●</span> ${data.status || 'Online'}</td></tr>
                    <tr><td><strong>Uptime</strong></td><td>${uptimeStr}</td></tr>
                    <tr><td><strong>Total Requests</strong></td><td>${overall.total_requests || 0}</td></tr>
                    <tr><td><strong>Success Rate</strong></td><td>${overall.error_rate_percent !== undefined ? (100 - overall.error_rate_percent).toFixed(1) + '%' : 'N/A'}</td></tr>
                    <tr><td><strong>Min/Max Latency</strong></td><td>${overall.min_latency_ms ? overall.min_latency_ms.toFixed(0) : 'N/A'}ms / ${overall.max_latency_ms ? overall.max_latency_ms.toFixed(0) : 'N/A'}ms</td></tr>
                    <tr><td><strong>Req/sec</strong></td><td>${overall.requests_per_second ? overall.requests_per_second.toFixed(2) : 'N/A'}</td></tr>
                `;
                
            } catch (error) {
                console.error('Failed to fetch entity stats:', error);
                
                // Hide loading indicator
                const indicator = document.getElementById('statsRefreshIndicator');
                if (indicator) indicator.style.display = 'none';
                
                // Update subtitle with error
                const subtitle = document.getElementById('statsEntitySubtitle');
                const now = new Date();
                const timeStr = now.toLocaleTimeString('it-IT');
                subtitle.innerHTML = `${entityId} - Port ${port} | ❌ Last update: <strong>${timeStr}</strong> (Error)`;
                
                // Show error message
                document.getElementById('stat-total-requests').textContent = 'Error';
                document.getElementById('stat-success-rate').textContent = 'N/A';
                document.getElementById('stat-response-time').textContent = 'N/A';
                document.getElementById('stat-active-certs').textContent = 'N/A';
                document.getElementById('stat-health-checks').textContent = 'N/A';
                document.getElementById('stat-ec-issued').textContent = 'N/A';
                document.getElementById('stat-at-issued').textContent = 'N/A';
                
                document.getElementById('stats-endpoints-table').innerHTML = 
                    '<tr><td colspan="5" style="text-align: center; color: #ef4444;">Failed to load statistics</td></tr>';
                
                document.getElementById('stats-recent-activity').innerHTML = 
                    '<div style="opacity: 0.7; text-align: center; padding: 20px; color: #ef4444;">Failed to load activity data</div>';
                
                document.getElementById('stats-entity-info').innerHTML = `
                    <tr><td><strong>Entity ID</strong></td><td>${entityId}</td></tr>
                    <tr><td><strong>Entity Type</strong></td><td>${entityType}</td></tr>
                    <tr><td><strong>Port</strong></td><td>${port}</td></tr>
                    <tr><td><strong>Status</strong></td><td><span style="color: #ef4444;">●</span> Connection Failed</td></tr>
                `;
            }
        }
        
        // Close Entity Statistics Modal
        function closeEntityStats() {
            const modal = document.getElementById('entityStatsModal');
            modal.style.display = 'none';
            
            // Stop auto-refresh
            if (entityStatsRefreshInterval) {
                clearInterval(entityStatsRefreshInterval);
                entityStatsRefreshInterval = null;
            }
            currentEntityStats = null;
        }
        
        // Close modal on outside click
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('entityStatsModal');
            if (event.target === modal) {
                closeEntityStats();
            }
        });

        // Update metrics
        function updateMetrics() {
            if (!systemActive) return;
            
            // Simulate metrics (in real implementation, fetch from monitoring API)
            document.getElementById('metric-certs').textContent = Math.floor(Math.random() * 100);
            document.getElementById('metric-active-certs').textContent = Math.floor(Math.random() * 80);
            document.getElementById('metric-revoked').textContent = Math.floor(Math.random() * 10);
            document.getElementById('metric-requests').textContent = Math.floor(Math.random() * 50);
            document.getElementById('metric-response-time').textContent = Math.floor(Math.random() * 100) + 'ms';
            
            // Calculate uptime
            const uptime = Math.floor((Date.now() / 1000) % 86400);
            const hours = Math.floor(uptime / 3600);
            const minutes = Math.floor((uptime % 3600) / 60);
            document.getElementById('metric-uptime').textContent = `${hours}h ${minutes}m`;
        }

        // Add log entry
        function addLog(message, type = 'info') {
            const logViewer = document.getElementById('logViewer');
            const timestamp = new Date().toLocaleTimeString();
            const typeUpper = type.toUpperCase();
            const logLine = document.createElement('div');
            logLine.className = `log-line ${type}`;
            logLine.textContent = `[${timestamp}] [${typeUpper}] ${message}`;
            logViewer.appendChild(logLine);
            
            // Keep only last 50 lines
            while (logViewer.children.length > 50) {
                logViewer.removeChild(logViewer.firstChild);
            }
            
            // Auto-scroll to bottom
            logViewer.scrollTop = logViewer.scrollHeight;
        }

        // ============================================
        // BULK ENTITY GENERATOR FUNCTIONS
        // ============================================

        // Show Entity Generator Form
        function showEntityGeneratorForm() {
            const modalContent = `
                <h3 style="color: #667eea; margin-bottom: 20px;">🏗️ Bulk Entity Generator</h3>
                
                <form id="entityGeneratorForm">
                    <!-- EA Section -->
                    <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #10b981;">
                        <h4 style="color: #10b981; margin-bottom: 10px;">📝 Enrollment Authorities (EA)</h4>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Number of EAs (0-20):</label>
                        <input type="number" id="num_ea" min="0" max="20" value="0" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px;" onchange="updateEntityNameFields()">
                        <div id="ea_names_container"></div>
                    </div>
                    
                    <!-- AA Section -->
                    <div style="background: #eff6ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #3b82f6;">
                        <h4 style="color: #3b82f6; margin-bottom: 10px;">🎫 Authorization Authorities (AA)</h4>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Number of AAs (0-20):</label>
                        <input type="number" id="num_aa" min="0" max="20" value="0" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px;" onchange="updateEntityNameFields()">
                        <div id="aa_names_container"></div>
                    </div>
                    
                    <!-- TLM Info -->
                    <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #f59e0b;">
                        <h4 style="color: #f59e0b; margin-bottom: 10px;">📋 Trust List Manager (TLM)</h4>
                        <p style="color: #92400e; font-size: 0.9em; font-style: italic;">
                            ✅ TLM_MAIN is automatically included (created if doesn't exist).
                        </p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button type="button" onclick="closeEntityGeneratorModal()" style="padding: 12px; border: none; border-radius: 8px; cursor: pointer; background: #e5e7eb; font-weight: bold;">
                            ❌ Cancel
                        </button>
                        <button type="submit" style="padding: 12px; border: none; border-radius: 8px; cursor: pointer; background: #667eea; color: white; font-weight: bold;">
                            ✅ Generate
                        </button>
                    </div>
                </form>
            `;
            
            let modal = document.getElementById('entityGeneratorModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'entityGeneratorModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.7);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;
                
                const modalContainer = document.createElement('div');
                modalContainer.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    padding: 30px;
                    max-width: 700px;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
                `;
                modalContainer.id = 'entityGeneratorModalBody';
                
                modal.appendChild(modalContainer);
                document.body.appendChild(modal);
            }
            
            document.getElementById('entityGeneratorModalBody').innerHTML = modalContent;
            
            document.getElementById('entityGeneratorForm').addEventListener('submit', function(e) {
                e.preventDefault();
                generateEntitiesWithNames();
            });
        }

        // Update entity name fields
        function updateEntityNameFields() {
            const num_ea = parseInt(document.getElementById('num_ea').value) || 0;
            const num_aa = parseInt(document.getElementById('num_aa').value) || 0;
            
            const eaContainer = document.getElementById('ea_names_container');
            eaContainer.innerHTML = '';
            if (num_ea > 0) {
                eaContainer.innerHTML = '<label style="display: block; margin-top: 10px; margin-bottom: 5px; font-weight: bold; color: #059669;">Entity Names (optional):</label>';
                for (let i = 0; i < num_ea; i++) {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.id = `ea_name_${i}`;
                    input.placeholder = `EA name ${i+1} (e.g., EA_HIGHWAY_01)`;
                    input.style.cssText = 'width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #10b981; border-radius: 5px;';
                    eaContainer.appendChild(input);
                }
            }
            
            const aaContainer = document.getElementById('aa_names_container');
            aaContainer.innerHTML = '';
            if (num_aa > 0) {
                aaContainer.innerHTML = '<label style="display: block; margin-top: 10px; margin-bottom: 5px; font-weight: bold; color: #2563eb;">Entity Names (optional):</label>';
                for (let i = 0; i < num_aa; i++) {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.id = `aa_name_${i}`;
                    input.placeholder = `AA name ${i+1} (e.g., AA_TRAFFIC)`;
                    input.style.cssText = 'width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #3b82f6; border-radius: 5px;';
                    aaContainer.appendChild(input);
                }
            }
        }

        // Close modal
        function closeEntityGeneratorModal() {
            const modal = document.getElementById('entityGeneratorModal');
            if (modal) {
                modal.remove();
            }
        }

        // Generate entities with names
        async function generateEntitiesWithNames() {
            const num_ea = parseInt(document.getElementById('num_ea').value) || 0;
            const num_aa = parseInt(document.getElementById('num_aa').value) || 0;
            
            if (num_ea === 0 && num_aa === 0) {
                alert('⚠️ Please specify at least one entity type!');
                return;
            }
            
            const ea_names = [];
            const aa_names = [];
            
            for (let i = 0; i < num_ea; i++) {
                const nameInput = document.getElementById(`ea_name_${i}`);
                const name = nameInput ? nameInput.value.trim() : '';
                if (name && !name.startsWith('EA_')) {
                    alert(`⚠️ EA name "${name}" must start with "EA_"`);
                    return;
                }
                ea_names.push(name);
            }
            
            for (let i = 0; i < num_aa; i++) {
                const nameInput = document.getElementById(`aa_name_${i}`);
                const name = nameInput ? nameInput.value.trim() : '';
                if (name && !name.startsWith('AA_')) {
                    alert(`⚠️ AA name "${name}" must start with "AA_"`);
                    return;
                }
                aa_names.push(name);
            }
            
            closeEntityGeneratorModal();
            
            addLog(`Generating ${num_ea} EAs, ${num_aa} AAs + TLM (auto)...`, 'info');
            
            let command = 'python setup.py';
            
            if (num_ea > 0) {
                command += ` --ea ${num_ea}`;
                const customEaNames = ea_names.filter(n => n.length > 0);
                if (customEaNames.length > 0) {
                    command += ` --ea-names "${customEaNames.join(',')}"`;
                }
            }
            
            if (num_aa > 0) {
                command += ` --aa ${num_aa}`;
                const customAaNames = aa_names.filter(n => n.length > 0);
                if (customAaNames.length > 0) {
                    command += ` --aa-names "${customAaNames.join(',')}"`;
                }
            }
            
            // TLM is now included by default, no need to specify --tlm
            
            // Auto-copy command to clipboard
            copyCommandToClipboard(command);
            
            showGeneratedEntitiesInstructions(command, num_ea, num_aa);
            
            addLog('✅ Entity generation configured! Command copied to clipboard.', 'info');
        }

        // Show instructions
        function showGeneratedEntitiesInstructions(command, num_ea, num_aa) {
            const modalContent = `
                <h3 style="color: #667eea; margin-bottom: 20px;">🚀 Entity Generation Commands</h3>
                
                <div style="background: #1f2937; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="color: #10b981; margin-bottom: 10px;"><strong>Run this command in PowerShell:</strong></p>
                    <code style="color: #60a5fa; display: block; padding: 10px; background: #111827; border-radius: 5px; cursor: pointer; user-select: all; word-wrap: break-word; white-space: pre-wrap;" onclick="copyCommandToClipboard(this.textContent)">${command}</code>
                    <p style="color: #9ca3af; font-size: 0.85em; margin-top: 5px;">Click to copy</p>
                </div>
                
                <div style="background: #dcfce7; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #10b981;">
                    <p style="color: #065f46; margin-bottom: 10px;"><strong>✨ Automatic Start</strong></p>
                    <p style="color: #047857; font-size: 0.9em;">
                        All entities will automatically start in separate PowerShell terminals!
                    </p>
                </div>
                
                <button onclick="closeInstructionsModal()" style="width: 100%; padding: 12px; border: none; border-radius: 8px; cursor: pointer; background: #667eea; color: white; font-weight: bold;">
                    ✅ Got it!
                </button>
            `;
            
            const modal = document.createElement('div');
            modal.id = 'instructionsModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            const modalContainer = document.createElement('div');
            modalContainer.style.cssText = `
                background: white;
                border-radius: 12px;
                padding: 30px;
                max-width: 700px;
                max-height: 90vh;
                overflow-y: auto;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            `;
            modalContainer.innerHTML = modalContent;
            
            modal.appendChild(modalContainer);
            document.body.appendChild(modal);
        }

        function copyCommandToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                addLog('📋 Command copied to clipboard!', 'info');
            });
        }

        function closeInstructionsModal() {
            const modal = document.getElementById('instructionsModal');
            if (modal) {
                modal.remove();
            }
        }

        // ============================================
        // END BULK ENTITY GENERATOR
        // ============================================

        // Cleanup on unload
        window.onbeforeunload = function() {
            if (scanInterval) clearInterval(scanInterval);
            if (metricsInterval) clearInterval(metricsInterval);
        };
    </script>
    
    <!-- Entity Statistics Modal -->
    <div id="entityStatsModal" class="entity-stats-modal">
        <div class="entity-stats-content">
            <div class="entity-stats-header">
                <div>
                    <h2 id="statsEntityTitle">📊 Entity Statistics</h2>
                    <p id="statsEntitySubtitle" style="opacity: 0.8; margin: 5px 0 0 0;">
                        <span id="statsRefreshIndicator" style="display: none; opacity: 0.6;">⟳ Refreshing...</span>
                    </p>
                </div>
                <button class="entity-stats-close" onclick="closeEntityStats()">&times;</button>
            </div>
            
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-value" id="stat-total-requests">-</div>
                    <div class="stat-label">📨 Total Requests</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="stat-success-rate">-</div>
                    <div class="stat-label">✅ Success Rate</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="stat-response-time">-</div>
                    <div class="stat-label">⚡ Avg Response</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="stat-active-certs">-</div>
                    <div class="stat-label">🎫 Active Certs</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="stat-health-checks">-</div>
                    <div class="stat-label">❤️ Health Checks</div>
                </div>
                <div class="stat-box" id="stat-box-ec-issued" style="display: none;">
                    <div class="stat-value" id="stat-ec-issued">-</div>
                    <div class="stat-label">📝 EC Issued</div>
                </div>
                <div class="stat-box" id="stat-box-at-issued" style="display: none;">
                    <div class="stat-value" id="stat-at-issued">-</div>
                    <div class="stat-label">🎫 AT Issued</div>
                </div>
            </div>
            
            <div class="stats-section">
                <h3>📊 Request Statistics</h3>
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>Endpoint</th>
                            <th>Requests</th>
                            <th>Success</th>
                            <th>Errors</th>
                            <th>Avg Time</th>
                        </tr>
                    </thead>
                    <tbody id="stats-endpoints-table">
                        <tr><td colspan="5" style="text-align: center; opacity: 0.7;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="stats-section">
                <h3>🕐 Recent Activity</h3>
                <div id="stats-recent-activity" style="max-height: 200px; overflow-y: auto;">
                    <div style="opacity: 0.7; text-align: center; padding: 20px;">Loading recent activity...</div>
                </div>
            </div>
            
            <div class="stats-section">
                <h3>ℹ️ Entity Information</h3>
                <table class="stats-table">
                    <tbody id="stats-entity-info">
                        <tr><td colspan="2" style="text-align: center; opacity: 0.7;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- TLM & RootCA Update Script -->
    <script>
        // Populate TLM and RootCA info on page load
        async function updateTLMandRootCAInfo() {
            try {
                // TLM Info (port 5050)
                const tlmResponse = await fetch('http://localhost:5050/api/stats', {timeout: 2000}).catch(() => null);
                if (tlmResponse && tlmResponse.ok) {
                    const tlmData = await tlmResponse.json();
                    document.getElementById('tlm-ea-count').textContent = tlmData.enrolled_eas || '0';
                    document.getElementById('tlm-aa-count').textContent = tlmData.enrolled_aas || '0';
                    document.getElementById('tlm-version').textContent = tlmData.trust_list_version || 'v1.0';
                    
                    // Format last update date
                    if (tlmData.last_update) {
                        const date = new Date(tlmData.last_update);
                        document.getElementById('tlm-last-update').textContent = date.toLocaleString();
                    } else {
                        document.getElementById('tlm-last-update').textContent = 'N/A';
                    }
                } else {
                    document.getElementById('tlm-ea-count').textContent = 'N/A (offline)';
                    document.getElementById('tlm-aa-count').textContent = 'N/A';
                    document.getElementById('tlm-version').textContent = 'N/A';
                    document.getElementById('tlm-last-update').textContent = 'N/A';
                }
                
                // RootCA Info (port 5999)
                const rootcaResponse = await fetch('http://localhost:5999/api/stats', {timeout: 2000}).catch(() => null);
                if (rootcaResponse && rootcaResponse.ok) {
                    const rootcaData = await rootcaResponse.json();
                    document.getElementById('rootca-issued-count').textContent = rootcaData.issued_certificates || '0';
                    document.getElementById('rootca-subca-count').textContent = rootcaData.sub_cas || '0';
                    document.getElementById('rootca-chain-depth').textContent = rootcaData.certificate_chain || 'Root → EA/AA';
                    
                    // Status with icon
                    if (rootcaData.status === 'Active') {
                        document.getElementById('rootca-status').innerHTML = '✅ Active';
                    } else {
                        document.getElementById('rootca-status').innerHTML = '❌ ' + (rootcaData.status || 'Unknown');
                    }
                } else {
                    document.getElementById('rootca-issued-count').textContent = 'N/A (offline)';
                    document.getElementById('rootca-subca-count').textContent = 'N/A';
                    document.getElementById('rootca-status').innerHTML = '❌ Offline';
                }
            } catch (error) {
                console.log('TLM/RootCA info update failed:', error);
            }
        }
        
        // Update on page load and every 10 seconds
        window.addEventListener('DOMContentLoaded', () => {
            updateTLMandRootCAInfo();
            setInterval(updateTLMandRootCAInfo, 10000);
        });
    </script>
    
    <!-- API Tester Functions -->
    <script src="static/api_tester.js"></script>
</body>
</html>

