<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureRoad PKI - Control Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        /* Horizontal Navigation Menu */
        .top-nav {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-container {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

        .nav-brand {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
            padding: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-menu {
            display: flex;
            list-style: none;
            gap: 5px;
        }

        .nav-item {
            position: relative;
        }

        .nav-link {
            display: block;
            padding: 20px 20px;
            color: #333;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s;
            cursor: pointer;
        }

        .nav-link:hover {
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .nav-link.active {
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        /* Dropdown Menu */
        .dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            min-width: 250px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            border-radius: 0 0 8px 8px;
            overflow: hidden;
            z-index: 1001;
        }

        .nav-item:hover .dropdown-content {
            display: block;
        }

        .dropdown-item {
            padding: 12px 20px;
            color: #333;
            text-decoration: none;
            display: block;
            transition: all 0.3s;
            cursor: pointer;
        }

        .dropdown-item:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding-left: 25px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        /* Status Bar - Simplified */
        .status-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .status-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .status-card h3 {
            color: #667eea;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .status-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }

        .status-card.success .value {
            color: #10b981;
        }

        .status-card.warning .value {
            color: #f59e0b;
        }

        .status-card.error .value {
            color: #ef4444;
        }

        /* Main Content Area */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .panel h2 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        /* Instance Cards */
        .instance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }

        .instance-card {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            padding: 20px;
            border-radius: 10px;
            color: white;
        }

        .instance-card.aa {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .instance-card.tlm {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .instance-card.rootca {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        .instance-card h3 {
            font-size: 1.1em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .instance-count {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .instance-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .instance-list {
            font-size: 0.85em;
            opacity: 0.95;
            max-height: 150px;
            overflow-y: auto;
            overflow-x: hidden; /* Prevent horizontal scrollbar */
        }

        .instance-item {
            padding: 8px;
            background: rgba(255,255,255,0.15);
            border-radius: 5px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative; /* For pseudo-element positioning */
        }
        
        .instance-item:hover {
            background: rgba(255,255,255,0.25);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        /* Hover indicator without causing scrollbar */
        .instance-item:hover::before {
            content: '‚Üí';
            position: absolute;
            left: -15px;
            opacity: 0.8;
            animation: pulse 1s infinite;
        }
        
        /* Stat row for TLM/RootCA info */
        .stat-row {
            padding: 6px 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            margin-bottom: 4px;
            font-size: 0.85em;
        }
        
        .stat-row span:first-child {
            opacity: 0.85;
            font-weight: 500;
        }
        
        .stat-row span:last-child {
            font-weight: 600;
            text-align: right;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 0.3; }
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes flashUpdate {
            0% { background-color: rgba(16, 185, 129, 0.3); }
            100% { background-color: transparent; }
        }
        
        .stat-box.updating {
            animation: flashUpdate 0.5s ease-out;
        }
        
        #statsRefreshIndicator {
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        /* Entity Stats Modal */
        .entity-stats-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            overflow-y: auto;
        }
        
        .entity-stats-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            max-width: 900px;
            margin: 50px auto;
            border-radius: 15px;
            padding: 30px;
            color: white;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        
        .entity-stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255,255,255,0.3);
        }
        
        .entity-stats-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .entity-stats-close:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-box {
            background: rgba(255,255,255,0.15);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        /* Action tiles that appear alongside the metric stat boxes */
        .stat-box.stat-action {
            cursor: pointer;
            transition: transform 0.12s ease, box-shadow 0.12s ease;
        }
        .stat-box.stat-action:hover {
            transform: translateY(-6px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.25);
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .stats-section {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .stats-section h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .stats-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .stats-table th,
        .stats-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .stats-table th {
            font-weight: 600;
            opacity: 0.9;
        }

        /* Log Viewer */
        .log-viewer {
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .log-line {
            margin-bottom: 5px;
            padding: 3px 0;
        }

        .log-line.info {
            color: #10b981;
        }

        .log-line.warning {
            color: #f59e0b;
        }

        .log-line.error {
            color: #ef4444;
        }

        /* View Sections - Hidden by default */
        .view-section {
            display: none;
        }

        .view-section.active {
            display: block;
        }

        /* Endpoints Display */
        .endpoint-list {
            display: grid;
            gap: 8px;
        }

        .endpoint-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f9fafb;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .method {
            padding: 4px 10px;
            border-radius: 4px;
            font-weight: bold;
            margin-right: 12px;
            font-size: 0.85em;
            min-width: 50px;
            text-align: center;
        }

        .method.GET {
            background: #dbeafe;
            color: #1e40af;
        }

        .method.POST {
            background: #d1fae5;
            color: #065f46;
        }

        .endpoint-path {
            color: #666;
            flex: 1;
        }

        .endpoint-entity {
            color: #999;
            font-size: 0.85em;
            margin-left: 10px;
        }

        /* Test Coverage */
        .test-grid {
            display: grid;
            gap: 15px;
        }

        .test-category {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .test-category h4 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .test-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: bold;
            background: #d1fae5;
            color: #065f46;
        }

        .test-description {
            color: #666;
            font-size: 0.9em;
            line-height: 1.6;
            margin-top: 10px;
        }

        /* Features Display */
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .feature-card {
            background: #f9fafb;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            border-top: 3px solid #667eea;
            transition: all 0.3s;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .feature-card .icon {
            font-size: 2.5em;
            margin-bottom: 15px;
        }

        .feature-card h4 {
            color: #333;
            margin-bottom: 10px;
        }

        .feature-card p {
            color: #666;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .feature-card .check {
            color: #10b981;
            font-size: 1.5em;
            margin-top: 10px;
        }

        /* Metrics Display */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .metric-card {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .metric-card .label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }

        .metric-card .value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* API Tester Styles */
        .api-category-card {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .api-test-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 600;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }

        .api-test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .api-test-btn:active {
            transform: translateY(0);
        }


        /* Responsive */
        @media (max-width: 768px) {
            .nav-menu {
                display: none;
            }
            
            .nav-brand {
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="nav-container">
            <div class="nav-brand">
                üîê SecureRoad PKI
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a class="nav-link active" onclick="showView('dashboard')">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link">Documentation</a>
                    <div class="dropdown-content">
                        <a class="dropdown-item" onclick="showView('endpoints')">üì° API Endpoints</a>
                        <a class="dropdown-item" onclick="showView('features')">‚ú® Implemented Features</a>
                        <a class="dropdown-item" onclick="openDocs()">üìñ OpenAPI/Swagger</a>
                    </div>
                </li>
                <li class="nav-item">
                    <a class="nav-link">Testing</a>
                    <div class="dropdown-content">
                        <a class="dropdown-item" onclick="showView('api-tester')">üîß API Tester</a>
                        <a class="dropdown-item" onclick="showView('daily-scenarios')">üéØ Scenari Quotidiani</a>
                        <a class="dropdown-item" onclick="showView('test-coverage')">üìä Test Coverage</a>
                        <a class="dropdown-item" onclick="showView('metrics')">üìà Real-Time Metrics</a>
                        <a class="dropdown-item" onclick="showView('test-results')">üß™ Test Results</a>
                    </div>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <!-- Dashboard View (Default) -->
        <div id="view-dashboard" class="view-section active">
            <!-- Header -->
            <div class="header">
                <h1>üîê SecureRoad PKI Control Panel</h1>
                <p>ETSI TS 102941 Compliant - Real-time Monitoring Dashboard</p>
            </div>

            <!-- Status Bar -->
            <div class="status-bar">
                <div class="status-card error" id="systemStatusCard">
                    <h3>System Status</h3>
                    <div class="value" id="systemStatus">Inactive</div>
                </div>
                <div class="status-card success">
                    <h3>Running Instances</h3>
                    <div class="value" id="activeInstancesTotal">0</div>
                </div>
                <div class="status-card">
                    <h3>Total Tests</h3>
                    <div class="value">115</div>
                </div>
                <div class="status-card success">
                    <h3>Tests Passing</h3>
                    <div class="value">115</div>
                </div>
                <div class="status-card">
                    <h3>API Endpoints</h3>
                    <div class="value">11</div>
                </div>
                <div class="status-card">
                    <h3>Last Scan</h3>
                    <div class="value" id="lastScanTime">Never</div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <!-- Running Instances Panel -->
                <div class="panel full-width">
                    <h2>üîå Running Instances</h2>
                    <p style="color: #666; margin-bottom: 20px; font-size: 0.9em;">Real-time monitoring of all active PKI entities</p>
                    
                    <div class="instance-grid">
                        <!-- EA Instances -->
                        <div class="instance-card">
                            <h3>üìù Enrollment Authority</h3>
                            <div class="instance-count" id="instanceCount-EA">0</div>
                            <div class="instance-label">Active Instances</div>
                            <div class="instance-list" id="instanceList-EA">
                                <div class="instance-item" style="opacity: 0.7;">Scanning...</div>
                            </div>
                        </div>

                        <!-- AA Instances -->
                        <div class="instance-card aa">
                            <h3>üé´ Authorization Authority</h3>
                            <div class="instance-count" id="instanceCount-AA">0</div>
                            <div class="instance-label">Active Instances</div>
                            <div class="instance-list" id="instanceList-AA">
                                <div class="instance-item" style="opacity: 0.7;">Scanning...</div>
                            </div>
                        </div>

                        <!-- TLM Instances -->
                        <div class="instance-card tlm">
                            <h3>üìã Trust List Manager</h3>
                            <div class="instance-count" id="instanceCount-TLM">0</div>
                            <div class="instance-label">Active Instances</div>
                            <div class="instance-list" id="instanceList-TLM">
                                <div class="instance-item" style="opacity: 0.7;">Scanning...</div>
                            </div>
                        </div>

                        <!-- RootCA Instances -->
                        <div class="instance-card rootca">
                            <h3>üèõÔ∏è Root CA</h3>
                            <div class="instance-count" id="instanceCount-RootCA">0</div>
                            <div class="instance-label">Active Instances</div>
                            <div class="instance-list" id="instanceList-RootCA">
                                <div class="instance-item" style="opacity: 0.7;">Scanning...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bulk Entity Generator Panel -->
                <div class="panel full-width">
                    <h2>üèóÔ∏è Bulk Entity Generator</h2>
                    <p style="color: #666; margin-bottom: 20px; font-size: 0.9em;">Generate multiple PKI entities at once with automatic terminal startup</p>
                    
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 10px; color: white; text-align: center;">
                        <div style="font-size: 2.5em; margin-bottom: 15px;">üèóÔ∏è</div>
                        <h3 style="margin-bottom: 15px;">Quick Entity Setup</h3>
                        <p style="font-size: 0.95em; opacity: 0.95; margin-bottom: 20px; line-height: 1.6;">
                            Create multiple Enrollment Authorities, Authorization Authorities, and Trust List Manager with custom names. 
                            <!-- Removed: TLM & RootCA Statistics Panel -->
                            <!-- The TLM and RootCA detailed statistics panel was removed per request.
                                 Important: Buttons to view enrolled entities and RootCA details were
                                 added to the Running Instances cards below so the dashboard remains
                                 compact while exposing the requested actions. -->
                                    <span>üìä Trust List Version:</span>
                                    <span id="tlm-version">-</span>
                                </div>
                                <div class="stat-row">
                                    <span>üïê Last Update:</span>
                                    <span id="tlm-last-update">-</span>
                                </div>
                            </div>
                        </div>
                        <!-- RootCA block removed per request -->

                        <!-- Action buttons for Bulk Generator -->
                        <div style="margin-top: 18px; display:flex; gap:12px; justify-content:center; flex-wrap:wrap;">
                            <button onclick="showEntityGeneratorForm()" style="padding: 10px 18px; background: rgba(255,255,255,0.18); color: white; border: 2px solid rgba(255,255,255,0.25); border-radius: 8px; cursor: pointer; font-weight: 700;">‚öôÔ∏è Configure</button>
                            <button onclick="executeSetupDirectly()" style="padding: 10px 18px; background: linear-gradient(135deg,#10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 700;">‚ñ∂Ô∏è Start Now</button>
                        </div>
                    </div>
                </div>

                <!-- Entity Management Panel (NEW) -->
                <div class="panel full-width">
                    <h2>üóëÔ∏è Entity Management</h2>
                    <p style="color: #666; margin-bottom: 20px; font-size: 0.9em;">Manage configured EA and AA entities - Remove unused entities</p>
                    
                    <div style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); padding: 25px; border-radius: 10px; color: white;">
                        <div style="font-size: 2.5em; margin-bottom: 15px;">‚ö†Ô∏è</div>
                        <h3 style="margin-bottom: 15px;">Delete Entity</h3>
                        <p style="font-size: 0.95em; opacity: 0.95; margin-bottom: 20px; line-height: 1.6;">
                            <strong>Warning:</strong> This will permanently delete the selected entity from <code style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 3px;">entity_configs.json</code> 
                            and remove all its data (certificates, keys, CRL) from the <code style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 3px;">data/</code> directory, 
                            including archived certificates in RootCA.
                        </p>
                        
                        <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 10px; font-weight: 600;">Select Entity to Delete:</label>
                            <select id="entityToDelete" style="width: 100%; padding: 12px; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; background: rgba(255,255,255,0.95); color: #333; font-weight: 500; cursor: pointer; font-size: 1em; margin-bottom: 15px;">
                                <option value="">üîç Loading entities...</option>
                            </select>
                            
                            <div id="entityDeleteInfo" style="padding: 12px; background: rgba(255,255,255,0.1); border-radius: 6px; font-size: 0.9em; line-height: 1.6; margin-bottom: 15px; display: none;">
                                <strong>‚ö†Ô∏è This will delete:</strong>
                                <ul style="margin: 10px 0 0 20px; padding: 0;">
                                    <li>Entry from <code>entity_configs.json</code></li>
                                    <li>Data directory: <code id="entityDataPath">-</code></li>
                                    <li>All certificates, keys, and CRL files</li>
                                    <li>Archived certificates from RootCA subordinates</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="refreshEntityDeleteList()" 
                                    style="flex: 1; min-width: 150px; padding: 12px 20px; background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.4); color: white; border-radius: 8px; cursor: pointer; font-weight: 600; backdrop-filter: blur(10px); transition: all 0.3s; font-size: 1em;">
                                üîÑ Refresh List
                            </button>
                            <button onclick="confirmDeleteEntity()" 
                                    style="flex: 2; min-width: 200px; padding: 12px 20px; background: rgba(220, 38, 38, 0.9); border: 2px solid rgba(255,255,255,0.6); color: white; border-radius: 8px; cursor: pointer; font-weight: 600; backdrop-filter: blur(10px); transition: all 0.3s; font-size: 1.1em;">
                                üóëÔ∏è DELETE ENTITY (PERMANENT)
                            </button>
                        </div>
                        
                        <!-- DELETE ALL BUTTON (ENHANCED - Kills processes too!) -->
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid rgba(255,255,255,0.2);">
                            <button onclick="deleteAllEaAa()" 
                                    style="width: 100%; padding: 15px 20px; background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%); border: 3px solid rgba(255,255,255,0.5); color: white; border-radius: 8px; cursor: pointer; font-weight: 700; backdrop-filter: blur(10px); transition: all 0.3s; font-size: 1.2em; text-shadow: 0 2px 4px rgba(0,0,0,0.3); margin-bottom: 10px;">
                                üí• DELETE ALL EA/AA (INSTANT)
                            </button>
                            <p style="margin: 0 0 15px; font-size: 0.85em; opacity: 0.9; text-align: center;">
                                Removes config, deletes data, kills processes, and cleans RootCA archive
                            </p>
                            
                            <div style="background: rgba(16, 185, 129, 0.2); padding: 15px; border-radius: 8px; border-left: 4px solid rgba(16, 185, 129, 0.8);">
                                <p style="margin: 0; font-size: 0.95em; line-height: 1.5;">
                                    ‚úÖ <strong>This button now does everything:</strong>
                                </p>
                                <ul style="margin: 10px 0 0 20px; padding: 0; font-size: 0.9em; line-height: 1.8; opacity: 0.95;">
                                    <li>Kills all EA/AA Python processes</li>
                                    <li>Removes entities from entity_configs.json</li>
                                    <li>Deletes data directories (certificates, keys, CRL)</li>
                                    <li>Removes archived certificates from RootCA</li>
                                    <li>Dashboard updates automatically after 3 seconds</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px; border-left: 4px solid rgba(251, 191, 36, 0.8);">
                            <p style="margin: 0; font-size: 0.9em; line-height: 1.5;">
                                üí° <strong>Note:</strong> ROOT_CA and TLM_MAIN are preserved as they are system entities required for PKI operation.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- System Logs Panel -->
                <div class="panel full-width">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h2 style="margin: 0;">üìã System Logs</h2>
                        <div id="autoScrollIndicator" style="padding: 6px 12px; background: #10b981; color: white; border-radius: 6px; font-size: 0.85em; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                            <span>üîÑ</span>
                            <span>Auto-scroll ON</span>
                        </div>
                    </div>
                    <div class="log-viewer" id="logViewer">
                        <div class="log-line info">[INFO] Dashboard initialized</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Endpoints View -->
        <div id="view-endpoints" class="view-section">
            <div class="panel" style="margin-top: 20px;">
                <h2>üì° API Endpoints</h2>
                <p style="color: #666; margin-bottom: 20px;">Complete list of REST API endpoints conforming to ETSI TS 102941</p>
                
                <div class="endpoint-list">
                    <div class="endpoint-item">
                        <span class="method POST">POST</span>
                        <span class="endpoint-path">/api/enrollment/request</span>
                        <span class="endpoint-entity">EA - ‚úÖ ETSI Conforme (ASN.1 OER)</span>
                    </div>
                    <div class="endpoint-item">
                        <span class="method POST">POST</span>
                        <span class="endpoint-path">/api/enrollment/request/simple</span>
                        <span class="endpoint-entity">EA - ‚ö†Ô∏è Testing Only (JSON)</span>
                    </div>
                    <div class="endpoint-item">
                        <span class="method POST">POST</span>
                        <span class="endpoint-path">/api/enrollment/validation</span>
                        <span class="endpoint-entity">EA - üîí mTLS Required (AA‚ÜíEA)</span>
                    </div>
                    <div class="endpoint-item">
                        <span class="method POST">POST</span>
                        <span class="endpoint-path">/api/authorization/request</span>
                        <span class="endpoint-entity">AA - Single AT Request</span>
                    </div>
                    <div class="endpoint-item">
                        <span class="method POST">POST</span>
                        <span class="endpoint-path">/api/authorization/request/butterfly</span>
                        <span class="endpoint-entity">AA - Batch 20 AT (Privacy)</span>
                    </div>
                    <div class="endpoint-item">
                        <span class="method GET">GET</span>
                        <span class="endpoint-path">/api/crl/full</span>
                        <span class="endpoint-entity">EA, AA - Full CRL</span>
                    </div>
                    <div class="endpoint-item">
                        <span class="method GET">GET</span>
                        <span class="endpoint-path">/api/crl/delta</span>
                        <span class="endpoint-entity">EA, AA - Delta CRL</span>
                    </div>
                    <div class="endpoint-item">
                        <span class="method GET">GET</span>
                        <span class="endpoint-path">/api/trust-list/full</span>
                        <span class="endpoint-entity">TLM - Full CTL</span>
                    </div>
                    <div class="endpoint-item">
                        <span class="method GET">GET</span>
                        <span class="endpoint-path">/api/trust-list/delta</span>
                        <span class="endpoint-entity">TLM - Delta CTL</span>
                    </div>
                    <div class="endpoint-item">
                        <span class="method GET">GET</span>
                        <span class="endpoint-path">/health</span>
                        <span class="endpoint-entity">All - Health Check</span>
                    </div>
                    <div class="endpoint-item">
                        <span class="method GET">GET</span>
                        <span class="endpoint-path">/api/docs</span>
                        <span class="endpoint-entity">All - Swagger UI</span>
                    </div>
                </div>

                <div style="background: #fef3c7; padding: 20px; border-radius: 8px; border-left: 4px solid #f59e0b; margin-top: 20px;">
                    <h3 style="color: #92400e; margin-bottom: 15px;">üîí mTLS Authentication Info</h3>
                    <p style="color: #78350f; line-height: 1.6; margin-bottom: 10px;">
                        <strong>/api/enrollment/validation</strong> requires mutual TLS (mTLS) authentication with a valid client certificate.
                    </p>
                    <p style="color: #78350f; line-height: 1.6; font-size: 0.9em;">
                        This endpoint is used for inter-authority communication where an Authorization Authority (AA) requests 
                        validation of an Enrollment Certificate (EC) from an Enrollment Authority (EA). 
                        Only authorized AA entities with valid certificates can access this endpoint.
                    </p>
                </div>
            </div>
        </div>

        <!-- API Tester View -->
        <div id="view-api-tester" class="view-section">
            <div class="panel" style="margin-top: 20px;">
                <h2>üîß API Tester - Test Individual Endpoints</h2>
                <p style="color: #666; margin-bottom: 20px;">Test PKI API endpoints interactively</p>
                
                <!-- Configuration Section -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 12px; margin-bottom: 20px; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                    <h3 style="color: white; margin-bottom: 20px; font-size: 1.3em;">‚öôÔ∏è Entity Selection</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <!-- EA Selection -->
                        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">
                            <label style="display: block; margin-bottom: 10px; font-weight: 600; font-size: 1.05em;">
                                üìù Enrollment Authority (EA)
                            </label>
                            <select id="selectedEA" onchange="updateEAUrl()" 
                                    style="width: 100%; padding: 10px; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; background: rgba(255,255,255,0.95); color: #333; font-weight: 500; cursor: pointer; font-size: 1em;">
                                <option value="">üîç Scanning for EA...</option>
                            </select>
                            <div id="eaUrlDisplay" style="margin-top: 10px; padding: 8px; background: rgba(255,255,255,0.2); border-radius: 6px; font-size: 0.9em; font-family: 'Courier New', monospace; word-break: break-all;">
                                URL: -
                            </div>
                        </div>

                        <!-- AA Selection -->
                        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">
                            <label style="display: block; margin-bottom: 10px; font-weight: 600; font-size: 1.05em;">
                                üé´ Authorization Authority (AA)
                            </label>
                            <select id="selectedAA" onchange="updateAAUrl()" 
                                    style="width: 100%; padding: 10px; border: 2px solid rgba(255,255,255,0.3); border-radius: 8px; background: rgba(255,255,255,0.95); color: #333; font-weight: 500; cursor: pointer; font-size: 1em;">
                                <option value="">üîç Scanning for AA...</option>
                            </select>
                            <div id="aaUrlDisplay" style="margin-top: 10px; padding: 8px; background: rgba(255,255,255,0.2); border-radius: 6px; font-size: 0.9em; font-family: 'Courier New', monospace; word-break: break-all;">
                                URL: -
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="refreshEntityList()" 
                                style="padding: 10px 20px; background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.4); color: white; border-radius: 8px; cursor: pointer; font-weight: 600; backdrop-filter: blur(10px); transition: all 0.3s;">
                            üîÑ Refresh Entities
                        </button>
                        <button onclick="testSelectedEA()" 
                                style="padding: 10px 20px; background: rgba(16, 185, 129, 0.8); border: 2px solid rgba(255,255,255,0.4); color: white; border-radius: 8px; cursor: pointer; font-weight: 600; backdrop-filter: blur(10px); transition: all 0.3s;">
                            ‚úÖ Test EA Connection
                        </button>
                        <button onclick="testSelectedAA()" 
                                style="padding: 10px 20px; background: rgba(59, 130, 246, 0.8); border: 2px solid rgba(255,255,255,0.4); color: white; border-radius: 8px; cursor: pointer; font-weight: 600; backdrop-filter: blur(10px); transition: all 0.3s;">
                            ‚úÖ Test AA Connection
                        </button>
                    </div>

                    <div style="margin-top: 15px; padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px; border-left: 4px solid rgba(251, 191, 36, 0.8);">
                        <p style="margin: 0; font-size: 0.9em; line-height: 1.5;">
                            üí° <strong>Tip:</strong> Select an EA to test enrollment endpoints and an AA to test authorization endpoints. 
                            The dropdown automatically detects all active entities.
                        </p>
                    </div>
                </div>

                <!-- API Categories -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
                    
                    <!-- Enrollment APIs -->
                    <div class="api-category-card">
                        <h3 style="color: #10b981; margin-bottom: 15px;">üìù Enrollment APIs</h3>
                        
                        <button class="api-test-btn" onclick="testEnrollmentRequest()">
                            POST /api/enrollment/request
                        </button>
                        <p style="font-size: 0.85em; color: #666; margin: 5px 0 15px 0;">
                            ‚ö†Ô∏è <strong>ETSI TS 102941 Compliant</strong> - Requires ASN.1 OER encoding<br>
                            Use Python scripts for testing
                        </p>

                        <button class="api-test-btn" onclick="testSimpleEnrollmentRequest()" 
                                style="background: linear-gradient(135deg, #10b981, #059669);">
                            üß™ POST /api/enrollment/request/simple
                        </button>
                        <p style="font-size: 0.85em; color: #666; margin: 5px 0 15px 0;">
                            <strong>‚úÖ JSON API for Dashboard Testing</strong><br>
                            Generate EC with web form - copy/paste workflow
                        </p>

                        <button class="api-test-btn" onclick="testEnrollmentValidation()">
                            POST /api/enrollment/validation
                        </button>
                        <p style="font-size: 0.85em; color: #666; margin: 5px 0;">
                            ‚ö†Ô∏è <strong>ETSI TS 102941 Compliant</strong> - Requires mTLS and ASN.1 OER<br>
                            Use Python scripts for testing
                        </p>
                    </div>

                    <!-- Authorization APIs -->
                    <div class="api-category-card">
                        <h3 style="color: #3b82f6; margin-bottom: 15px;">üé´ Authorization APIs</h3>
                        
                        <button class="api-test-btn" onclick="testAuthorizationRequest()">
                            POST /api/authorization/request
                        </button>
                        <p style="font-size: 0.85em; color: #666; margin: 5px 0 15px 0;">
                            ‚ö†Ô∏è <strong>ETSI TS 102941 Compliant</strong> - Requires signed ASN.1 OER request<br>
                            Use Python scripts for testing
                        </p>

                        <button class="api-test-btn" onclick="testSimpleAuthorizationRequest()"
                                style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
                            üß™ POST /api/authorization/request/simple
                        </button>
                        <p style="font-size: 0.85em; color: #666; margin: 5px 0 15px 0;">
                            <strong>‚úÖ JSON API for Dashboard Testing</strong><br>
                            Request AT using EC from enrollment step
                        </p>

                        <button class="api-test-btn" onclick="testButterflyRequest()">
                            POST /api/authorization/butterfly-request
                        </button>
                        <p style="font-size: 0.85em; color: #666; margin: 5px 0 15px 0;">
                            ‚ö†Ô∏è <strong>ETSI TS 102941 Compliant</strong> - Requires HMAC keys and ASN.1 OER<br>
                            Use Python scripts for testing
                        </p>

                        <button class="api-test-btn" onclick="testSimpleButterflyRequest()"
                                style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                            üß™ POST /api/authorization/butterfly-request/simple
                        </button>
                        <p style="font-size: 0.85em; color: #666; margin: 5px 0;">
                            <strong>‚úÖ JSON API for Dashboard Testing</strong><br>
                            Request 20 ATs via Butterfly expansion
                        </p>
                    </div>

                    <!-- CRL APIs -->
                    <div class="api-category-card">
                        <h3 style="color: #8b5cf6; margin-bottom: 15px;">üìã CRL APIs</h3>
                        
                        <button class="api-test-btn" onclick="testGetFullCRL()">
                            GET /api/crl/full
                        </button>
                        <p style="font-size: 0.85em; color: #666; margin: 5px 0 15px 0;">
                            Download Full Certificate Revocation List
                        </p>

                        <button class="api-test-btn" onclick="testGetDeltaCRL()">
                            GET /api/crl/delta
                        </button>
                        <p style="font-size: 0.85em; color: #666; margin: 5px 0;">
                            Download Delta CRL
                        </p>
                    </div>

                    <!-- Trust List APIs -->
                    <div class="api-category-card">
                        <h3 style="color: #f59e0b; margin-bottom: 15px;">üîê Trust List APIs</h3>
                        
                        <button class="api-test-btn" onclick="testGetFullCTL()">
                            GET /api/trust-list/full
                        </button>
                        <p style="font-size: 0.85em; color: #666; margin: 5px 0 15px 0;">
                            Download Full Certificate Trust List
                        </p>

                        <button class="api-test-btn" onclick="testGetDeltaCTL()">
                            GET /api/trust-list/delta
                        </button>
                        <p style="font-size: 0.85em; color: #666; margin: 5px 0;">
                            Download Delta CTL
                        </p>
                    </div>

                    <!-- System APIs -->
                    <div class="api-category-card">
                        <h3 style="color: #667eea; margin-bottom: 15px;">‚öôÔ∏è System APIs</h3>
                        
                        <button class="api-test-btn" onclick="testHealthCheck()">
                            GET /health
                        </button>
                        <p style="font-size: 0.85em; color: #666; margin: 5px 0 15px 0;">
                            Check system health status
                        </p>

                        <button class="api-test-btn" onclick="testRootEndpoint()">
                            GET /
                        </button>
                        <p style="font-size: 0.85em; color: #666; margin: 5px 0;">
                            Get API information
                        </p>
                    </div>

                    <!-- Monitoring APIs -->
                    <div class="api-category-card">
                        <h3 style="color: #ef4444; margin-bottom: 15px;">üìä Monitoring APIs</h3>
                        
                        <button class="api-test-btn" onclick="testGetMetrics()">
                            GET /api/monitoring/metrics
                        </button>
                        <p style="font-size: 0.85em; color: #666; margin: 5px 0;">
                            Get real-time system metrics
                        </p>
                    </div>

                </div>

                <!-- Results Section -->
                <div style="margin-top: 30px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">Test Results</h3>
                    <div id="apiTestResults" class="log-viewer" style="min-height: 300px;">
                        <div style="color: #888;">Click a button above to test an API endpoint...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Coverage View -->
        <div id="view-test-coverage" class="view-section">
            <div class="panel" style="margin-top: 20px;">
                <h2>üìä Test Coverage</h2>
                <p style="color: #666; margin-bottom: 20px;">Comprehensive test suite with 115 passing tests</p>
                
                <div class="test-grid">
                    <div class="test-category">
                        <h4>
                            <span>üîê PKI Entity Tests</span>
                            <span class="test-badge">25 tests</span>
                        </h4>
                        <div class="test-description">
                            <strong>Validates:</strong> Root CA initialization, EA/AA certificate issuance, entity lifecycle management, certificate chain validation, key pair generation.
                        </div>
                    </div>

                    <div class="test-category">
                        <h4>
                            <span>üì° REST API Tests</span>
                            <span class="test-badge">20 tests</span>
                        </h4>
                        <div class="test-description">
                            <strong>Validates:</strong> Endpoint responses, authentication (API Key, mTLS), rate limiting, CORS headers, content negotiation, error handling.
                        </div>
                    </div>

                    <div class="test-category">
                        <h4>
                            <span>ü¶ã Butterfly Key Expansion Tests</span>
                            <span class="test-badge">15 tests</span>
                        </h4>
                        <div class="test-description">
                            <strong>Validates:</strong> Batch AT generation (20 tickets), key derivation, unlinkability properties, HMAC-based expansion, privacy preservation.
                        </div>
                    </div>

                    <div class="test-category">
                        <h4>
                            <span>üîó ETSI Link Certificate Tests</span>
                            <span class="test-badge">12 tests</span>
                        </h4>
                        <div class="test-description">
                            <strong>Validates:</strong> Link certificate creation, EA‚ÜíRootCA linking, certificate verification, trust chain building, cross-certification.
                        </div>
                    </div>

                    <div class="test-category">
                        <h4>
                            <span>üìã CRL/CTL Manager Tests</span>
                            <span class="test-badge">18 tests</span>
                        </h4>
                        <div class="test-description">
                            <strong>Validates:</strong> CRL generation (Full/Delta), certificate revocation, CTL creation, trust list updates, delta list computation.
                        </div>
                    </div>

                    <div class="test-category">
                        <h4>
                            <span>üöó ITS Station Tests</span>
                            <span class="test-badge">10 tests</span>
                        </h4>
                        <div class="test-description">
                            <strong>Validates:</strong> Vehicle enrollment, AT requests, certificate storage, V2X message signing, certificate renewal.
                        </div>
                    </div>

                    <div class="test-category">
                        <h4>
                            <span>üìù ETSI Protocol Compliance</span>
                            <span class="test-badge">15 tests</span>
                        </h4>
                        <div class="test-description">
                            <strong>Validates:</strong> ETSI TS 102941 compliance, ASN.1 OER encoding/decoding, message structure, response codes, IEEE 1609.2 compatibility.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Daily Scenarios View (NEW SEPARATE VIEW) -->
        <div id="view-daily-scenarios" class="view-section">
            <div class="panel" style="margin-top: 20px;">
                <h2>üéØ Scenari Quotidiani - Interactive PKI Tester</h2>
                <p style="color: #666; margin-bottom: 20px;">
                    Lo script <code style="background: #f3f4f6; padding: 2px 8px; border-radius: 4px;">interactive_pki_tester.py</code> 
                    simula scenari reali di utilizzo della PKI V2X
                </p>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    
                    <!-- Scenario 1 -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 15px 0; font-size: 1.3em;">‚úàÔ∏è Test 1: Enrollment Singolo</h3>
                        <p style="margin: 0 0 10px 0; opacity: 0.9; line-height: 1.6;">
                            Simula l'enrollment di un nuovo veicolo nella PKI:
                        </p>
                        <ul style="margin: 0; padding-left: 20px; opacity: 0.9; line-height: 1.8;">
                            <li>Genera coppia di chiavi EC P-256</li>
                            <li>POST /api/enrollment/request all'EA</li>
                            <li>Riceve e valida l'Enrollment Certificate</li>
                            <li>Verifica firma digitale del certificato</li>
                            <li>Salva EC in memoria per test successivi</li>
                        </ul>
                        <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 6px; font-size: 0.9em;">
                            <strong>Output:</strong> Enrollment Certificate (PEM) valido per 365 giorni
                        </div>
                    </div>

                    <!-- Scenario 2 -->
                    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 12px; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 15px 0; font-size: 1.3em;">üé´ Test 2: Authorization Ticket</h3>
                        <p style="margin: 0 0 10px 0; opacity: 0.9; line-height: 1.6;">
                            Richiesta di Authorization Ticket usando l'EC del Test 1:
                        </p>
                        <ul style="margin: 0; padding-left: 20px; opacity: 0.9; line-height: 1.8;">
                            <li>Usa EC ottenuto dal Test 1</li>
                            <li>Genera nuova chiave per AT</li>
                            <li>POST /api/authorization/request all'AA</li>
                            <li>Riceve Authorization Ticket</li>
                            <li>Valida permissions (CAM, DENM)</li>
                        </ul>
                        <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 6px; font-size: 0.9em;">
                            <strong>Output:</strong> Authorization Ticket valido per 7 giorni con HMAC key
                        </div>
                    </div>

                    <!-- Scenario 3 -->
                    <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 20px; border-radius: 12px; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 15px 0; font-size: 1.3em;">üöó Test 3: Flotta Veicoli</h3>
                        <p style="margin: 0 0 10px 0; opacity: 0.9; line-height: 1.6;">
                            Enrollment simultaneo di 5 veicoli (stress test):
                        </p>
                        <ul style="margin: 0; padding-left: 20px; opacity: 0.9; line-height: 1.8;">
                            <li>Loop su 5 veicoli (VEHICLE_001 ‚Üí VEHICLE_005)</li>
                            <li>Enrollment parallelo all'EA</li>
                            <li>Verifica che tutti ricevano EC validi</li>
                            <li>Test di scalabilit√† del sistema</li>
                            <li>Misura tempo di risposta medio</li>
                        </ul>
                        <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 6px; font-size: 0.9em;">
                            <strong>Output:</strong> 5 EC validi + statistiche performance
                        </div>
                    </div>

                    <!-- Scenario 4 -->
                    <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 20px; border-radius: 12px; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 15px 0; font-size: 1.3em;">üì° Test 4: Comunicazione V2V</h3>
                        <p style="margin: 0 0 10px 0; opacity: 0.9; line-height: 1.6;">
                            Simula scambio di messaggi tra 2 veicoli:
                        </p>
                        <ul style="margin: 0; padding-left: 20px; opacity: 0.9; line-height: 1.8;">
                            <li>Enrollment di VEHICLE_A e VEHICLE_B</li>
                            <li>Richiesta AT per entrambi</li>
                            <li>VEHICLE_A firma messaggio CAM</li>
                            <li>VEHICLE_B verifica la firma</li>
                            <li>Test di trust chain completa</li>
                        </ul>
                        <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 6px; font-size: 0.9em;">
                            <strong>Output:</strong> Messaggio V2X firmato e verificato ‚úÖ
                        </div>
                    </div>

                    <!-- Scenario 5 -->
                    <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); padding: 20px; border-radius: 12px; color: #333; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 15px 0; font-size: 1.3em;">‚úîÔ∏è Test 5: Validazione Certificati</h3>
                        <p style="margin: 0 0 10px 0; opacity: 0.9; line-height: 1.6;">
                            Verifica la validit√† dei certificati ottenuti:
                        </p>
                        <ul style="margin: 0; padding-left: 20px; opacity: 0.9; line-height: 1.8;">
                            <li>Check scadenza certificati</li>
                            <li>Verifica firma digitale con Root CA</li>
                            <li>Controllo trust chain (AT ‚Üí EC ‚Üí EA ‚Üí Root CA)</li>
                            <li>Verifica che non siano revocati (CRL check)</li>
                            <li>Validazione campi ETSI obbligatori</li>
                        </ul>
                        <div style="margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.1); border-radius: 6px; font-size: 0.9em;">
                            <strong>Output:</strong> Report validazione completo
                        </div>
                    </div>

                    <!-- Scenario 6 -->
                    <div style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); padding: 20px; border-radius: 12px; color: #333; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 15px 0; font-size: 1.3em;">‚ö° Test 6: Performance Test</h3>
                        <p style="margin: 0 0 10px 0; opacity: 0.9; line-height: 1.6;">
                            Test di carico su 10 enrollment simultanei:
                        </p>
                        <ul style="margin: 0; padding-left: 20px; opacity: 0.9; line-height: 1.8;">
                            <li>10 richieste di enrollment concorrenti</li>
                            <li>Misura tempo di risposta (min/max/avg)</li>
                            <li>Verifica tasso di successo</li>
                            <li>Test di rate limiting</li>
                            <li>Analisi throughput del sistema</li>
                        </ul>
                        <div style="margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.1); border-radius: 6px; font-size: 0.9em;">
                            <strong>Output:</strong> Statistiche performance dettagliate
                        </div>
                    </div>

                </div>

                <!-- Command Section -->
                <div style="background: #1e293b; color: #e2e8f0; padding: 25px; border-radius: 12px; margin-top: 30px;">
                    <h3 style="color: #60a5fa; margin-top: 0;">üíª Come Eseguire i Test</h3>
                    
                    <div style="margin-bottom: 20px;">
                        <p style="margin: 0 0 10px 0; opacity: 0.9;">
                            <strong style="color: #fbbf24;">1. Menu Interattivo (Raccomandato):</strong>
                        </p>
                        <pre style="background: #0f172a; padding: 15px; border-radius: 8px; overflow-x: auto; border: 1px solid #334155; margin: 0;">python examples/interactive_pki_tester.py</pre>
                        <p style="margin: 10px 0 0 0; opacity: 0.7; font-size: 0.9em;">
                            ‚Ä¢ Mostra menu con tutti i 6 test<br>
                            ‚Ä¢ Scegli test singolo o esegui tutti<br>
                            ‚Ä¢ Avvia automaticamente le entities PKI se non attive
                        </p>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <p style="margin: 0 0 10px 0; opacity: 0.9;">
                            <strong style="color: #fbbf24;">2. Esecuzione Automatica Completa:</strong>
                        </p>
                        <pre style="background: #0f172a; padding: 15px; border-radius: 8px; overflow-x: auto; border: 1px solid #334155; margin: 0;">python examples/interactive_pki_tester.py --auto</pre>
                        <p style="margin: 10px 0 0 0; opacity: 0.7; font-size: 0.9em;">
                            ‚Ä¢ Esegue tutti i 6 test in sequenza<br>
                            ‚Ä¢ Report finale con statistiche<br>
                            ‚Ä¢ Ideale per CI/CD e regression testing
                        </p>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <p style="margin: 0 0 10px 0; opacity: 0.9;">
                            <strong style="color: #fbbf24;">3. Con Entities Gi√† Attive:</strong>
                        </p>
                        <pre style="background: #0f172a; padding: 15px; border-radius: 8px; overflow-x: auto; border: 1px solid #334155; margin: 0;">python examples/interactive_pki_tester.py --no-start</pre>
                        <p style="margin: 10px 0 0 0; opacity: 0.7; font-size: 0.9em;">
                            ‚Ä¢ Usa entities PKI gi√† avviate (da start_all_entities.ps1)<br>
                            ‚Ä¢ Pi√π veloce per test ripetuti<br>
                            ‚Ä¢ Non avvia nuovi processi Python
                        </p>
                    </div>

                    </div>
                    <!-- Modal for displaying lists (ECs, ATs, Sub CAs, Issued Certs) -->
                    <div id="entityModal" class="modal" style="display:none; position:fixed; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.6); align-items:center; justify-content:center;">
                        <div style="background:white; width:90%; max-width:900px; border-radius:8px; padding:18px; max-height:80%; overflow:auto;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <h3 id="entityModalTitle" style="margin:0;">Details</h3>
                                <button onclick="closeEntityModal()" style="background:#ef4444; color:white; border:none; padding:6px 10px; border-radius:6px;">Close</button>
                            </div>
                            <div id="entityModalBody" style="margin-top:12px; font-family: 'Courier New', monospace; font-size:0.95em; color:#111;">
                                Loading...
                            </div>
                        </div>
                    </div>

                    <script>
                    // Helper to open modal and set content
                    function openEntityModal(title, htmlContent){
                        document.getElementById('entityModalTitle').innerText = title;
                        document.getElementById('entityModalBody').innerHTML = htmlContent;
                        document.getElementById('entityModal').style.display = 'flex';
                    }
                    function closeEntityModal(){
                        document.getElementById('entityModal').style.display = 'none';
                    }

                    // TLM handlers: fetch enrolled ECs/ATs from the TLM instance's /api/trust-list/full
                    // Uses currentEntityStats.port (set when opening the stats modal)
                    function showTlmEnrolledEa(){
                        const port = (window.currentEntityStats && window.currentEntityStats.port) || null;
                        openEntityModal('Enrolled EA - Enrollment Certificates (ECs)', 'Loading enrolled EA ECs...');
                        if (!port) {
                            openEntityModal('Enrolled EA - Enrollment Certificates (ECs)', '<div style="color:#ef4444;">No TLM instance selected.</div>');
                            return;
                        }

                        fetch(`http://localhost:${port}/api/trust-list/full`)
                        .then(r=>{ if(!r.ok) throw new Error('Endpoint returned ' + r.status); return r.json(); })
                        .then(data=>{
                            const anchors = (data && Array.isArray(data.trust_anchors)) ? data.trust_anchors : [];
                            const eas = anchors.filter(a => (a.authority_type || '').toUpperCase() === 'EA');
                            if(eas.length === 0){
                                openEntityModal('Enrolled EA - Enrollment Certificates (ECs)', '<div>No enrolled EA entries found in CTL.</div>');
                                return;
                            }

                            const html = eas.map((e,i)=>{
                                const subject = escapeHtml(e.subject || e.subject_name || e.authority_id || 'Unknown');
                                const certId = escapeHtml(e.cert_id || e.certId || '');
                                const ski = e.ski ? escapeHtml(String(e.ski).slice(0,24) + (String(e.ski).length>24? '...':'')) : 'N/A';
                                const expiry = e.expiry ? escapeHtml((e.expiry || '').slice(0,19).replace('T',' ')) : 'N/A';
                                const added = e.added ? escapeHtml(String(e.added).replace('T',' ').slice(0,19)) : '';
                                return `<div style="padding:8px 0;border-bottom:1px solid #eee;">
                                            <div style="font-weight:700;">${i+1}. ${subject}</div>
                                            <div style="color:#444;margin-top:6px;">${certId ? `<span style=\"margin-right:10px;\">ID: ${certId}</span>` : ''}<span style=\"margin-right:10px;\">SKI: ${ski}</span><span>Expiry: ${expiry}</span></div>
                                            ${added ? `<div style=\"color:#777;margin-top:6px;font-size:0.9em;\">Added: ${added}</div>` : ''}
                                        </div>`;
                            }).join('');

                            openEntityModal('Enrolled EA - Enrollment Certificates (ECs)', html);
                        }).catch(()=>{
                            // Fallback placeholder
                            const sample = ['EA_001 - EC: thumbprint: A1B2C3', 'EA_002 - EC: thumbprint: D4E5F6'];
                            const html = sample.map((s,i)=>`<div style="padding:6px 0;border-bottom:1px solid #eee;"><strong>${i+1}.</strong> ${escapeHtml(s)}</div>`).join('');
                            openEntityModal('Enrolled EA - Enrollment Certificates (ECs)', html);
                        });
                    }

                    function showTlmEnrolledAa(){
                        const port = (window.currentEntityStats && window.currentEntityStats.port) || null;
                        openEntityModal('Enrolled AA - Authorization Tickets (ATs)', 'Loading enrolled AA ATs...');
                        if (!port) {
                            openEntityModal('Enrolled AA - Authorization Tickets (ATs)', '<div style="color:#ef4444;">No TLM instance selected.</div>');
                            return;
                        }

                        fetch(`http://localhost:${port}/api/trust-list/full`)
                        .then(r=>{ if(!r.ok) throw new Error('Endpoint returned ' + r.status); return r.json(); })
                        .then(data=>{
                            const anchors = (data && Array.isArray(data.trust_anchors)) ? data.trust_anchors : [];
                            const aas = anchors.filter(a => (a.authority_type || '').toUpperCase() === 'AA');
                            if(aas.length === 0){
                                openEntityModal('Enrolled AA - Authorization Tickets (ATs)', '<div>No enrolled AA entries found in CTL.</div>');
                                return;
                            }

                            const html = aas.map((e,i)=>{
                                const subject = escapeHtml(e.subject || e.subject_name || e.authority_id || 'Unknown');
                                const certId = escapeHtml(e.cert_id || e.certId || '');
                                const ski = e.ski ? escapeHtml(String(e.ski).slice(0,24) + (String(e.ski).length>24? '...':'')) : 'N/A';
                                const expiry = e.expiry ? escapeHtml((e.expiry || '').slice(0,19).replace('T',' ')) : 'N/A';
                                const added = e.added ? escapeHtml(String(e.added).replace('T',' ').slice(0,19)) : '';
                                return `<div style="padding:8px 0;border-bottom:1px solid #eee;">
                                            <div style="font-weight:700;">${i+1}. ${subject}</div>
                                            <div style="color:#444;margin-top:6px;">${certId ? `<span style=\"margin-right:10px;\">ID: ${certId}</span>` : ''}<span style=\"margin-right:10px;\">SKI: ${ski}</span><span>Expiry: ${expiry}</span></div>
                                            ${added ? `<div style=\"color:#777;margin-top:6px;font-size:0.9em;\">Added: ${added}</div>` : ''}
                                        </div>`;
                            }).join('');

                            openEntityModal('Enrolled AA - Authorization Tickets (ATs)', html);
                        }).catch(()=>{
                            const sample = ['AA_01 - ATs: 20', 'AA_02 - ATs: 18'];
                            const html = sample.map((s,i)=>`<div style="padding:6px 0;border-bottom:1px solid #eee;"><strong>${i+1}.</strong> ${escapeHtml(s)}</div>`).join('');
                            openEntityModal('Enrolled AA - Authorization Tickets (ATs)', html);
                        });
                    }

                    // RootCA handlers
                    function showRootcaSubCAs(){
                                        openEntityModal('Root CA - Subordinate CAs', 'Loading Sub CAs...');
                                        // try instance-specific rootca endpoint if modal has currentEntityStats.port
                                        const rootcaPort = (window.currentEntityStats && window.currentEntityStats.port) || null;
                                        const subcasUrl = rootcaPort ? `http://localhost:${rootcaPort}/api/rootca/subcas` : '/api/rootca/subcas';
                                        fetch(subcasUrl)
                        .then(r=>{ if(!r.ok) throw new Error('No endpoint'); return r.json(); })
                        .then(data=>{
                            if(!Array.isArray(data) || data.length===0){ openEntityModal('Root CA - Subordinate CAs','<div>No subordinate CAs found.</div>'); return; }
                            const html = data.map((s,i)=>`<div style="padding:6px 0;border-bottom:1px solid #eee;"><strong>${i+1}.</strong> ${escapeHtml(s.name || s.id || s.cn)}<div style="color:#666;margin-top:3px;">${escapeHtml(s.info || '')}</div></div>`).join('');
                            openEntityModal('Root CA - Subordinate CAs', html);
                        }).catch(()=>{
                            const sample = ['SUBCA_1 - Issued: 200 certs', 'SUBCA_2 - Issued: 120 certs'];
                            const html = sample.map((s,i)=>`<div style="padding:6px 0;border-bottom:1px solid #eee;"><strong>${i+1}.</strong> ${escapeHtml(s)}</div>`).join('');
                            openEntityModal('Root CA - Subordinate CAs', html);
                        });
                    }

                    function showRootcaIssuedCerts(){
                                        openEntityModal('Root CA - Issued Certificates', 'Loading issued certs...');
                                        const rootcaPort = (window.currentEntityStats && window.currentEntityStats.port) || null;
                                        const issuedUrl = rootcaPort ? `http://localhost:${rootcaPort}/api/rootca/issued-certs` : '/api/rootca/issued-certs';
                                        fetch(issuedUrl)
                        .then(r=>{ if(!r.ok) throw new Error('No endpoint'); return r.json(); })
                        .then(data=>{
                            if(!Array.isArray(data) || data.length===0){ openEntityModal('Root CA - Issued Certificates','<div>No issued certificates found.</div>'); return; }
                            const html = data.map((c,i)=>`<div style="padding:6px 0;border-bottom:1px solid #eee;"><strong>${i+1}.</strong> ${escapeHtml(c.subject || c.serial || c.id)}<div style="color:#666;margin-top:3px;">${escapeHtml(c.not_after || '')}</div></div>`).join('');
                            openEntityModal('Root CA - Issued Certificates', html);
                        }).catch(()=>{
                            const sample = ['cert-001 - subj: CN=EA_001', 'cert-002 - subj: CN=AA_001'];
                            const html = sample.map((s,i)=>`<div style="padding:6px 0;border-bottom:1px solid #eee;"><strong>${i+1}.</strong> ${escapeHtml(s)}</div>`).join('');
                            openEntityModal('Root CA - Issued Certificates', html);
                        });
                    }

                    // Small HTML escape helper
                    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"'`]/g, function(ch){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;","`":"&#96;"}[ch]; }); }

                    // Helper: get selected port for a given entity type
                    function getPortFor(entityType){
                        if (window.currentEntityStats && window.currentEntityStats.entityType === entityType) return window.currentEntityStats.port;
                        if(entityType === 'EA'){
                            const sel = document.getElementById('selectedEA'); if(sel && sel.value) return sel.value;
                        }
                        if(entityType === 'AA'){
                            const sel = document.getElementById('selectedAA'); if(sel && sel.value) return sel.value;
                        }
                        // Fallback: try currentEntityStats port regardless
                        if (window.currentEntityStats) return window.currentEntityStats.port;
                        return null;
                    }

                    // Generic test fetcher: fetch URL and dump result to apiTestResults
                    async function runTestFetch(url){
                        const out = document.getElementById('apiTestResults');
                        out.innerHTML = `<div style="padding:12px;">Fetching ${escapeHtml(url)} ...</div>`;
                        try{
                            const r = await fetch(url);
                            const txt = await r.text();
                            out.innerHTML = `<pre style="white-space:pre-wrap;">${escapeHtml(txt)}</pre>`;
                        }catch(e){
                            out.innerHTML = `<div style="color:#ef4444; padding:12px;">Error: ${escapeHtml(e.message || String(e))}</div>`;
                        }
                    }

                    // Test helpers used by buttons
                    function testGetFullCRL(){
                        const port = getPortFor('EA') || getPortFor('AA');
                        if(!port){ addLog('‚ùå No EA/AA instance selected for CRL test','error'); return; }
                        runTestFetch(`http://localhost:${port}/api/crl/full`);
                    }
                    function testGetDeltaCRL(){
                        const port = getPortFor('EA') || getPortFor('AA');
                        if(!port){ addLog('‚ùå No EA/AA instance selected for CRL test','error'); return; }
                        runTestFetch(`http://localhost:${port}/api/crl/delta`);
                    }
                    function testGetFullCTL(){
                        const port = getPortFor('TLM') || (window.currentEntityStats && window.currentEntityStats.port);
                        if(!port){ addLog('‚ùå No TLM instance selected for CTL test','error'); return; }
                        runTestFetch(`http://localhost:${port}/api/trust-list/full`);
                    }
                    function testGetDeltaCTL(){
                        const port = getPortFor('TLM') || (window.currentEntityStats && window.currentEntityStats.port);
                        if(!port){ addLog('‚ùå No TLM instance selected for CTL test','error'); return; }
                        runTestFetch(`http://localhost:${port}/api/trust-list/delta`);
                    }
                    function testGetMetrics(){
                        const port = (window.currentEntityStats && window.currentEntityStats.port) || getPortFor('EA') || getPortFor('AA') || getPortFor('TLM');
                        if(!port){ addLog('‚ùå No instance selected for metrics test','error'); return; }
                        runTestFetch(`http://localhost:${port}/api/monitoring/metrics`);
                    }

                    // Documentation link opener: open instance docs if selected, else dashboard docs
                    function openDocs(){
                        const port = (window.currentEntityStats && window.currentEntityStats.port) || document.getElementById('selectedEA')?.value || document.getElementById('selectedAA')?.value;
                        if(port){ window.open(`http://localhost:${port}/api/docs`, '_blank'); }
                        else { window.open('/api/docs', '_blank'); }
                    }
                    </script>

                </body>
                        </p>
                        <pre style="background: #0f172a; padding: 15px; border-radius: 8px; overflow-x: auto; border: 1px solid #334155; margin: 0;">python examples/interactive_pki_tester.py --ea-url http://localhost:5000 --aa-url http://localhost:5020</pre>
                        <p style="margin: 10px 0 0 0; opacity: 0.7; font-size: 0.9em;">
                            ‚Ä¢ Specifica URL custom per EA e AA<br>
                            ‚Ä¢ Utile per test su deployment remoti
                        </p>
                    </div>
                </div>

                <!-- Expected Output Section -->
                <div style="background: #f0fdf4; border: 2px solid #86efac; padding: 25px; border-radius: 12px; margin-top: 30px;">
                    <h3 style="color: #16a34a; margin-top: 0;">‚úÖ Output Atteso</h3>
                    <p style="color: #166534; margin-bottom: 15px; line-height: 1.6;">
                        Quando esegui <code>interactive_pki_tester.py</code>, dovresti vedere:
                    </p>
                    <ul style="color: #166534; line-height: 1.8; margin: 0;">
                        <li><strong>Avvio entities:</strong> Tutte le entities (EA, AA, TLM) si avviano correttamente</li>
                        <li><strong>Menu interattivo:</strong> Lista dei 6 test con numerazione 1-6</li>
                        <li><strong>Test esecuzione:</strong> Ogni test mostra progress real-time con emoji e colori</li>
                        <li><strong>Risultati:</strong> ‚úÖ PASS o ‚ùå FAIL per ogni test</li>
                        <li><strong>Statistiche:</strong> Numero veicoli enrollati, test eseguiti, tempo di risposta</li>
                        <li><strong>Report finale:</strong> Riepilogo con successi/fallimenti totali</li>
                    </ul>
                </div>

            </div>
        </div>

        <!-- Real-Time Metrics View -->
        <div id="view-metrics" class="view-section">
            <div class="panel" style="margin-top: 20px;">
                <h2>üìà Real-Time Metrics</h2>
                <p style="color: #666; margin-bottom: 20px;">Live performance and operational metrics</p>
                
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="label">Certificates Issued</div>
                        <div class="value" id="metric-certs">0</div>
                    </div>
                    <!-- 'Active Certificates' metric removed per request -->
                    <div class="metric-card">
                        <div class="label">Revoked Certificates</div>
                        <div class="value" id="metric-revoked">0</div>
                    </div>
                    <div class="metric-card">
                        <div class="label">API Requests/min</div>
                        <div class="value" id="metric-requests">0</div>
                    </div>
                    <div class="metric-card">
                        <div class="label">Avg Response Time</div>
                        <div class="value" id="metric-response-time">0ms</div>
                    </div>
                    <div class="metric-card">
                        <div class="label">System Uptime</div>
                        <div class="value" id="metric-uptime">0s</div>
                    </div>
                </div>

                <div style="margin-top: 30px; padding: 20px; background: #f9fafb; border-radius: 8px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üìä Metrics Collection</h3>
                    <p style="color: #666; line-height: 1.6;">
                        Real-time metrics are collected from all active PKI entities. Data is aggregated every 5 seconds and displayed here.
                        For detailed metrics analysis, use the Prometheus endpoint: <code style="background: white; padding: 2px 8px; border-radius: 4px; color: #667eea;">/api/monitoring/metrics/prometheus</code>
                    </p>
                </div>
            </div>
        </div>

        <!-- Implemented Features View -->
        <div id="view-features" class="view-section">
            <div class="panel" style="margin-top: 20px;">
                <h2>‚ú® Implemented Features</h2>
                <p style="color: #666; margin-bottom: 20px;">Production-ready PKI implementation with ~90% completion</p>
                
                <div class="feature-grid">
                    <div class="feature-card">
                        <div class="icon">üìú</div>
                        <h4>ETSI TS 102941 Compliance</h4>
                        <p>Full implementation of ETSI security management standards for V2X communications</p>
                        <div class="check">‚úì</div>
                    </div>

                    <div class="feature-card">
                        <div class="icon">üîê</div>
                        <h4>Certificate Management</h4>
                        <p>Complete lifecycle: enrollment, authorization, revocation, renewal with CRL/CTL support</p>
                        <div class="check">‚úì</div>
                    </div>

                    <div class="feature-card">
                        <div class="icon">ü¶ã</div>
                        <h4>Butterfly Key Expansion</h4>
                        <p>Privacy-preserving batch generation of 20 Authorization Tickets with unlinkability</p>
                        <div class="check">‚úì</div>
                    </div>

                    <div class="feature-card">
                        <div class="icon">üì°</div>
                        <h4>REST API (11 Endpoints)</h4>
                        <p>Production-ready APIs with authentication, rate limiting, CORS, and OpenAPI docs</p>
                        <div class="check">‚úì</div>
                    </div>

                    <div class="feature-card">
                        <div class="icon">üîó</div>
                        <h4>Link Certificates</h4>
                        <p>Trust chain building with link certificates between EA and Root CA</p>
                        <div class="check">‚úì</div>
                    </div>

                    <div class="feature-card">
                        <div class="icon">üìã</div>
                        <h4>CRL/CTL Distribution</h4>
                        <p>Full and Delta CRLs, Certificate Trust Lists with automatic updates</p>
                        <div class="check">‚úì</div>
                    </div>

                    <div class="feature-card">
                        <div class="icon">üîí</div>
                        <h4>mTLS Authentication</h4>
                        <p>Mutual TLS for secure inter-authority communication (EA ‚Üî AA)</p>
                        <div class="check">‚úì</div>
                    </div>

                    <div class="feature-card">
                        <div class="icon">üß™</div>
                        <h4>Comprehensive Testing</h4>
                        <p>115 automated tests covering all major functionality and edge cases</p>
                        <div class="check">‚úì</div>
                    </div>

                    <div class="feature-card">
                        <div class="icon">‚ö°</div>
                        <h4>Auto-Setup System</h4>
                        <p>Automated PKI initialization with configurable entities and ports</p>
                        <div class="check">‚úì</div>
                    </div>

                    <div class="feature-card">
                        <div class="icon">üìä</div>
                        <h4>Monitoring & Metrics</h4>
                        <p>Real-time metrics, logging, and Prometheus integration</p>
                        <div class="check">‚úì</div>
                    </div>

                    <div class="feature-card">
                        <div class="icon">üéØ</div>
                        <h4>Rate Limiting</h4>
                        <p>Configurable rate limits per endpoint to prevent abuse</p>
                        <div class="check">‚úì</div>
                    </div>

                    <div class="feature-card">
                        <div class="icon">üìù</div>
                        <h4>ASN.1 OER Encoding</h4>
                        <p>Binary encoding/decoding for ETSI message structures</p>
                        <div class="check">‚úì</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Results View -->
        <div id="view-test-results" class="view-section">
            <div class="panel" style="margin-top: 20px;">
                <h2>üß™ Test Results</h2>
                <p style="color: #666; margin-bottom: 20px;">Latest test execution results from the test suite</p>
                
                <div style="background: #dcfce7; padding: 20px; border-radius: 8px; border-left: 4px solid #10b981; margin-bottom: 20px;">
                    <h3 style="color: #065f46; margin-bottom: 15px;">üìä Test Suite Summary</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="text-align: center;">
                            <div style="font-size: 2em; font-weight: bold; color: #10b981;">115</div>
                            <div style="color: #047857; font-size: 0.9em;">Total Tests</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2em; font-weight: bold; color: #10b981;">115</div>
                            <div style="color: #047857; font-size: 0.9em;">Passed</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2em; font-weight: bold; color: #6b7280;">0</div>
                            <div style="color: #4b5563; font-size: 0.9em;">Failed</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2em; font-weight: bold; color: #10b981;">100%</div>
                            <div style="color: #047857; font-size: 0.9em;">Success Rate</div>
                        </div>
                    </div>
                </div>

                <div style="background: #f9fafb; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="color: #333; margin-bottom: 15px;">üéØ How to Run Tests</h3>
                    <p style="color: #666; margin-bottom: 15px; line-height: 1.6;">
                        To execute the full test suite and see detailed results, run the following command in your terminal:
                    </p>
                    <div style="background: #1f2937; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <code style="color: #10b981; display: block; font-family: 'Courier New', monospace;">python tests/run_all_tests.py</code>
                    </div>
                    <p style="color: #666; font-size: 0.9em; line-height: 1.6;">
                        Test results are automatically saved in the <code style="background: #e5e7eb; padding: 2px 6px; border-radius: 4px;">test_results/</code> directory with detailed logs and assertions.
                    </p>
                </div>

                <div class="test-grid">
                    <div class="test-category">
                        <h4>
                            <span>‚úÖ PKI Entity Tests (25 tests)</span>
                            <span class="test-badge">PASSED</span>
                        </h4>
                        <div class="test-description">
                            Tests root CA, EA, AA initialization and certificate issuance workflows
                        </div>
                    </div>

                    <div class="test-category">
                        <h4>
                            <span>‚úÖ REST API Tests (20 tests)</span>
                            <span class="test-badge">PASSED</span>
                        </h4>
                        <div class="test-description">
                            Validates all 11 endpoints, authentication, rate limiting, and error handling
                        </div>
                    </div>

                    <div class="test-category">
                        <h4>
                            <span>‚úÖ Butterfly Key Expansion (15 tests)</span>
                            <span class="test-badge">PASSED</span>
                        </h4>
                        <div class="test-description">
                            Tests batch AT generation, unlinkability, and privacy preservation
                        </div>
                    </div>

                    <div class="test-category">
                        <h4>
                            <span>‚úÖ ETSI Protocol Compliance (15 tests)</span>
                            <span class="test-badge">PASSED</span>
                        </h4>
                        <div class="test-description">
                            Verifies ASN.1 OER encoding/decoding and ETSI TS 102941 conformance
                        </div>
                    </div>

                    <div class="test-category">
                        <h4>
                            <span>‚úÖ CRL/CTL Management (18 tests)</span>
                            <span class="test-badge">PASSED</span>
                        </h4>
                        <div class="test-description">
                            Tests certificate revocation lists and trust list distribution
                        </div>
                    </div>

                    <div class="test-category">
                        <h4>
                            <span>‚úÖ Link Certificates (12 tests)</span>
                            <span class="test-badge">PASSED</span>
                        </h4>
                        <div class="test-description">
                            Validates EA-RootCA linking and trust chain verification
                        </div>
                    </div>

                    <div class="test-category">
                        <h4>
                            <span>‚úÖ ITS Station Tests (10 tests)</span>
                            <span class="test-badge">PASSED</span>
                        </h4>
                        <div class="test-description">
                            Tests vehicle enrollment, AT requests, and V2X message signing
                        </div>
                    </div>
                </div>

                <div style="background: #eff6ff; padding: 20px; border-radius: 8px; border-left: 4px solid #3b82f6; margin-top: 20px;">
                    <h3 style="color: #1e40af; margin-bottom: 10px;">üìù Test Reports</h3>
                    <p style="color: #1e3a8a; font-size: 0.9em; line-height: 1.6;">
                        Detailed test reports with timestamps, assertions, and failure analysis are available in:
                        <code style="background: white; padding: 2px 8px; border-radius: 4px; color: #3b82f6; display: inline-block; margin-top: 5px;">test_results/test_report_YYYYMMDD_HHMMSS.json</code>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Entity configuration loaded from entity_configs.json
        let CONFIGURED_ENTITIES = null;
        
        // Entity port configuration (fallback if config load fails)
        const ENTITY_PORTS = {
            'EA': Array.from({length: 20}, (_, i) => 5000 + i),
            'AA': Array.from({length: 20}, (_, i) => 5020 + i),
            'TLM': [5050],
            'RootCA': [5999]
        };

        // Track active instances
        let activeInstances = {
            'EA': [],
            'AA': [],
            'TLM': [],
            'RootCA': []
        };

        // System state
        let systemActive = false;
        let scanInterval = null;
        let metricsInterval = null;
        let entityStatsRefreshInterval = null; // For auto-refresh in modal
        let currentEntityStats = null; // Store current entity data for refresh

        // Load entity configuration
        async function loadEntityConfig() {
            try {
                const response = await fetch('entity_configs.json');
                const config = await response.json();
                
                // Parse configured entities from start_commands
                CONFIGURED_ENTITIES = {
                    'RootCA': [],
                    'TLM': [],
                    'EA': [],
                    'AA': []
                };
                
                config.start_commands.forEach(cmd => {
                    const entity = cmd.entity;
                    
                    if (entity === 'ROOT_CA') {
                        CONFIGURED_ENTITIES['RootCA'].push({
                            id: 'RootCA',
                            port: 5999,
                            entity: 'ROOT_CA'
                        });
                    } else if (entity === 'TLM_MAIN') {
                        CONFIGURED_ENTITIES['TLM'].push({
                            id: 'TLM_MAIN',
                            port: 5050,
                            entity: 'TLM_MAIN'
                        });
                    } else if (entity.startsWith('EA_')) {
                        // Extract port from config or use default range
                        const portMatch = cmd.command.match(/--port\s+(\d+)/);
                        const port = portMatch ? parseInt(portMatch[1]) : null;
                        
                        CONFIGURED_ENTITIES['EA'].push({
                            id: entity,
                            port: port || (5000 + CONFIGURED_ENTITIES['EA'].length),
                            entity: entity
                        });
                    } else if (entity.startsWith('AA_')) {
                        const portMatch = cmd.command.match(/--port\s+(\d+)/);
                        const port = portMatch ? parseInt(portMatch[1]) : null;
                        
                        CONFIGURED_ENTITIES['AA'].push({
                            id: entity,
                            port: port || (5020 + CONFIGURED_ENTITIES['AA'].length),
                            entity: entity
                        });
                    }
                });
                
                addLog(`‚úÖ Loaded configuration: ${CONFIGURED_ENTITIES['EA'].length} EA, ${CONFIGURED_ENTITIES['AA'].length} AA`, 'info');
                return true;
            } catch (error) {
                addLog(`‚ö†Ô∏è Failed to load entity_configs.json: ${error.message}. Using port scan fallback.`, 'warning');
                return false;
            }
        }

        // Initialize on load
        window.onload = async function() {
            addLog('‚úÖ Dashboard initialized successfully', 'info');
            
            // Initialize log scroll detection
            initLogScrollDetection();
            
            // Load entity configuration first
            await loadEntityConfig();
            
            scanAllInstances();
            updateMetrics();
            
            // Load entity deletion list
            setTimeout(() => {
                loadEntityDeleteList();
            }, 2000);  // Wait 2s for entities to start
            
            // Auto-refresh every 5 seconds
            scanInterval = setInterval(scanAllInstances, 5000);
            metricsInterval = setInterval(updateMetrics, 10000);
        };

        // View Management
        function showView(viewName) {
            // Hide all views
            document.querySelectorAll('.view-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected view
            document.getElementById(`view-${viewName}`).classList.add('active');
            
            // Update nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');
            
            addLog(`üìÑ Switched to ${viewName} view`, 'info');
        }

        // Scan all instances
        async function scanAllInstances() {
            addLog('üîç Scanning for active instances...', 'info');
            
            const scanPromises = [];
            
            // Use configured entities if available, otherwise fallback to port scanning
            const entitiesToScan = CONFIGURED_ENTITIES || {};
            
            for (const entityType of Object.keys(ENTITY_PORTS)) {
                // Always scan all ports in range for robustness
                const ports = ENTITY_PORTS[entityType];
                
                const entityScanPromise = Promise.all(
                    ports.map(async (port) => {
                        const baseUrl = `http://localhost:${port}`;
                        const isActive = await checkInstanceHealth(baseUrl);
                        
                        if (isActive) {
                            const entityInfo = await getEntityInfo(baseUrl);
                            return {
                                port: port,
                                url: baseUrl,
                                id: entityInfo.id || `${entityType}_${port}`,
                                uptime: entityInfo.uptime || 'N/A'
                            };
                        }
                        return null;
                    })
                ).then(results => ({
                    entityType,
                    activeList: results.filter(r => r !== null)
                }));
                
                scanPromises.push(entityScanPromise);
            }
            
            const allResults = await Promise.all(scanPromises);
            
            // Update displays
            for (const {entityType, activeList} of allResults) {
                activeInstances[entityType] = activeList;
                updateInstanceDisplay(entityType, activeList);
            }
            
            // Update total count and system status
            const totalActive = Object.values(activeInstances).reduce((sum, list) => sum + list.length, 0);
            document.getElementById('activeInstancesTotal').textContent = totalActive;
            
            // Update system status
            const systemStatusEl = document.getElementById('systemStatus');
            const systemStatusCard = document.getElementById('systemStatusCard');
            if (totalActive > 0) {
                systemStatusEl.textContent = 'Active';
                systemStatusCard.className = 'status-card success';
                systemActive = true;
            } else {
                systemStatusEl.textContent = 'Inactive';
                systemStatusCard.className = 'status-card error';
                systemActive = false;
            }
            
            // Update last scan time
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            document.getElementById('lastScanTime').textContent = timeStr;
            
            addLog(`‚úÖ Scan complete: ${totalActive} active instances found`, 'info');
            console.log('[scanAllInstances] Scan complete. activeInstances:', JSON.stringify(activeInstances));
            
            // Auto-update entity delete dropdown (uses same data!)
            if (typeof loadEntityDeleteList === 'function') {
                console.log('[scanAllInstances] Calling loadEntityDeleteList()...');
                loadEntityDeleteList();
            } else {
                console.error('[scanAllInstances] loadEntityDeleteList is not a function!');
            }
        }

        // Check instance health
        async function checkInstanceHealth(baseUrl) {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 2000);
                
                const response = await fetch(`${baseUrl}/health`, {
                    method: 'GET',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                return response.ok;
            } catch (error) {
                return false;
            }
        }

        // Get entity information
        async function getEntityInfo(baseUrl) {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 2000);
                
                const response = await fetch(`${baseUrl}/health`, {
                    method: 'GET',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const data = await response.json();
                    return {
                        id: data.entity_id || data.id || null,
                        uptime: data.uptime || null
                    };
                }
            } catch (error) {
                // Silent fail
            }
            return {};
        }

        // Update instance display
        function updateInstanceDisplay(entityType, instances) {
            const countEl = document.getElementById(`instanceCount-${entityType}`);
            const listEl = document.getElementById(`instanceList-${entityType}`);
            
            if (!countEl || !listEl) return;
            
            countEl.textContent = instances.length;
            
            if (instances.length === 0) {
                listEl.innerHTML = '<div class="instance-item" style="opacity: 0.7;">No active instances</div>';
            } else {
                listEl.innerHTML = instances.map(inst => `
                    <div class="instance-item" onclick="showEntityStats('${entityType}', '${inst.id}', ${inst.port})">
                        <div>
                            <div style="font-weight: bold;">${inst.id}</div>
                            <div style="font-size: 0.85em; opacity: 0.8;">Port ${inst.port}</div>
                        </div>
                        <div style="text-align: right; font-size: 0.85em;">
                            ${inst.uptime || 'N/A'}
                        </div>
                    </div>
                `).join('');
            }
            
            // Update API Tester dropdowns when instances are scanned
            if (entityType === 'EA') {
                updateEADropdown(instances);
            } else if (entityType === 'AA') {
                updateAADropdown(instances);
            }
        }
        
        // Update EA dropdown with active instances
        function updateEADropdown(instances) {
            const dropdown = document.getElementById('selectedEA');
            if (!dropdown) return;
            
            // Save current selection before updating
            const currentSelection = dropdown.value;
            
            if (instances.length === 0) {
                dropdown.innerHTML = '<option value="">‚ùå No EA instances found</option>';
                document.getElementById('eaUrlDisplay').textContent = 'URL: -';
                return;
            }
            
            dropdown.innerHTML = instances.map(inst => 
                `<option value="${inst.port}">${inst.id} - Port ${inst.port}</option>`
            ).join('');
            
            // Restore previous selection if still available, otherwise use first
            const isStillAvailable = instances.some(inst => inst.port == currentSelection);
            if (currentSelection && isStillAvailable) {
                dropdown.value = currentSelection;
            } else {
                dropdown.value = instances[0].port;
            }
            
            updateEAUrl();
        }
        
        // Update AA dropdown with active instances
        function updateAADropdown(instances) {
            const dropdown = document.getElementById('selectedAA');
            if (!dropdown) return;
            
            // Save current selection before updating
            const currentSelection = dropdown.value;
            
            if (instances.length === 0) {
                dropdown.innerHTML = '<option value="">‚ùå No AA instances found</option>';
                document.getElementById('aaUrlDisplay').textContent = 'URL: -';
                return;
            }
            
            dropdown.innerHTML = instances.map(inst => 
                `<option value="${inst.port}">${inst.id} - Port ${inst.port}</option>`
            ).join('');
            
            // Restore previous selection if still available, otherwise use first
            const isStillAvailable = instances.some(inst => inst.port == currentSelection);
            if (currentSelection && isStillAvailable) {
                dropdown.value = currentSelection;
            } else {
                dropdown.value = instances[0].port;
            }
            
            updateAAUrl();
        }
        
        // Update EA URL display
        function updateEAUrl() {
            const dropdown = document.getElementById('selectedEA');
            const display = document.getElementById('eaUrlDisplay');
            
            if (dropdown.value) {
                const url = `http://localhost:${dropdown.value}`;
                display.textContent = `URL: ${url}`;
                addLog(`üìù EA selected: ${url}`, 'info');
            } else {
                display.textContent = 'URL: -';
            }
        }
        
        // Update AA URL display
        function updateAAUrl() {
            const dropdown = document.getElementById('selectedAA');
            const display = document.getElementById('aaUrlDisplay');
            
            if (dropdown.value) {
                const url = `http://localhost:${dropdown.value}`;
                display.textContent = `URL: ${url}`;
                addLog(`üé´ AA selected: ${url}`, 'info');
            } else {
                display.textContent = 'URL: -';
            }
        }
        
        // Refresh entity list (re-scan all instances)
        function refreshEntityList() {
            addLog('üîÑ Refreshing entity list...', 'info');
            scanAllInstances();
        }
        
        // Test selected EA connection
        async function testSelectedEA() {
            const dropdown = document.getElementById('selectedEA');
            if (!dropdown.value) {
                addLog('‚ùå No EA selected!', 'error');
                return;
            }
            
            const url = `http://localhost:${dropdown.value}/health`;
            addLog(`üß™ Testing EA connection: ${url}`, 'info');
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (response.ok) {
                    addLog(`‚úÖ EA is healthy! Entity: ${data.entity_id || 'Unknown'}, Uptime: ${data.uptime || 'N/A'}`, 'success');
                } else {
                    addLog(`‚ö†Ô∏è EA responded but with error: ${response.status}`, 'warning');
                }
            } catch (error) {
                addLog(`‚ùå EA connection failed: ${error.message}`, 'error');
            }
        }
        
        // Test selected AA connection
        async function testSelectedAA() {
            const dropdown = document.getElementById('selectedAA');
            if (!dropdown.value) {
                addLog('‚ùå No AA selected!', 'error');
                return;
            }
            
            const url = `http://localhost:${dropdown.value}/health`;
            addLog(`üß™ Testing AA connection: ${url}`, 'info');
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (response.ok) {
                    addLog(`‚úÖ AA is healthy! Entity: ${data.entity_id || 'Unknown'}, Uptime: ${data.uptime || 'N/A'}`, 'success');
                } else {
                    addLog(`‚ö†Ô∏è AA responded but with error: ${response.status}`, 'warning');
                }
            } catch (error) {
                addLog(`‚ùå AA connection failed: ${error.message}`, 'error');
            }
        }
        
        // ========================================
        // ENTITY MANAGEMENT FUNCTIONS
        // ========================================
        
        // Load entities for deletion dropdown - uses SAME data as Running Instances panel
        async function loadEntityDeleteList() {
            console.log('[loadEntityDeleteList] Function called');
            const dropdown = document.getElementById('entityToDelete');
            
            if (!dropdown) {
                console.error('[loadEntityDeleteList] Dropdown element not found!');
                addLog('‚ùå Error: Entity dropdown not found', 'error');
                return;
            }
            
            console.log('[loadEntityDeleteList] activeInstances:', JSON.stringify(activeInstances));
            
            // Load entity_configs.json to get ALL configured entities
            let configuredEntities = [];
            try {
                const configResponse = await fetch('/entity_configs.json');
                if (configResponse.ok) {
                    const config = await configResponse.json();
                    const startCommands = config.start_commands || [];
                    
                    // Extract EA and AA entities from start_commands
                    configuredEntities = startCommands
                        .filter(cmd => cmd.entity.startsWith('EA_') || cmd.entity.startsWith('AA_'))
                        .map(cmd => {
                            const entityId = cmd.entity;
                            const entityType = entityId.startsWith('EA_') ? 'EA' : 'AA';
                            
                            // Check if this entity is currently active
                            const activeEntity = (activeInstances[entityType] || [])
                                .find(inst => inst.id === entityId);
                            
                            return {
                                id: entityId,
                                type: entityType,
                                port: activeEntity ? activeEntity.port : 'N/A',
                                status: activeEntity ? 'running' : 'stopped'
                            };
                        });
                    
                    console.log(`[loadEntityDeleteList] Loaded ${configuredEntities.length} configured entities`);
                } else {
                    console.error('[loadEntityDeleteList] Failed to load entity_configs.json');
                }
            } catch (error) {
                console.error('[loadEntityDeleteList] Error loading entity_configs.json:', error);
            }
            
            // Fallback: if no configured entities found, use only active instances
            if (configuredEntities.length === 0) {
                console.log('[loadEntityDeleteList] No configured entities, falling back to active instances');
                ['EA', 'AA'].forEach(type => {
                    const instances = activeInstances[type] || [];
                    console.log(`[loadEntityDeleteList] Processing ${type}: ${instances.length} instances`);
                    instances.forEach(instance => {
                        configuredEntities.push({
                            id: instance.id,
                            type: type,
                            port: instance.port,
                            status: 'running'
                        });
                    });
                });
            }
            
            console.log(`[loadEntityDeleteList] Total entities to show: ${configuredEntities.length}`);
            
            // Populate dropdown
            if (configuredEntities.length === 0) {
                dropdown.innerHTML = '<option value="">‚ùå No EA/AA entities configured</option>';
                return;
            }
            
            const sortedEntities = configuredEntities.sort((a, b) => a.id.localeCompare(b.id));
            
            dropdown.innerHTML = '<option value="">-- Select Entity to Delete --</option>' +
                sortedEntities.map(entity => {
                    const statusIcon = entity.status === 'running' ? 'üü¢' : '‚ö™';
                    const portInfo = entity.port !== 'N/A' ? ` - Port ${entity.port}` : '';
                    return `<option value="${entity.id}" data-type="${entity.type}" data-port="${entity.port}">${statusIcon} ${entity.id} (${entity.type})${portInfo}</option>`;
                }).join('');
            
            console.log(`[loadEntityDeleteList] Dropdown populated with ${configuredEntities.length} entities`);
            addLog(`‚úÖ Loaded ${configuredEntities.length} entities (${configuredEntities.filter(e => e.status === 'running').length} active)`, 'success');
        }
        
        // Refresh entity deletion list
        function refreshEntityDeleteList() {
            addLog('üîÑ Refreshing entity list...', 'info');
            loadEntityDeleteList();
        }
        
        // Update entity delete info when selection changes
        document.addEventListener('DOMContentLoaded', function() {
            const dropdown = document.getElementById('entityToDelete');
            const infoDiv = document.getElementById('entityDeleteInfo');
            const pathEl = document.getElementById('entityDataPath');
            
            if (dropdown) {
                dropdown.addEventListener('change', function() {
                    if (this.value) {
                        const entityType = this.options[this.selectedIndex].dataset.type;
                        const entityId = this.value;
                        
                        let dataPath = '';
                        if (entityType === 'EA') {
                            dataPath = `data/ea/${entityId}/`;
                        } else if (entityType === 'AA') {
                            dataPath = `data/aa/${entityId}/`;
                        }
                        
                        pathEl.textContent = dataPath;
                        infoDiv.style.display = 'block';
                    } else {
                        infoDiv.style.display = 'none';
                    }
                });
            }
        });
        
        // Delete entity (NO CONFIRMATION) - kills process too!
        async function confirmDeleteEntity() {
            const dropdown = document.getElementById('entityToDelete');
            const entityId = dropdown.value;
            
            if (!entityId) {
                addLog('‚ùå Please select an entity to delete', 'error');
                return;
            }
            
            const selectedOption = dropdown.options[dropdown.selectedIndex];
            const entityType = selectedOption.dataset.type;
            const entityPort = selectedOption.dataset.port;
            
            // INSTANT DELETION - NO CONFIRMATION
            addLog(`üóëÔ∏è Deleting ${entityId} (${entityType} on port ${entityPort})...`, 'warning');
            
            // Try to delete from management ports (only RootCA and TLM have management API)
            const portsToTry = [5999, 5050];
            let deletionAttempted = false;
            
            for (const port of portsToTry) {
                try {
                    addLog(`  üîç Trying management API on port ${port}...`, 'info');
                    
                    const response = await fetch(`http://localhost:${port}/api/management/entities/${entityId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        addLog(`  ‚ö†Ô∏è Port ${port} responded with status ${response.status}`, 'warning');
                        continue;
                    }
                    
                    const data = await response.json();
                    deletionAttempted = true;
                    
                    if (data.success) {
                        addLog(`‚úÖ Successfully deleted ${entityId}!`, 'success');
                        
                        if (data.process_killed) {
                            addLog(`  ‚úì Killed process (PID: ${data.killed_pid})`, 'success');
                        }
                        if (data.config_removed) {
                            addLog(`  ‚úì Removed from entity_configs.json`, 'success');
                        }
                        if (data.data_removed) {
                            addLog(`  ‚úì Deleted data directory: ${data.data_path}`, 'success');
                        }
                        if (data.rootca_cert_removed) {
                            addLog(`  ‚úì Removed ${data.rootca_certs.length} certificate(s) from RootCA archive`, 'success');
                            data.rootca_certs.forEach(cert => addLog(`    ‚Ä¢ ${cert}`, 'success'));
                        }
                        if (data.errors && data.errors.length > 0) {
                            data.errors.forEach(err => addLog(`  ‚ö†Ô∏è ${err}`, 'warning'));
                        }
                        
                        // Refresh dashboard after 3 seconds (give time for process to die and data deletion)
                        addLog(`üîÑ Refreshing dashboard in 3 seconds...`, 'info');
                        setTimeout(() => {
                            scanAllInstances(); // This will auto-update the delete dropdown too
                            loadEntityDeleteList(); // Explicitly refresh the delete list
                        }, 3000);
                        
                        return;
                    } else {
                        addLog(`‚ùå Failed to delete: ${data.message}`, 'error');
                        if (data.errors) {
                            data.errors.forEach(err => addLog(`  ‚Ä¢ ${err}`, 'error'));
                        }
                        return;
                    }
                } catch (error) {
                    // Try next port silently
                    continue;
                }
            }
            
            if (deletionAttempted) {
                addLog('‚ùå Entity deletion was attempted but failed. Check logs above.', 'error');
            } else {
                addLog('‚ùå Could not connect to management API on any port. Make sure at least one entity (EA, AA, TLM, or RootCA) is running.', 'error');
            }
        }
        
        // Delete ALL EA and AA entities at once (NO CONFIRMATION)
        async function deleteAllEaAa() {
            addLog('üí• Deleting ALL EA and AA entities AND stopping processes...', 'warning');
            
            // Try management ports (only RootCA and TLM have management API)
            const portsToTry = [5999, 5050];
            let deletionAttempted = false;
            
            for (const port of portsToTry) {
                try {
                    addLog(`  üîç Trying management API on port ${port}...`, 'info');
                    
                    const response = await fetch(`http://localhost:${port}/api/management/entities/delete-all-ea-aa`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        addLog(`  ‚ö†Ô∏è Port ${port} responded with status ${response.status}`, 'warning');
                        continue;
                    }
                    
                    const data = await response.json();
                    deletionAttempted = true;
                    
                    if (data.success) {
                        addLog(`‚úÖ Successfully deleted ${data.total} entities and stopped processes!`, 'success');
                        
                        if (data.deleted && data.deleted.length > 0) {
                            addLog(`  ‚úì Removed from config: ${data.deleted.join(', ')}`, 'success');
                        }
                        
                        if (data.data_dirs_deleted && data.data_dirs_deleted.length > 0) {
                            addLog(`  ‚úì Deleted ${data.data_dirs_deleted.length} data directories:`, 'success');
                            data.data_dirs_deleted.forEach(dir => {
                                const shortPath = dir.split(/[/\\]/).slice(-2).join('/');
                                addLog(`    ‚Ä¢ ${shortPath}`, 'success');
                            });
                        }
                        
                        if (data.processes_killed && data.processes_killed.length > 0) {
                            addLog(`  ‚úì Killed ${data.processes_killed.length} Python processes`, 'success');
                            data.processes_killed.forEach(proc => {
                                addLog(`    ‚Ä¢ PID ${proc.pid}: ${proc.cmdline}`, 'success');
                            });
                        }
                        
                        if (data.rootca_certs_removed && data.rootca_certs_removed.length > 0) {
                            addLog(`  ‚úì Removed ${data.rootca_certs_removed.length} certificate(s) from RootCA archive`, 'success');
                            data.rootca_certs_removed.forEach(cert => {
                                addLog(`    ‚Ä¢ ${cert}`, 'success');
                            });
                        }
                        
                        if (data.failed && data.failed.length > 0) {
                            addLog(`  ‚ö†Ô∏è Some data directories could not be deleted:`, 'warning');
                            data.failed.forEach(fail => {
                                addLog(`    ‚Ä¢ ${fail.entity_id}: ${fail.reason}`, 'warning');
                            });
                        }
                        
                        addLog(`üîÑ Dashboard will update in 3 seconds...`, 'info');
                        
                        // Refresh entity list immediately
                        setTimeout(() => {
                            scanAllInstances();
                            loadEntityDeleteList();
                            addLog(`‚úÖ Dashboard updated - all EA/AA removed!`, 'success');
                        }, 3000);
                        
                        return;
                    } else {
                        addLog(`‚ö†Ô∏è ${data.message}`, 'warning');
                        return;
                    }
                } catch (error) {
                    continue;
                }
            }
            
            if (deletionAttempted) {
                addLog('‚ùå Bulk deletion was attempted but failed. Check logs above.', 'error');
            } else {
                addLog('‚ùå Could not connect to management API on any port. Make sure at least one entity (EA, AA, TLM, or RootCA) is running.', 'error');
            }
        }
        
        
        // Show Entity Statistics Modal
        async function showEntityStats(entityType, entityId, port) {
            const modal = document.getElementById('entityStatsModal');
            const title = document.getElementById('statsEntityTitle');
            const subtitle = document.getElementById('statsEntitySubtitle');
            
            // Store current entity for refresh
            currentEntityStats = { entityType, entityId, port };
            
            // Set title based on entity type
            const typeNames = {
                'EA': 'üìù Enrollment Authority',
                'AA': 'üé´ Authorization Authority',
                'ITSS': 'üöó ITS Station',
                'TLM': 'üìã Trust List Manager'
            };
            
            title.textContent = `${typeNames[entityType] || entityType} Statistics`;
            
            // Show modal
            modal.style.display = 'block';
            // Populate contextual action tiles (appearing as stat-box tiles in the metrics grid)
            const actionsContainer = document.getElementById('entityStatsActions');
            actionsContainer.innerHTML = ''; // keep header area clean
            const statsGrid = modal.querySelector('.stats-grid') || document.querySelector('.stats-grid');
            // Remove any previous action tiles
            if (statsGrid) Array.from(statsGrid.querySelectorAll('.stat-action')).forEach(n => n.remove());

            function addActionTile(key, titleText, sublabel, onClick) {
                // key: identifier used by loadEntityStats to update the value
                if (!statsGrid) return null;
                const box = document.createElement('div');
                box.className = 'stat-box stat-action';
                box.dataset.key = key;
                // store the human-friendly title as tooltip, and show a placeholder value until stats load
                box.title = titleText;
                box.innerHTML = `<div class="stat-value">‚Äî</div><div class="stat-label">${sublabel}</div>`;
                box.onclick = onClick;
                statsGrid.appendChild(box);
                return box;
            }

            if (entityType === 'TLM') {
                addActionTile('tlm-enrolled-ea', 'Enrolled EAs', 'View enrolled Enrollment Authorities', () => showTlmEnrolledEa());
                addActionTile('tlm-enrolled-aa', 'Enrolled AAs', 'View enrolled Authorization Authorities', () => showTlmEnrolledAa());
            } else if (entityType === 'RootCA') {
                addActionTile('rootca-subcas', 'Subordinate CAs', 'View Subordinate CAs', () => showRootcaSubCAs());
                addActionTile('rootca-issued', 'Issued Certificates', 'View Issued Certificates', () => showRootcaIssuedCerts());
            }

            // Load initial data
            await loadEntityStats(entityType, entityId, port);
            
            // Setup auto-refresh every 3 seconds
            if (entityStatsRefreshInterval) {
                clearInterval(entityStatsRefreshInterval);
            }
            entityStatsRefreshInterval = setInterval(async () => {
                if (modal.style.display === 'block') {
                    await loadEntityStats(entityType, entityId, port);
                }
            }, 3000);
        }
        
        // Load Entity Statistics (separated for refresh)
        async function loadEntityStats(entityType, entityId, port) {
            console.log(`üîÑ Refreshing stats for ${entityId} at ${new Date().toLocaleTimeString('it-IT')}`);
            
            const subtitle = document.getElementById('statsEntitySubtitle');
            const indicator = document.getElementById('statsRefreshIndicator');
            
            // Show loading indicator
            if (indicator) indicator.style.display = 'inline-block';
            
            // Fetch stats from entity
            try {
                const response = await fetch(`http://localhost:${port}/api/monitoring/metrics`);
                const data = await response.json();
                
                console.log('‚úÖ Entity metrics received:', data);
                
                // Hide loading indicator and update timestamp
                if (indicator) indicator.style.display = 'none';
                const now = new Date();
                const timeStr = now.toLocaleTimeString('it-IT');
                subtitle.innerHTML = `${entityId} - Port ${port} | üîÑ Last update: <strong>${timeStr}</strong>`;
                
                // Add flash animation to stat boxes
                document.querySelectorAll('.stat-box').forEach(box => {
                    box.classList.remove('updating');
                    void box.offsetWidth; // Trigger reflow
                    box.classList.add('updating');
                });
                
                // Update statistics (using data.overall from monitoring_bp.py)
                const overall = data.overall || {};
                const counters = data.counters || {};
                
                document.getElementById('stat-total-requests').textContent = overall.total_requests || 0;
                document.getElementById('stat-success-rate').textContent = 
                    overall.error_rate_percent !== undefined 
                        ? `${(100 - overall.error_rate_percent).toFixed(1)}%` 
                        : 'N/A';
                document.getElementById('stat-response-time').textContent = 
                    overall.avg_latency_ms 
                        ? `${overall.avg_latency_ms.toFixed(0)}ms` 
                        : 'N/A';
                const activeCertsEl = document.getElementById('stat-active-certs');
                if (activeCertsEl) activeCertsEl.textContent = (counters.active_certificates !== undefined) ? counters.active_certificates : 0;
                
                // Health checks (always shown)
                document.getElementById('stat-health-checks').textContent = 
                    (counters.health_checks !== undefined) ? counters.health_checks : 0;
                
                // Show/hide and update counters based on entity type
                const ecBox = document.getElementById('stat-box-ec-issued');
                const atBox = document.getElementById('stat-box-at-issued');
                const activeCertsBox = document.getElementById('stat-box-active-certs');
                
                if (entityType === 'EA') {
                    // Show EC counter and Active Certs for Enrollment Authorities
                    ecBox.style.display = 'block';
                    atBox.style.display = 'none';
                    activeCertsBox.style.display = 'block';
                    // Set labels for EA
                    document.querySelector('#stat-box-ec-issued .stat-label').textContent = 'üìù EC Issued';
                    document.getElementById('stat-ec-issued').textContent = 
                        (counters.enrollment_certificates_issued !== undefined) ? counters.enrollment_certificates_issued : 0;
                } else if (entityType === 'AA') {
                    // Show AT counter and Active Certs for Authorization Authorities
                    ecBox.style.display = 'none';
                    atBox.style.display = 'block';
                    activeCertsBox.style.display = 'block';
                    // Set labels for AA
                    document.querySelector('#stat-box-at-issued .stat-label').textContent = 'üé´ AT Issued';
                    document.getElementById('stat-at-issued').textContent = 
                        (counters.authorization_tickets_issued !== undefined) ? counters.authorization_tickets_issued : 0;
                } else if (entityType === 'TLM') {
                    // Show Trust Anchors for Trust List Manager
                    ecBox.style.display = 'block';
                    atBox.style.display = 'none';
                    activeCertsBox.style.display = 'none';
                    // Set labels for TLM
                    document.querySelector('#stat-box-ec-issued .stat-label').textContent = 'üîê Trust Anchors';
                    // Show Trust Anchors count
                    document.getElementById('stat-ec-issued').textContent = 
                        (counters.trust_anchors !== undefined) ? counters.trust_anchors : 0;
                } else {
                    // Hide all for other entity types
                    ecBox.style.display = 'none';
                    atBox.style.display = 'none';
                    activeCertsBox.style.display = 'none';
                }

                // RootCA and TLM stats (global)
                const rootcaIssuedEl = document.getElementById('stat-rootca-issued');
                const tlmEnrolledEl = document.getElementById('stat-tlm-enrolled');
                if(rootcaIssuedEl) rootcaIssuedEl.textContent = (counters.rootca_issued_certificates !== undefined) ? counters.rootca_issued_certificates : (counters.issued_certificates !== undefined ? counters.issued_certificates : 0);
                if(tlmEnrolledEl) tlmEnrolledEl.textContent = (counters.tlm_enrolled !== undefined) ? counters.tlm_enrolled : (counters.enrolled_entities !== undefined ? counters.enrolled_entities : 0);

                // Update action tiles (show actual server values, keep label in title)
                try {
                    const actionTile = (key) => (statsGrid ? statsGrid.querySelector(`[data-key="${key}"]`) : null);

                    const tlmEaTile = actionTile('tlm-enrolled-ea');
                    if (tlmEaTile) {
                        const val = (counters.tlm_enrolled !== undefined) ? counters.tlm_enrolled : (counters.enrolled_entities !== undefined ? counters.enrolled_entities : 0);
                        const vEl = tlmEaTile.querySelector('.stat-value'); if (vEl) vEl.textContent = val;
                        // keep tooltip as the human-friendly title
                    }

                    const tlmAaTile = actionTile('tlm-enrolled-aa');
                    if (tlmAaTile) {
                        const val = (counters.tlm_enrolled !== undefined) ? counters.tlm_enrolled : (counters.enrolled_entities !== undefined ? counters.enrolled_entities : 0);
                        const vEl = tlmAaTile.querySelector('.stat-value'); if (vEl) vEl.textContent = val;
                    }

                    const rootcaSubTile = actionTile('rootca-subcas');
                    if (rootcaSubTile) {
                        // Number of subordinate CAs isn't always available in metrics; fallback to rootca_issued_certificates count
                        const val = (counters.subordinate_cas !== undefined) ? counters.subordinate_cas : (counters.rootca_issued_certificates !== undefined ? counters.rootca_issued_certificates : 0);
                        const vEl = rootcaSubTile.querySelector('.stat-value'); if (vEl) vEl.textContent = val;
                    }

                    const rootcaIssuedTile = actionTile('rootca-issued');
                    if (rootcaIssuedTile) {
                        const val = (counters.rootca_issued_certificates !== undefined) ? counters.rootca_issued_certificates : (counters.issued_certificates !== undefined ? counters.issued_certificates : 0);
                        const vEl = rootcaIssuedTile.querySelector('.stat-value'); if (vEl) vEl.textContent = val;
                    }
                } catch (e) {
                    console.debug('Could not update action tiles:', e);
                }
                
                // Update endpoints table
                const endpointsTable = document.getElementById('stats-endpoints-table');
                if (data.endpoints && Object.keys(data.endpoints).length > 0) {
                    endpointsTable.innerHTML = Object.entries(data.endpoints).map(([endpoint, stats]) => `
                        <tr>
                            <td><code>${endpoint}</code></td>
                            <td>${stats.count || 0}</td>
                            <td style="color: #10b981;">${stats.success_count || 0}</td>
                            <td style="color: #ef4444;">${stats.error_count || 0}</td>
                            <td>${stats.avg_latency_ms ? stats.avg_latency_ms.toFixed(0) + 'ms' : 'N/A'}</td>
                        </tr>
                    `).join('');
                } else {
                    endpointsTable.innerHTML = '<tr><td colspan="5" style="text-align: center; opacity: 0.7;">No endpoint data available yet</td></tr>';
                }
                
                // Update recent activity (note: actual endpoint doesn't return recent_requests, we'll use last_5_minutes data)
                const activityDiv = document.getElementById('stats-recent-activity');
                const last5min = data.last_5_minutes || {};
                activityDiv.innerHTML = `
                    <div style="padding: 15px; background: rgba(255,255,255,0.1); border-radius: 5px;">
                        <h4 style="margin-top: 0;">Last 5 Minutes Activity</h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div>
                                <div style="font-size: 1.5em; font-weight: bold;">${last5min.total_requests || 0}</div>
                                <div style="opacity: 0.8;">Requests</div>
                            </div>
                            <div>
                                <div style="font-size: 1.5em; font-weight: bold;">${last5min.error_rate_percent ? last5min.error_rate_percent.toFixed(1) + '%' : 'N/A'}</div>
                                <div style="opacity: 0.8;">Error Rate</div>
                            </div>
                            <div>
                                <div style="font-size: 1.5em; font-weight: bold;">${last5min.avg_latency_ms ? last5min.avg_latency_ms.toFixed(0) + 'ms' : 'N/A'}</div>
                                <div style="opacity: 0.8;">Avg Latency</div>
                            </div>
                            <div>
                                <div style="font-size: 1.5em; font-weight: bold;">${last5min.requests_per_second ? last5min.requests_per_second.toFixed(2) : 'N/A'}</div>
                                <div style="opacity: 0.8;">Req/sec</div>
                            </div>
                        </div>
                        ${data.status_codes && Object.keys(data.status_codes).length > 0 ? `
                            <div style="margin-top: 15px;">
                                <h4>Status Codes Distribution</h4>
                                ${Object.entries(data.status_codes).map(([code, count]) => `
                                    <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                        <span style="color: ${code < 400 ? '#10b981' : '#ef4444'};">HTTP ${code}</span>
                                        <span>${count} requests</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
                
                // Format uptime
                const uptimeSeconds = data.uptime_seconds || 0;
                const hours = Math.floor(uptimeSeconds / 3600);
                const minutes = Math.floor((uptimeSeconds % 3600) / 60);
                const seconds = Math.floor(uptimeSeconds % 60);
                const uptimeStr = `${hours}h ${minutes}m ${seconds}s`;
                
                console.log(`‚è±Ô∏è Uptime: ${uptimeSeconds}s = ${uptimeStr}`);
                
                // Update entity info
                const infoTable = document.getElementById('stats-entity-info');
                infoTable.innerHTML = `
                    <tr><td><strong>Entity ID</strong></td><td>${entityId}</td></tr>
                    <tr><td><strong>Entity Type</strong></td><td>${entityType}</td></tr>
                    <tr><td><strong>Port</strong></td><td>${port}</td></tr>
                    <tr><td><strong>Status</strong></td><td><span style="color: #10b981;">‚óè</span> ${data.status || 'Online'}</td></tr>
                    <tr><td><strong>Uptime</strong></td><td>${uptimeStr}</td></tr>
                    <tr><td><strong>Total Requests</strong></td><td>${overall.total_requests || 0}</td></tr>
                    <tr><td><strong>Success Rate</strong></td><td>${overall.error_rate_percent !== undefined ? (100 - overall.error_rate_percent).toFixed(1) + '%' : 'N/A'}</td></tr>
                    <tr><td><strong>Min/Max Latency</strong></td><td>${overall.min_latency_ms ? overall.min_latency_ms.toFixed(0) : 'N/A'}ms / ${overall.max_latency_ms ? overall.max_latency_ms.toFixed(0) : 'N/A'}ms</td></tr>
                    <tr><td><strong>Req/sec</strong></td><td>${overall.requests_per_second ? overall.requests_per_second.toFixed(2) : 'N/A'}</td></tr>
                `;
                
            } catch (error) {
                console.error('Failed to fetch entity stats:', error);
                
                // Hide loading indicator
                const indicator = document.getElementById('statsRefreshIndicator');
                if (indicator) indicator.style.display = 'none';
                
                // Update subtitle with error
                const subtitle = document.getElementById('statsEntitySubtitle');
                const now = new Date();
                const timeStr = now.toLocaleTimeString('it-IT');
                subtitle.innerHTML = `${entityId} - Port ${port} | ‚ùå Last update: <strong>${timeStr}</strong> (Error)`;
                
                // Show error message
                document.getElementById('stat-total-requests').textContent = 'Error';
                document.getElementById('stat-success-rate').textContent = 'N/A';
                document.getElementById('stat-response-time').textContent = 'N/A';
                const activeCertsEl2 = document.getElementById('stat-active-certs');
                if (activeCertsEl2) activeCertsEl2.textContent = 'N/A';
                document.getElementById('stat-health-checks').textContent = 'N/A';
                document.getElementById('stat-ec-issued').textContent = 'N/A';
                document.getElementById('stat-at-issued').textContent = 'N/A';
                
                document.getElementById('stats-endpoints-table').innerHTML = 
                    '<tr><td colspan="5" style="text-align: center; color: #ef4444;">Failed to load statistics</td></tr>';
                
                document.getElementById('stats-recent-activity').innerHTML = 
                    '<div style="opacity: 0.7; text-align: center; padding: 20px; color: #ef4444;">Failed to load activity data</div>';
                
                document.getElementById('stats-entity-info').innerHTML = `
                    <tr><td><strong>Entity ID</strong></td><td>${entityId}</td></tr>
                    <tr><td><strong>Entity Type</strong></td><td>${entityType}</td></tr>
                    <tr><td><strong>Port</strong></td><td>${port}</td></tr>
                    <tr><td><strong>Status</strong></td><td><span style="color: #ef4444;">‚óè</span> Connection Failed</td></tr>
                `;
            }
        }
        
        // Close Entity Statistics Modal
        function closeEntityStats() {
            const modal = document.getElementById('entityStatsModal');
            modal.style.display = 'none';
            
            // Stop auto-refresh
            if (entityStatsRefreshInterval) {
                clearInterval(entityStatsRefreshInterval);
                entityStatsRefreshInterval = null;
            }
            currentEntityStats = null;
        }
        
        // Close modal on outside click
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('entityStatsModal');
            if (event.target === modal) {
                closeEntityStats();
            }
        });

        // Update metrics
        async function updateMetrics() {
            if (!systemActive) return;

            try {
                // Aggregate real metrics from all active entities
                let totalCerts = 0;
                let totalActiveCerts = 0;
                let totalRevoked = 0;
                let totalRequests = 0;
                let avgResponseTime = 0;
                let responseTimeCount = 0;

                // Collect data from all active entities
                for (const entityType of Object.keys(activeInstances)) {
                    for (const instance of activeInstances[entityType]) {
                        try {
                            const response = await fetch(`http://localhost:${instance.port}/api/monitoring/metrics`);
                            const data = await response.json();
                            const counters = data.counters || {};

                            if (entityType === 'EA') {
                                totalCerts += counters.enrollment_certificates_issued || 0;
                                totalActiveCerts += counters.active_certificates || 0;
                                totalRevoked += (counters.enrollment_certificates_issued || 0) - (counters.active_certificates || 0);
                            } else if (entityType === 'AA') {
                                totalCerts += counters.authorization_tickets_issued || 0;
                                totalActiveCerts += counters.active_certificates || 0;
                                totalRevoked += (counters.authorization_tickets_issued || 0) - (counters.active_certificates || 0);
                            }

                            totalRequests += (counters.total_requests || 0) + (counters.health_checks || 0);

                            // Collect response time data
                            const overall = data.overall || {};
                            if (overall.avg_latency_ms) {
                                avgResponseTime += overall.avg_latency_ms;
                                responseTimeCount++;
                            }
                        } catch (e) {
                            console.warn(`Failed to fetch metrics from ${entityType} on port ${instance.port}:`, e);
                        }
                    }
                }

                // Update dashboard with real data
                document.getElementById('metric-certs').textContent = totalCerts;
                document.getElementById('metric-active-certs').textContent = totalActiveCerts;
                document.getElementById('metric-revoked').textContent = totalRevoked;
                document.getElementById('metric-requests').textContent = totalRequests;
                document.getElementById('metric-response-time').textContent =
                    responseTimeCount > 0 ? `${(avgResponseTime / responseTimeCount).toFixed(0)}ms` : 'N/A';

                // Calculate uptime (from first entity or system start)
                const uptime = Math.floor((Date.now() / 1000) % 86400);
                const hours = Math.floor(uptime / 3600);
                const minutes = Math.floor((uptime % 3600) / 60);
                document.getElementById('metric-uptime').textContent = `${hours}h ${minutes}m`;

            } catch (error) {
                console.error('Error updating metrics:', error);
                // Fallback to showing zeros
                document.getElementById('metric-certs').textContent = '0';
                document.getElementById('metric-active-certs').textContent = '0';
                document.getElementById('metric-revoked').textContent = '0';
                document.getElementById('metric-requests').textContent = '0';
                document.getElementById('metric-response-time').textContent = 'N/A';
                document.getElementById('metric-uptime').textContent = 'N/A';
            }
        }

        // Track if user has manually scrolled the log viewer
        let userHasScrolled = false;
        let logScrollTimeout = null;

        // Add log entry
        function addLog(message, type = 'info') {
            const logViewer = document.getElementById('logViewer');
            const timestamp = new Date().toLocaleTimeString();
            const typeUpper = type.toUpperCase();
            const logLine = document.createElement('div');
            logLine.className = `log-line ${type}`;
            logLine.textContent = `[${timestamp}] [${typeUpper}] ${message}`;
            logViewer.appendChild(logLine);
            
            // Keep only last 50 lines
            while (logViewer.children.length > 50) {
                logViewer.removeChild(logViewer.firstChild);
            }
            
            // Auto-scroll to bottom ONLY if user hasn't manually scrolled
            if (!userHasScrolled) {
                logViewer.scrollTop = logViewer.scrollHeight;
            }
        }
        
        // Detect manual scroll by user
        function initLogScrollDetection() {
            const logViewer = document.getElementById('logViewer');
            const indicator = document.getElementById('autoScrollIndicator');
            
            logViewer.addEventListener('scroll', function() {
                // Check if user scrolled away from bottom (tolerance: 50px)
                const isAtBottom = (logViewer.scrollHeight - logViewer.scrollTop - logViewer.clientHeight) < 50;
                
                if (!isAtBottom) {
                    // User scrolled up - disable auto-scroll
                    userHasScrolled = true;
                    indicator.style.background = '#ef4444';
                    indicator.innerHTML = '<span>‚è∏Ô∏è</span><span>Auto-scroll OFF</span>';
                } else {
                    // User scrolled back to bottom - re-enable auto-scroll
                    userHasScrolled = false;
                    indicator.style.background = '#10b981';
                    indicator.innerHTML = '<span>üîÑ</span><span>Auto-scroll ON</span>';
                }
            });
        }

        // ============================================
        // BULK ENTITY GENERATOR FUNCTIONS
        // ============================================

        // Global variable to store entity generation config
        let pendingEntityConfig = {
            num_ea: 0,
            num_aa: 0,
            ea_names: [],
            aa_names: []
        };

        // Show Entity Generator Form
        function showEntityGeneratorForm() {
            const modalContent = `
                <h3 style="color: #667eea; margin-bottom: 20px;">üèóÔ∏è Bulk Entity Generator</h3>
                
                <form id="entityGeneratorForm">
                    <!-- EA Section -->
                    <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #10b981;">
                        <h4 style="color: #10b981; margin-bottom: 10px;">üìù Enrollment Authorities (EA)</h4>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Number of EAs (0-20):</label>
                        <input type="number" id="num_ea" min="0" max="20" value="0" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px;" onchange="updateEntityNameFields()">
                        <div id="ea_names_container"></div>
                    </div>
                    
                    <!-- AA Section -->
                    <div style="background: #eff6ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #3b82f6;">
                        <h4 style="color: #3b82f6; margin-bottom: 10px;">üé´ Authorization Authorities (AA)</h4>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Number of AAs (0-20):</label>
                        <input type="number" id="num_aa" min="0" max="20" value="0" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px;" onchange="updateEntityNameFields()">
                        <div id="aa_names_container"></div>
                    </div>
                    
                    <!-- TLM Info -->
                    <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #f59e0b;">
                        <h4 style="color: #f59e0b; margin-bottom: 10px;">üìã Trust List Manager (TLM)</h4>
                        <p style="color: #92400e; font-size: 0.9em; font-style: italic;">
                            ‚úÖ TLM_MAIN is automatically included (created if doesn't exist).
                        </p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button type="button" onclick="closeEntityGeneratorModal()" style="padding: 12px; border: none; border-radius: 8px; cursor: pointer; background: #e5e7eb; font-weight: bold;">
                            ‚ùå Cancel
                        </button>
                        <button type="submit" style="padding: 12px; border: none; border-radius: 8px; cursor: pointer; background: #667eea; color: white; font-weight: bold;">
                            ‚úÖ Generate
                        </button>
                    </div>
                </form>
            `;
            
            let modal = document.getElementById('entityGeneratorModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'entityGeneratorModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.7);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;
                
                const modalContainer = document.createElement('div');
                modalContainer.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    padding: 30px;
                    max-width: 700px;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
                `;
                modalContainer.id = 'entityGeneratorModalBody';
                
                modal.appendChild(modalContainer);
                document.body.appendChild(modal);
            }
            
            document.getElementById('entityGeneratorModalBody').innerHTML = modalContent;
            
            document.getElementById('entityGeneratorForm').addEventListener('submit', function(e) {
                e.preventDefault();
                generateEntitiesWithNames();
            });
        }

        // Update entity name fields
        function updateEntityNameFields() {
            const num_ea = parseInt(document.getElementById('num_ea').value) || 0;
            const num_aa = parseInt(document.getElementById('num_aa').value) || 0;
            
            // Save existing values before recreating fields
            const existingEaValues = [];
            const existingAaValues = [];
            
            // Collect existing EA values
            for (let i = 0; i < 20; i++) { // Check up to 20 possible fields
                const input = document.getElementById(`ea_name_${i}`);
                if (input) {
                    existingEaValues[i] = input.value || '';
                }
            }
            
            // Collect existing AA values
            for (let i = 0; i < 20; i++) { // Check up to 20 possible fields
                const input = document.getElementById(`aa_name_${i}`);
                if (input) {
                    existingAaValues[i] = input.value || '';
                }
            }
            
            const eaContainer = document.getElementById('ea_names_container');
            eaContainer.innerHTML = '';
            if (num_ea > 0) {
                eaContainer.innerHTML = '<label style="display: block; margin-top: 10px; margin-bottom: 5px; font-weight: bold; color: #059669;">Entity Names (optional):</label>';
                for (let i = 0; i < num_ea; i++) {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.id = `ea_name_${i}`;
                    input.placeholder = `EA name ${i+1} (e.g., EA_HIGHWAY_01)`;
                    input.style.cssText = 'width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #10b981; border-radius: 5px;';
                    // Restore previous value if it exists
                    if (existingEaValues[i]) {
                        input.value = existingEaValues[i];
                    }
                    eaContainer.appendChild(input);
                }
            }
            
            const aaContainer = document.getElementById('aa_names_container');
            aaContainer.innerHTML = '';
            if (num_aa > 0) {
                aaContainer.innerHTML = '<label style="display: block; margin-top: 10px; margin-bottom: 5px; font-weight: bold; color: #2563eb;">Entity Names (optional):</label>';
                for (let i = 0; i < num_aa; i++) {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.id = `aa_name_${i}`;
                    input.placeholder = `AA name ${i+1} (e.g., AA_TRAFFIC)`;
                    input.style.cssText = 'width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #3b82f6; border-radius: 5px;';
                    // Restore previous value if it exists
                    if (existingAaValues[i]) {
                        input.value = existingAaValues[i];
                    }
                    aaContainer.appendChild(input);
                }
            }
        }

        // Close modal
        function closeEntityGeneratorModal() {
            const modal = document.getElementById('entityGeneratorModal');
            if (modal) {
                modal.remove();
            }
        }

        // Generate entities with names
        async function generateEntitiesWithNames() {
            const num_ea = parseInt(document.getElementById('num_ea').value) || 0;
            const num_aa = parseInt(document.getElementById('num_aa').value) || 0;
            
            if (num_ea === 0 && num_aa === 0) {
                alert('‚ö†Ô∏è Please specify at least one entity type!');
                return;
            }
            
            const ea_names = [];
            const aa_names = [];
            
            for (let i = 0; i < num_ea; i++) {
                const nameInput = document.getElementById(`ea_name_${i}`);
                const name = nameInput ? nameInput.value.trim() : '';
                if (name && !name.startsWith('EA_')) {
                    alert(`‚ö†Ô∏è EA name "${name}" must start with "EA_"`);
                    return;
                }
                ea_names.push(name);
            }
            
            for (let i = 0; i < num_aa; i++) {
                const nameInput = document.getElementById(`aa_name_${i}`);
                const name = nameInput ? nameInput.value.trim() : '';
                if (name && !name.startsWith('AA_')) {
                    alert(`‚ö†Ô∏è AA name "${name}" must start with "AA_"`);
                    return;
                }
                aa_names.push(name);
            }
            
            closeEntityGeneratorModal();
            
            // Save config globally for START NOW button
            pendingEntityConfig = {
                num_ea: num_ea,
                num_aa: num_aa,
                ea_names: ea_names.filter(n => n.length > 0),
                aa_names: aa_names.filter(n => n.length > 0)
            };
            
            addLog(`Generating ${num_ea} EAs, ${num_aa} AAs + TLM (auto)...`, 'info');
            
            // Build direct CLI command string (copy/paste into terminal)
            let command = 'python setup.py';
            if (num_ea > 0) command += ` --ea ${num_ea}`;
            if (num_aa > 0) command += ` --aa ${num_aa}`;
            const customEaNames = ea_names.filter(n => n.length > 0);
            const customAaNames = aa_names.filter(n => n.length > 0);
            if (customEaNames.length > 0) command += ` --ea-names "${customEaNames.join(',')}"`;
            if (customAaNames.length > 0) command += ` --aa-names "${customAaNames.join(',')}"`;

            // Keep pendingEntityConfig for START NOW behavior
            pendingEntityConfig = {
                num_ea: num_ea,
                num_aa: num_aa,
                ea_names: customEaNames,
                aa_names: customAaNames
            };

            // Copy the CLI command to clipboard for user convenience
            copyCommandToClipboard(command);

            showGeneratedEntitiesInstructions(command, num_ea, num_aa, ea_names, aa_names);

            addLog('‚úÖ Entity generation configured! Command copied to clipboard.', 'info');
        }

        // Show instructions
        function showGeneratedEntitiesInstructions(command, num_ea, num_aa, ea_names = [], aa_names = []) {
                    const modalContent = `
                        <h3 style="color: #667eea; margin-bottom: 20px;">üöÄ Entity Generation</h3>

                        <div style="background: #1f2937; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <p style="color: #60a5fa; margin-bottom: 10px;"><strong>PowerShell / CLI Command:</strong></p>
                            <code id="cliCommandBlock" style="color: #60a5fa; display: block; padding: 10px; background: #111827; border-radius: 5px; cursor: pointer; user-select: all; word-wrap: break-word; white-space: pre-wrap;" onclick="copyCommandToClipboard(this.textContent)">${command}</code>
                            <p style="color: #9ca3af; font-size: 0.85em; margin-top: 5px;">Click to copy</p>
                            <div style="display:flex;gap:10px;margin-top:10px;">
                                <button onclick="copyCommandToClipboard('${command}')" style="padding: 10px; border: none; border-radius: 8px; cursor: pointer; background: #6366f1; color: white; font-weight: bold;">
                                    üìã Copy Command
                                </button>
                                <button onclick="executeSetupDirectly()" style="padding: 10px; border: none; border-radius: 8px; cursor: pointer; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; font-weight: bold;">
                                    ‚ñ∂Ô∏è START NOW
                                </button>
                            </div>
                        </div>

                        <button onclick="closeInstructionsModal()" style="width: 100%; padding: 12px; border: none; border-radius: 8px; cursor: pointer; background: #e5e7eb; color: #374151; font-weight: bold;">
                            ‚úÖ Close
                        </button>
                    `;
            
            const modal = document.createElement('div');
            modal.id = 'instructionsModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            const modalContainer = document.createElement('div');
            modalContainer.style.cssText = `
                background: white;
                border-radius: 12px;
                padding: 30px;
                max-width: 700px;
                max-height: 90vh;
                overflow-y: auto;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            `;
            modalContainer.innerHTML = modalContent;
            
            modal.appendChild(modalContainer);
            document.body.appendChild(modal);
        }

        // Execute setup.py directly via API
        async function executeSetupDirectly() {
            // Use global config - with validation
            if (!pendingEntityConfig || (!pendingEntityConfig.num_ea && !pendingEntityConfig.num_aa)) {
                addLog('‚ùå No entity configuration found. Please configure entities first.', 'error');
                return;
            }
            
            const { num_ea, num_aa, ea_names, aa_names } = pendingEntityConfig;
            
            addLog(`üöÄ Creating ${num_ea} EA and ${num_aa} AA entities...`, 'info');
            
            const requestBody = {
                num_ea: num_ea || 0,
                num_aa: num_aa || 0,
                ea_names: ea_names || [],
                aa_names: aa_names || [],
                auto_start: false  // Don't auto-start yet, we'll start them ourselves
            };
            
            // Try multiple ports to find an active entity
            const portsToTry = [5000, 5001, 5020, 5021, 5999, 5050];
            let setupAttempted = false;
            
            for (const port of portsToTry) {
                try {
                    addLog(`  üîç Trying setup API on port ${port}...`, 'info');
                    
                    // Step 1: Create entities via setup.py
                    const setupResponse = await fetch(`http://localhost:${port}/api/management/setup`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });
                    
                    if (!setupResponse.ok) {
                        addLog(`  ‚ö†Ô∏è Port ${port} responded with status ${setupResponse.status}`, 'warning');
                        continue;
                    }
                    
                    const setupData = await setupResponse.json();
                    setupAttempted = true;
                    
                    if (setupData.success) {
                        addLog(`‚úÖ Entities created successfully!`, 'success');
                        
                        // Extract entity IDs from output
                        const createdEntities = [];
                        if (ea_names && ea_names.length > 0) {
                            createdEntities.push(...ea_names);
                        } else {
                            for (let i = 0; i < num_ea; i++) {
                                createdEntities.push(`EA_${String(i+1).padStart(3, '0')}`);
                            }
                        }
                        if (aa_names && aa_names.length > 0) {
                            createdEntities.push(...aa_names);
                        } else {
                            for (let i = 0; i < num_aa; i++) {
                                createdEntities.push(`AA_${String(i+1).padStart(3, '0')}`);
                            }
                        }
                        
                        addLog(`üöÄ Starting ${createdEntities.length} entities in background...`, 'info');
                        
                        // Step 2: Start entities in background
                        const startResponse = await fetch(`http://localhost:${port}/api/management/start-entities`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ entities: createdEntities })
                        });
                        
                        const startData = await startResponse.json();
                        
                        if (startData.success && startData.started) {
                            addLog(`‚úÖ Successfully started ${startData.started.length} entities!`, 'success');
                            startData.started.forEach(s => {
                                addLog(`  ‚úì ${s.entity} started`, 'success');
                            });
                        } else {
                            addLog(`‚ö†Ô∏è Some entities could not be started`, 'warning');
                        }
                        
                        if (startData.failed && startData.failed.length > 0) {
                            addLog(`  ‚ö†Ô∏è Failed to start:`, 'warning');
                            startData.failed.forEach(fail => {
                                addLog(`    ‚Ä¢ ${fail.entity}: ${fail.reason}`, 'warning');
                            });
                        }
                        
                        // Close modals and refresh
                        closeInstructionsModal();
                        closeEntityGeneratorModal();
                        
                        addLog(`üîÑ Refreshing dashboard in 5 seconds...`, 'info');
                        setTimeout(() => {
                            scanAllInstances();
                            loadEntityDeleteList();
                            addLog(`‚úÖ Dashboard updated!`, 'success');
                        }, 5000);

                        
                        return;
                    } else {
                        addLog(`‚ùå Setup failed: ${setupData.message}`, 'error');
                        
                        if (setupData.stderr) {
                            addLog(`  Error: ${setupData.stderr.substring(0, 200)}`, 'error');
                        }
                        
                        return;
                    }
                } catch (error) {
                    // Try next port
                    continue;
                }
            }
            
            if (setupAttempted) {
                addLog('‚ùå Entity setup was attempted but failed. Check logs above.', 'error');
            } else {
                addLog('‚ùå Could not connect to management API on any port. Make sure at least one entity (EA, AA, TLM, or RootCA) is running.', 'error');
            }
        }

        function copyCommandToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                addLog('üìã Command copied to clipboard!', 'info');
            });
        }

        // (Removed JSON copy helper; dashboard now copies CLI command directly)

        function closeInstructionsModal() {
            const modal = document.getElementById('instructionsModal');
            if (modal) {
                modal.remove();
            }
        }

        // ============================================
        // TLM & ROOTCA DETAIL FUNCTIONS
        // ============================================
        
        // Show enrolled EA details from TLM
        function showTlmEnrolledEa() {
            const port = (window.currentEntityStats && window.currentEntityStats.port) || 5050;
            openEntityModal('Enrolled EA - Enrollment Certificates (ECs)', 'Loading enrolled EA ECs...');
            
            fetch(`http://localhost:${port}/api/trust-list/full`)
            .then(r => {
                if (!r.ok) throw new Error('Endpoint returned ' + r.status);
                return r.json();
            })
            .then(data => {
                const anchors = (data && Array.isArray(data.trust_anchors)) ? data.trust_anchors : [];
                const eas = anchors.filter(a => (a.authority_type || '').toUpperCase() === 'EA');
                
                if (eas.length === 0) {
                    openEntityModal('Enrolled EA - Enrollment Certificates (ECs)', '<div>No enrolled EA entries found in CTL.</div>');
                    return;
                }
                
                const html = eas.map((e, i) => {
                    const subject = escapeHtml(e.subject || e.subject_name || e.authority_id || 'Unknown');
                    const certId = escapeHtml(e.cert_id || e.certId || '');
                    const ski = e.ski ? escapeHtml(String(e.ski).slice(0, 24) + (String(e.ski).length > 24 ? '...' : '')) : 'N/A';
                    const expiry = e.expiry ? escapeHtml((e.expiry || '').slice(0, 19).replace('T', ' ')) : 'N/A';
                    const added = e.added ? escapeHtml(String(e.added).replace('T', ' ').slice(0, 19)) : '';
                    
                    return `<div style="padding: 8px 0; border-bottom: 1px solid #eee;">
                                <div style="font-weight: 700;">${i + 1}. ${subject}</div>
                                <div style="color: #444; margin-top: 6px;">
                                    ${certId ? `<span style="margin-right: 10px;">ID: ${certId}</span>` : ''}
                                    <span style="margin-right: 10px;">SKI: ${ski}</span>
                                    <span>Expiry: ${expiry}</span>
                                </div>
                                ${added ? `<div style="color: #777; margin-top: 6px; font-size: 0.9em;">Added: ${added}</div>` : ''}
                            </div>`;
                }).join('');
                
                openEntityModal('Enrolled EA - Enrollment Certificates (ECs)', html);
            })
            .catch(err => {
                console.error('Error fetching TLM EA data:', err);
                openEntityModal('Enrolled EA - Enrollment Certificates (ECs)', '<div style="color: #ef4444;">Error loading EA data: ' + err.message + '</div>');
            });
        }
        
        // Show enrolled AA details from TLM
        function showTlmEnrolledAa() {
            const port = (window.currentEntityStats && window.currentEntityStats.port) || 5050;
            openEntityModal('Enrolled AA - Authorization Tickets (ATs)', 'Loading enrolled AA ATs...');
            
            fetch(`http://localhost:${port}/api/trust-list/full`)
            .then(r => {
                if (!r.ok) throw new Error('Endpoint returned ' + r.status);
                return r.json();
            })
            .then(data => {
                const anchors = (data && Array.isArray(data.trust_anchors)) ? data.trust_anchors : [];
                const aas = anchors.filter(a => (a.authority_type || '').toUpperCase() === 'AA');
                
                if (aas.length === 0) {
                    openEntityModal('Enrolled AA - Authorization Tickets (ATs)', '<div>No enrolled AA entries found in CTL.</div>');
                    return;
                }
                
                const html = aas.map((e, i) => {
                    const subject = escapeHtml(e.subject || e.subject_name || e.authority_id || 'Unknown');
                    const certId = escapeHtml(e.cert_id || e.certId || '');
                    const ski = e.ski ? escapeHtml(String(e.ski).slice(0, 24) + (String(e.ski).length > 24 ? '...' : '')) : 'N/A';
                    const expiry = e.expiry ? escapeHtml((e.expiry || '').slice(0, 19).replace('T', ' ')) : 'N/A';
                    const added = e.added ? escapeHtml(String(e.added).replace('T', ' ').slice(0, 19)) : '';
                    
                    return `<div style="padding: 8px 0; border-bottom: 1px solid #eee;">
                                <div style="font-weight: 700;">${i + 1}. ${subject}</div>
                                <div style="color: #444; margin-top: 6px;">
                                    ${certId ? `<span style="margin-right: 10px;">ID: ${certId}</span>` : ''}
                                    <span style="margin-right: 10px;">SKI: ${ski}</span>
                                    <span>Expiry: ${expiry}</span>
                                </div>
                                ${added ? `<div style="color: #777; margin-top: 6px; font-size: 0.9em;">Added: ${added}</div>` : ''}
                            </div>`;
                }).join('');
                
                openEntityModal('Enrolled AA - Authorization Tickets (ATs)', html);
            })
            .catch(err => {
                console.error('Error fetching TLM AA data:', err);
                openEntityModal('Enrolled AA - Authorization Tickets (ATs)', '<div style="color: #ef4444;">Error loading AA data: ' + err.message + '</div>');
            });
        }
        
        // Show RootCA subordinate CAs
        function showRootcaSubCAs() {
            const port = (window.currentEntityStats && window.currentEntityStats.port) || 5999;
            openEntityModal('Root CA - Subordinate CAs', 'Loading Sub CAs...');
            
            fetch(`http://localhost:${port}/api/rootca/subcas`)
            .then(r => {
                if (!r.ok) throw new Error('Endpoint returned ' + r.status);
                return r.json();
            })
            .then(data => {
                if (!Array.isArray(data) || data.length === 0) {
                    openEntityModal('Root CA - Subordinate CAs', '<div>No subordinate CAs found.</div>');
                    return;
                }
                
                const html = data.map((s, i) => 
                    `<div style="padding: 6px 0; border-bottom: 1px solid #eee;">
                        <strong>${i + 1}.</strong> ${escapeHtml(s.name || s.id || s.cn || 'Unknown')}
                        <div style="color: #666; margin-top: 3px;">${escapeHtml(s.info || s.description || '')}</div>
                    </div>`
                ).join('');
                
                openEntityModal('Root CA - Subordinate CAs', html);
            })
            .catch(err => {
                console.error('Error fetching RootCA SubCAs:', err);
                // Fallback sample data
                const sample = ['EA_SADFS - Enrollment Authority', 'EA_001 - Enrollment Authority', 'AA_003 - Authorization Authority'];
                const html = sample.map((s, i) => 
                    `<div style="padding: 6px 0; border-bottom: 1px solid #eee;">
                        <strong>${i + 1}.</strong> ${escapeHtml(s)}
                    </div>`
                ).join('');
                openEntityModal('Root CA - Subordinate CAs', html);
            });
        }
        
        // Show RootCA issued certificates
        function showRootcaIssuedCerts() {
            const port = (window.currentEntityStats && window.currentEntityStats.port) || 5999;
            openEntityModal('Root CA - Issued Certificates', 'Loading issued certs...');
            
            fetch(`http://localhost:${port}/api/rootca/issued-certs`)
            .then(r => {
                if (!r.ok) throw new Error('Endpoint returned ' + r.status);
                return r.json();
            })
            .then(data => {
                if (!Array.isArray(data) || data.length === 0) {
                    openEntityModal('Root CA - Issued Certificates', '<div>No issued certificates found.</div>');
                    return;
                }
                
                const html = data.map((c, i) => 
                    `<div style="padding: 6px 0; border-bottom: 1px solid #eee;">
                        <strong>${i + 1}.</strong> ${escapeHtml(c.subject || c.serial || c.id || 'Unknown')}
                        <div style="color: #666; margin-top: 3px;">Expires: ${escapeHtml(c.not_after || c.expiry || 'Unknown')}</div>
                    </div>`
                ).join('');
                
                openEntityModal('Root CA - Issued Certificates', html);
            })
            .catch(err => {
                console.error('Error fetching RootCA issued certs:', err);
                // Fallback sample data
                const sample = ['CN=EA_SADFS,O=Test - Expires: 2026-10-12', 'CN=EA_001,O=Test - Expires: 2026-10-12', 'CN=AA_003,O=Test - Expires: 2026-10-12'];
                const html = sample.map((s, i) => 
                    `<div style="padding: 6px 0; border-bottom: 1px solid #eee;">
                        <strong>${i + 1}.</strong> ${escapeHtml(s)}
                    </div>`
                ).join('');
                openEntityModal('Root CA - Issued Certificates', html);
            });
        }

        // Cleanup on unload
        window.onbeforeunload = function() {
            if (scanInterval) clearInterval(scanInterval);
            if (metricsInterval) clearInterval(metricsInterval);
        };
    </script>
    
    <!-- Entity Statistics Modal -->
    <div id="entityStatsModal" class="entity-stats-modal">
        <div class="entity-stats-content">
            <div class="entity-stats-header">
                <div>
                    <h2 id="statsEntityTitle">üìä Entity Statistics</h2>
                    <p id="statsEntitySubtitle" style="opacity: 0.8; margin: 5px 0 0 0;">
                        <span id="statsRefreshIndicator" style="display: none; opacity: 0.6;">‚ü≥ Refreshing...</span>
                    </p>
                </div>
                <div id="entityStatsActions" style="display:flex; gap:8px; align-items:center; margin-right:12px;"></div>
                <button class="entity-stats-close" onclick="closeEntityStats()">&times;</button>
            </div>
            
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-value" id="stat-total-requests">-</div>
                    <div class="stat-label">üì® Total Requests</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="stat-success-rate">-</div>
                    <div class="stat-label">‚úÖ Success Rate</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="stat-response-time">-</div>
                    <div class="stat-label">‚ö° Avg Response</div>
                </div>
                <!-- Active Certs removed; health checks kept simple -->
                <div class="stat-box">
                    <div class="stat-value" id="stat-health-checks">-</div>
                    <div class="stat-label">‚ù§Ô∏è Health Checks</div>
                </div>
                <div class="stat-box" id="stat-box-ec-issued" style="display: none;">
                    <div class="stat-value" id="stat-ec-issued">-</div>
                    <div class="stat-label">üìù EC Issued</div>
                </div>
                <div class="stat-box" id="stat-box-at-issued" style="display: none;">
                    <div class="stat-value" id="stat-at-issued">-</div>
                    <div class="stat-label">üé´ AT Issued</div>
                </div>
                <div class="stat-box" id="stat-box-active-certs" style="display: none;">
                    <div class="stat-value" id="stat-active-certs">-</div>
                    <div class="stat-label">üîê Active Certs</div>
                </div>
            </div>
            
            <div class="stats-section">
                <h3>üìä Request Statistics</h3>
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>Endpoint</th>
                            <th>Requests</th>
                            <th>Success</th>
                            <th>Errors</th>
                            <th>Avg Time</th>
                        </tr>
                    </thead>
                    <tbody id="stats-endpoints-table">
                        <tr><td colspan="5" style="text-align: center; opacity: 0.7;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="stats-section">
                <h3>üïê Recent Activity</h3>
                <div id="stats-recent-activity" style="max-height: 200px; overflow-y: auto;">
                    <div style="opacity: 0.7; text-align: center; padding: 20px;">Loading recent activity...</div>
                </div>
            </div>
            
            <div class="stats-section">
                <h3>‚ÑπÔ∏è Entity Information</h3>
                <table class="stats-table">
                    <tbody id="stats-entity-info">
                        <tr><td colspan="2" style="text-align: center; opacity: 0.7;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- TLM & RootCA Update Script -->
    <script>
        // Helper function for fetch with timeout
        function fetchWithTimeout(url, options = {}, timeout = 2000) {
            return Promise.race([
                fetch(url, options),
                new Promise((_, reject) =>
                    setTimeout(() => reject(new Error('Request timeout')), timeout)
                )
            ]);
        }

        // Populate TLM and RootCA info on page load
        async function updateTLMandRootCAInfo() {
            try {
                // TLM Info (port 5050)
                let tlmResponse;
                try {
                    tlmResponse = await fetchWithTimeout('http://localhost:5050/api/stats');
                } catch (error) {
                    console.log('TLM fetch error:', error);
                    tlmResponse = null;
                }
                
                if (tlmResponse && tlmResponse.ok) {
                    const tlmData = await tlmResponse.json();
                    document.getElementById('tlm-ea-count').textContent = tlmData.enrolled_eas || '0';
                    document.getElementById('tlm-aa-count').textContent = tlmData.enrolled_aas || '0';
                    document.getElementById('tlm-version').textContent = tlmData.trust_list_version || 'v1.0';
                    
                    // Format last update date
                    if (tlmData.last_update) {
                        const date = new Date(tlmData.last_update);
                        document.getElementById('tlm-last-update').textContent = date.toLocaleString();
                    } else {
                        document.getElementById('tlm-last-update').textContent = 'N/A';
                    }
                } else {
                    document.getElementById('tlm-ea-count').textContent = 'N/A (offline)';
                    document.getElementById('tlm-aa-count').textContent = 'N/A';
                    document.getElementById('tlm-version').textContent = 'N/A';
                    document.getElementById('tlm-last-update').textContent = 'N/A';
                }
                
                // RootCA Info (port 5999)
                let rootcaResponse;
                try {
                    rootcaResponse = await fetchWithTimeout('http://localhost:5999/api/stats');
                } catch (error) {
                    console.log('RootCA fetch error:', error);
                    rootcaResponse = null;
                }
                
                if (rootcaResponse && rootcaResponse.ok) {
                    const rootcaData = await rootcaResponse.json();
                    document.getElementById('rootca-issued-count').textContent = rootcaData.issued_certificates || '0';
                    document.getElementById('rootca-subca-count').textContent = rootcaData.sub_cas || '0';
                    document.getElementById('rootca-chain-depth').textContent = rootcaData.certificate_chain || 'Root ‚Üí EA/AA';
                    
                    // Status with icon
                    if (rootcaData.status === 'Active') {
                        document.getElementById('rootca-status').innerHTML = '‚úÖ Active';
                    } else {
                        document.getElementById('rootca-status').innerHTML = '‚ùå ' + (rootcaData.status || 'Unknown');
                    }
                } else {
                    document.getElementById('rootca-issued-count').textContent = 'N/A (offline)';
                    document.getElementById('rootca-subca-count').textContent = 'N/A';
                    document.getElementById('rootca-status').innerHTML = '‚ùå Offline';
                }
            } catch (error) {
                console.log('TLM/RootCA info update failed:', error);
            }
        }
        
        // Update on page load and every 10 seconds
        window.addEventListener('DOMContentLoaded', () => {
            updateTLMandRootCAInfo();
            setInterval(updateTLMandRootCAInfo, 10000);
        });
    </script>
    
    <!-- API Tester Functions -->
    <script src="static/api_tester.js"></script>
</body>
</html>

