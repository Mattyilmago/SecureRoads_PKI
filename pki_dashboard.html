<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureRoad PKI - Control Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .status-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .status-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .status-card h3 {
            color: #667eea;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .status-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }

        .status-card.success .value {
            color: #10b981;
        }

        .status-card.warning .value {
            color: #f59e0b;
        }

        .status-card.error .value {
            color: #ef4444;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .panel h2 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .entity-list {
            display: grid;
            gap: 10px;
        }

        .entity-item {
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.3s;
        }

        .entity-item:hover {
            background: #f3f4f6;
            transform: translateX(5px);
        }

        .entity-item h4 {
            color: #333;
            margin-bottom: 5px;
        }

        .entity-item p {
            color: #666;
            font-size: 0.9em;
        }

        .entity-item .status {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-top: 5px;
        }

        .entity-item .status.online {
            background: #d1fae5;
            color: #065f46;
        }

        .entity-item .status.offline {
            background: #fee2e2;
            color: #991b1b;
        }

        .test-results {
            display: grid;
            gap: 10px;
        }

        .test-category {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
        }

        .test-category h4 {
            color: #333;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .test-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .test-badge.passed {
            background: #d1fae5;
            color: #065f46;
        }

        .endpoint-list {
            display: grid;
            gap: 8px;
        }

        .endpoint-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f9fafb;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .method {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            margin-right: 10px;
            font-size: 0.85em;
        }

        .method.GET {
            background: #dbeafe;
            color: #1e40af;
        }

        .method.POST {
            background: #d1fae5;
            color: #065f46;
        }

        .method.DELETE {
            background: #fee2e2;
            color: #991b1b;
        }

        .endpoint-path {
            color: #666;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            text-align: center;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4);
        }

        .btn-info {
            background: #3b82f6;
            color: white;
        }

        .btn-info:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .metric-item {
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
            text-align: center;
        }

        .metric-item .label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }

        .metric-item .value {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }

        .log-viewer {
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .log-line {
            margin-bottom: 5px;
            padding: 3px 0;
        }

        .log-line.info {
            color: #10b981;
        }

        .log-line.warning {
            color: #f59e0b;
        }

        .log-line.error {
            color: #ef4444;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .feature-card {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border-top: 3px solid #667eea;
        }

        .feature-card .icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .feature-card h4 {
            color: #333;
            margin-bottom: 8px;
        }

        .feature-card p {
            color: #666;
            font-size: 0.9em;
        }

        .feature-card .check {
            color: #10b981;
            font-size: 1.5em;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üîê SecureRoad PKI Control Panel</h1>
            <p>ETSI TS 102941 Compliant - Real-time Monitoring Dashboard</p>
        </div>

        <!-- Status Bar -->
        <div class="status-bar" id="statusBar">
            <div class="status-card success">
                <h3>System Status</h3>
                <div class="value" id="systemStatus">Loading...</div>
            </div>
            <div class="status-card success">
                <h3>Active Instances</h3>
                <div class="value" id="activeInstancesTotal">
                    <span>0</span>
                    <span id="scanningIndicator" style="display: none; font-size: 0.5em; margin-left: 5px;">üîÑ</span>
                </div>
            </div>
            <div class="status-card">
                <h3>Total Tests</h3>
                <div class="value" id="totalTests">130</div>
            </div>
            <div class="status-card success">
                <h3>Tests Passing</h3>
                <div class="value" id="passingTests">130</div>
            </div>
            <div class="status-card">
                <h3>API Endpoints</h3>
                <div class="value" id="totalEndpoints">18</div>
            </div>
            <div class="status-card">
                <h3>Uptime</h3>
                <div class="value" id="uptime">0s</div>
            </div>
            <div class="status-card">
                <h3>Requests/sec</h3>
                <div class="value" id="requestsPerSec">0.0</div>
            </div>
            <div class="status-card">
                <h3>Last Scan</h3>
                <div class="value" id="lastScanTime" style="font-size: 0.7em;">Never</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- PKI Entities Panel -->
            <div class="panel">
                <h2>üè¢ PKI Entities</h2>
                <div class="entity-list">
                    <div class="entity-item">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;" onclick="checkEntity('RootCA', 'http://localhost:8443')">
                                <h4>Root CA</h4>
                                <p>Root Certificate Authority - Trust Anchor</p>
                                <span class="status offline" id="status-rootca">Checking...</span>
                            </div>
                            <button class="btn btn-primary" style="margin-left: 10px; padding: 8px 15px; font-size: 0.9em;" onclick="startEntity('RootCA', 8443); event.stopPropagation();">
                                ‚ñ∂Ô∏è Start
                            </button>
                        </div>
                    </div>
                    <div class="entity-item">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;" onclick="checkEntity('EA', 'http://localhost:5000')">
                                <h4>Enrollment Authority (EA)</h4>
                                <p>Issues Enrollment Certificates to ITS Stations</p>
                                <span class="status offline" id="status-ea">Checking...</span>
                            </div>
                            <button class="btn btn-primary" style="margin-left: 10px; padding: 8px 15px; font-size: 0.9em;" onclick="startEntity('EA', 5000); event.stopPropagation();">
                                ‚ñ∂Ô∏è Start
                            </button>
                        </div>
                    </div>
                    <div class="entity-item">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;" onclick="checkEntity('AA', 'http://localhost:5003')">
                                <h4>Authorization Authority (AA)</h4>
                                <p>Issues Authorization Tickets for V2X</p>
                                <span class="status offline" id="status-aa">Checking...</span>
                            </div>
                            <button class="btn btn-primary" style="margin-left: 10px; padding: 8px 15px; font-size: 0.9em;" onclick="startEntity('AA', 5003); event.stopPropagation();">
                                ‚ñ∂Ô∏è Start
                            </button>
                        </div>
                    </div>
                    <div class="entity-item">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;" onclick="checkEntity('TLM', 'http://localhost:5002')">
                                <h4>Trust List Manager (TLM)</h4>
                                <p>Distributes Certificate Trust Lists</p>
                                <span class="status offline" id="status-tlm">Checking...</span>
                            </div>
                            <button class="btn btn-primary" style="margin-left: 10px; padding: 8px 15px; font-size: 0.9em;" onclick="startEntity('TLM', 5002); event.stopPropagation();">
                                ‚ñ∂Ô∏è Start
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Entity Generator Section -->
                <div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; color: white;">
                    <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        üèóÔ∏è Bulk Entity Generator
                    </h3>
                    <p style="font-size: 0.9em; opacity: 0.9; margin-bottom: 15px;">
                        Generate multiple PKI entities at once
                    </p>
                    <button class="btn btn-success" style="width: 100%; background: white; color: #667eea; font-weight: bold;" onclick="showEntityGeneratorForm()">
                        ‚ûï Generate Multiple Entities
                    </button>
                </div>
            </div>

            <!-- Active Instances Panel -->
            <div class="panel">
                <h2>üîå Active Instances</h2>
                <p style="color: #666; margin-bottom: 15px; font-size: 0.9em;">Real-time monitoring of all running PKI entities</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <!-- EA Instances -->
                    <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 20px; border-radius: 10px; color: white;">
                        <h3 style="font-size: 1.1em; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            üìù Enrollment Authority
                        </h3>
                        <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 10px;" id="instanceCount-EA">0</div>
                        <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 10px;">Active Instances</div>
                        <div id="instanceList-EA" style="font-size: 0.85em; opacity: 0.95; max-height: 150px; overflow-y: auto;">
                            <div style="padding: 5px; background: rgba(255,255,255,0.1); border-radius: 5px; margin-bottom: 5px;">
                                Scanning...
                            </div>
                        </div>
                    </div>

                    <!-- AA Instances -->
                    <div style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); padding: 20px; border-radius: 10px; color: white;">
                        <h3 style="font-size: 1.1em; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            üé´ Authorization Authority
                        </h3>
                        <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 10px;" id="instanceCount-AA">0</div>
                        <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 10px;">Active Instances</div>
                        <div id="instanceList-AA" style="font-size: 0.85em; opacity: 0.95; max-height: 150px; overflow-y: auto;">
                            <div style="padding: 5px; background: rgba(255,255,255,0.1); border-radius: 5px; margin-bottom: 5px;">
                                Scanning...
                            </div>
                        </div>
                    </div>

                    <!-- TLM Instances -->
                    <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 20px; border-radius: 10px; color: white;">
                        <h3 style="font-size: 1.1em; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            üìã Trust List Manager
                        </h3>
                        <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 10px;" id="instanceCount-TLM">0</div>
                        <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 10px;">Active Instances</div>
                        <div id="instanceList-TLM" style="font-size: 0.85em; opacity: 0.95; max-height: 150px; overflow-y: auto;">
                            <div style="padding: 5px; background: rgba(255,255,255,0.1); border-radius: 5px; margin-bottom: 5px;">
                                Scanning...
                            </div>
                        </div>
                    </div>

                    <!-- RootCA Instances -->
                    <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); padding: 20px; border-radius: 10px; color: white;">
                        <h3 style="font-size: 1.1em; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            üèõÔ∏è Root CA
                        </h3>
                        <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 10px;" id="instanceCount-RootCA">0</div>
                        <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 10px;">Active Instances</div>
                        <div id="instanceList-RootCA" style="font-size: 0.85em; opacity: 0.95; max-height: 150px; overflow-y: auto;">
                            <div style="padding: 5px; background: rgba(255,255,255,0.1); border-radius: 5px; margin-bottom: 5px;">
                                Scanning...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Daily Use Test Scripts Panel -->
            <div class="panel">
                <h2>üß™ Daily Use Test Scripts</h2>
                <p style="color: #666; margin-bottom: 15px; font-size: 0.9em;">Run common PKI test scenarios from the command line</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
                    
                    <!-- Interactive Tester -->
                    <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); padding: 25px; border-radius: 12px; color: white;">
                        <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            üéÆ Interactive PKI Tester
                        </h3>
                        <p style="font-size: 0.9em; opacity: 0.9; margin-bottom: 15px;">
                            Menu interattivo per eseguire test completi sulla PKI con salvataggio risultati
                        </p>
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px; font-family: 'Courier New', monospace; font-size: 0.85em;">
                            python examples/interactive_pki_tester.py
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 6px; text-align: center;">
                                <div style="font-size: 1.5em; font-weight: bold;">6</div>
                                <div style="font-size: 0.8em; opacity: 0.9;">Test Disponibili</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 6px; text-align: center;">
                                <div style="font-size: 1.5em; font-weight: bold;" id="savedTestResults">0</div>
                                <div style="font-size: 0.8em; opacity: 0.9;">Risultati Salvati</div>
                            </div>
                        </div>
                        <button onclick="copyToClipboard('python examples/interactive_pki_tester.py')" 
                                style="width: 100%; padding: 10px; background: white; color: #8b5cf6; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">
                            üìã Copy Command
                        </button>
                        <button onclick="runInteractiveTester()" 
                                style="width: 100%; padding: 10px; background: rgba(255,255,255,0.2); color: white; border: 1px solid white; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 8px;">
                            ‚ñ∂Ô∏è Run Now
                        </button>
                    </div>

                    <!-- Quick Test -->
                    <div style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); padding: 25px; border-radius: 12px; color: white;">
                        <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            ‚ö° Quick Test
                        </h3>
                        <p style="font-size: 0.9em; opacity: 0.9; margin-bottom: 15px;">
                            Test veloci per verificare enrollment, authorization e comunicazioni
                        </p>
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px; font-family: 'Courier New', monospace; font-size: 0.85em;">
                            python examples/quick_test.py --test all
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                            <div style="font-size: 0.85em; font-weight: bold; margin-bottom: 8px;">Test Disponibili:</div>
                            <div style="font-size: 0.8em; line-height: 1.6;">
                                ‚Ä¢ enrollment - Test enrollment singolo<br>
                                ‚Ä¢ authorization - Test authorization<br>
                                ‚Ä¢ multiple - Enrollment multipli<br>
                                ‚Ä¢ all - Esegui tutti i test
                            </div>
                        </div>
                        <button onclick="copyToClipboard('python examples/quick_test.py --test all')" 
                                style="width: 100%; padding: 10px; background: white; color: #06b6d4; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">
                            üìã Copy Command
                        </button>
                        <button onclick="runQuickTest()" 
                                style="width: 100%; padding: 10px; background: rgba(255,255,255,0.2); color: white; border: 1px solid white; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 8px;">
                            ‚ñ∂Ô∏è Run Quick Test
                        </button>
                    </div>

                    <!-- Test Results Viewer -->
                    <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 25px; border-radius: 12px; color: white;">
                        <h3 style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            üìä Test Results
                        </h3>
                        <p style="font-size: 0.9em; opacity: 0.9; margin-bottom: 15px;">
                            Visualizza i risultati dei test eseguiti con interactive_pki_tester
                        </p>
                        <div id="testResultsSummary" style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; margin-bottom: 15px; min-height: 100px;">
                            <div style="text-align: center; opacity: 0.7; padding: 20px;">
                                Nessun risultato disponibile.<br>
                                Esegui prima i test!
                            </div>
                        </div>
                        <button onclick="loadTestResults()" 
                                style="width: 100%; padding: 10px; background: white; color: #f59e0b; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">
                            üîÑ Refresh Results
                        </button>
                        <button onclick="showTestResultsModal()" 
                                style="width: 100%; padding: 10px; background: rgba(255,255,255,0.2); color: white; border: 1px solid white; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 8px;">
                            üìã View Details
                        </button>
                    </div>

                </div>

                <!-- Test Scenarios Quick Access -->
                <div style="margin-top: 25px; background: #f9fafb; padding: 20px; border-radius: 10px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üéØ Common Test Scenarios</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px;">
                        <button onclick="runScenario('single_enrollment')" class="btn btn-info" style="text-align: left; padding: 12px;">
                            üöó <strong>Single Vehicle Enrollment</strong><br>
                            <small style="opacity: 0.7;">Test enrollment di un singolo veicolo</small>
                        </button>
                        <button onclick="runScenario('fleet')" class="btn btn-info" style="text-align: left; padding: 12px;">
                            üöö <strong>Fleet Enrollment (5 vehicles)</strong><br>
                            <small style="opacity: 0.7;">Test enrollment flotta veicoli</small>
                        </button>
                        <button onclick="runScenario('v2v')" class="btn btn-info" style="text-align: left; padding: 12px;">
                            üì° <strong>V2V Communication</strong><br>
                            <small style="opacity: 0.7;">Test comunicazione veicolo-veicolo</small>
                        </button>
                        <button onclick="runScenario('performance')" class="btn btn-info" style="text-align: left; padding: 12px;">
                            ‚ö° <strong>Performance Test</strong><br>
                            <small style="opacity: 0.7;">Test di carico con 10 enrollment</small>
                        </button>
                        <button onclick="runScenario('validation')" class="btn btn-info" style="text-align: left; padding: 12px;">
                            ‚úîÔ∏è <strong>Certificate Validation</strong><br>
                            <small style="opacity: 0.7;">Verifica validit√† certificati</small>
                        </button>
                        <button onclick="runScenario('full_suite')" class="btn btn-success" style="text-align: left; padding: 12px;">
                            üéØ <strong>Full Test Suite</strong><br>
                            <small style="opacity: 0.7;">Esegui tutti i test in sequenza</small>
                        </button>
                    </div>
                </div>
            </div>

            <!-- API Testing Panel -->
            <div class="panel">
                <h2>üß™ Interactive API Testing</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-top: 15px;">
                    
                    <!-- EA Tests -->
                    <div style="background: #f9fafb; padding: 20px; border-radius: 8px; border-left: 4px solid #10b981;">
                        <h3 style="color: #10b981; margin-bottom: 15px;">üìù Enrollment Authority</h3>
                        <button class="btn btn-success" style="width: 100%; margin-bottom: 10px;" onclick="testEnrollmentSimple()">
                            üöó Request Enrollment Certificate
                        </button>
                        <button class="btn btn-info" style="width: 100%;" onclick="testEnrollmentETSI()">
                            üìÑ Request EC (ETSI Format)
                        </button>
                    </div>

                    <!-- AA Tests -->
                    <div style="background: #f9fafb; padding: 20px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                        <h3 style="color: #3b82f6; margin-bottom: 15px;">üé´ Authorization Authority</h3>
                        <button class="btn btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="testAuthorizationSingle()">
                            üéüÔ∏è Request Authorization Ticket
                        </button>
                        <button class="btn btn-primary" style="width: 100%;" onclick="testAuthorizationButterfly()">
                            ü¶ã Butterfly Batch Request (5 ATs)
                        </button>
                    </div>

                    <!-- CRL Tests -->
                    <div style="background: #f9fafb; padding: 20px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                        <h3 style="color: #f59e0b; margin-bottom: 15px;">üìú Certificate Revocation</h3>
                        <button class="btn btn-info" style="width: 100%; margin-bottom: 10px;" onclick="testCRLFull()">
                            üìã Get Full CRL
                        </button>
                        <button class="btn btn-info" style="width: 100%;" onclick="testCRLDelta()">
                            üîÑ Get Delta CRL
                        </button>
                    </div>

                    <!-- Trust List Tests -->
                    <div style="background: #f9fafb; padding: 20px; border-radius: 8px; border-left: 4px solid #8b5cf6;">
                        <h3 style="color: #8b5cf6; margin-bottom: 15px;">üîó Trust List Manager</h3>
                        <button class="btn btn-info" style="width: 100%; margin-bottom: 10px;" onclick="testTrustListFull()">
                            üìã Get Full Trust List
                        </button>
                        <button class="btn btn-info" style="width: 100%;" onclick="testTrustListDelta()">
                            üîÑ Get Delta Trust List
                        </button>
                    </div>

                </div>

                <!-- API Response Viewer -->
                <div style="margin-top: 25px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: #667eea; margin: 0;">üìä API Response</h3>
                        <button id="toggleFullResponseBtn" class="btn btn-info" style="display: none; padding: 6px 12px; font-size: 0.85em;" onclick="toggleFullResponse()">
                            ÔøΩ Show Full Response
                        </button>
                    </div>
                    <div id="apiResponse" style="background: #1f2937; color: #10b981; padding: 20px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 0.9em; max-height: 500px; overflow-y: auto; white-space: pre-wrap; word-break: break-all;">
                        <span style="color: #6b7280;">Click a test button above to see the API response...</span>
                    </div>
                </div>
            </div>

            <!-- Test Results Panel -->
            <div class="panel">
                <h2>‚úÖ Test Coverage</h2>
                <div class="test-results">
                    <div class="test-category">
                        <h4>
                            <span>PKI Entities</span>
                            <span class="test-badge passed">20/20</span>
                        </h4>
                        <p style="color: #666; font-size: 0.9em;">RootCA, EA, AA, Directory Structure</p>
                    </div>
                    <div class="test-category">
                        <h4>
                            <span>Butterfly Key Expansion</span>
                            <span class="test-badge passed">23/23</span>
                        </h4>
                        <p style="color: #666; font-size: 0.9em;">Privacy-preserving batch AT issuance</p>
                    </div>
                    <div class="test-category">
                        <h4>
                            <span>ETSI Compliance</span>
                            <span class="test-badge passed">22/22</span>
                        </h4>
                        <p style="color: #666; font-size: 0.9em;">TS 102941 & TS 103097 conformance</p>
                    </div>
                    <div class="test-category">
                        <h4>
                            <span>Link Certificates</span>
                            <span class="test-badge passed">16/16</span>
                        </h4>
                        <p style="color: #666; font-size: 0.9em;">ASN.1 OER encoding & verification</p>
                    </div>
                    <div class="test-category">
                        <h4>
                            <span>ITS Station</span>
                            <span class="test-badge passed">9/9</span>
                        </h4>
                        <p style="color: #666; font-size: 0.9em;">Vehicle enrollment & authorization</p>
                    </div>
                    <div class="test-category">
                        <h4>
                            <span>REST API</span>
                            <span class="test-badge passed">10/10</span>
                        </h4>
                        <p style="color: #666; font-size: 0.9em;">EA & AA endpoints with auth</p>
                    </div>
                    <div class="test-category">
                        <h4>
                            <span>mTLS Authentication</span>
                            <span class="test-badge passed">15/15</span>
                        </h4>
                        <p style="color: #666; font-size: 0.9em;">Mutual TLS inter-authority auth</p>
                    </div>
                    <div class="test-category">
                        <h4>
                            <span>Managers (CRL/TLM)</span>
                            <span class="test-badge passed">6/6</span>
                        </h4>
                        <p style="color: #666; font-size: 0.9em;">CRL & Trust List management</p>
                    </div>
                    <div class="test-category">
                        <h4>
                            <span>ETSI Protocols</span>
                            <span class="test-badge passed">9/9</span>
                        </h4>
                        <p style="color: #666; font-size: 0.9em;">Message types & encoding</p>
                        </div>
                </div>
            </div>

            <!-- API Endpoints Panel -->
            <div class="panel">
                <h2>üåê REST API Endpoints</h2>
                <div class="endpoint-list">
                    <div class="endpoint-item">
                        <span class="method GET">GET</span>
                        <span class="endpoint-path">/health</span>
                    </div>
                    <div class="endpoint-item">
                        <span class="method POST">POST</span>
                        <span class="endpoint-path">/api/enrollment/request</span>
                    </div>
                    <div class="endpoint-item">
                        <span class="method POST">POST</span>
                        <span class="endpoint-path">/api/enrollment/request/simple</span>
                    </div>
                    <div class="endpoint-item">
                        <span class="method POST">POST</span>
                        <span class="endpoint-path">/api/authorization/request</span>
                    </div>
                    <div class="endpoint-item">
                        <span class="method POST">POST</span>
                        <span class="endpoint-path">/api/authorization/request/butterfly</span>
                    </div>
                    <div class="endpoint-item">
                        <span class="method GET">GET</span>
                        <span class="endpoint-path">/api/crl/full</span>
                    </div>
                    <div class="endpoint-item">
                        <span class="method GET">GET</span>
                        <span class="endpoint-path">/api/crl/delta</span>
                    </div>
                    <div class="endpoint-item">
                        <span class="method GET">GET</span>
                        <span class="endpoint-path">/api/trust-list/full</span>
                    </div>
                    <div class="endpoint-item">
                        <span class="method GET">GET</span>
                        <span class="endpoint-path">/api/trust-list/delta</span>
                    </div>
                    <div class="endpoint-item">
                        <span class="method GET">GET</span>
                        <span class="endpoint-path">/api/monitoring/metrics</span>
                    </div>
                    <div class="endpoint-item">
                        <span class="method GET">GET</span>
                        <span class="endpoint-path">/api/monitoring/health</span>
                    </div>
                    <div class="endpoint-item">
                        <span class="method GET">GET</span>
                        <span class="endpoint-path">/api/docs</span>
                    </div>
                </div>
            </div>

            <!-- Real-time Metrics Panel -->
            <div class="panel">
                <h2>üìä Real-time Metrics</h2>
                <div class="metrics-grid" id="metricsGrid">
                    <div class="metric-item">
                        <div class="label">Total Requests</div>
                        <div class="value" id="metricTotalReq">0</div>
                    </div>
                    <div class="metric-item">
                        <div class="label">Error Rate</div>
                        <div class="value" id="metricErrorRate">0%</div>
                    </div>
                    <div class="metric-item">
                        <div class="label">Avg Latency</div>
                        <div class="value" id="metricLatency">0ms</div>
                    </div>
                    <div class="metric-item">
                        <div class="label">Enrollment Reqs</div>
                        <div class="value" id="metricEnrollment">0</div>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="refreshMetrics()">üîÑ Refresh</button>
                    <button class="btn btn-info" onclick="openSwagger()">üìñ OpenAPI Docs</button>
                    <button class="btn btn-success" onclick="runTests()">‚ñ∂Ô∏è Run Tests</button>
                </div>
            </div>
        </div>

        <!-- Features Overview -->
        <div class="panel full-width">
            <h2>üéØ Implemented Features</h2>
            <div class="feature-grid">
                <div class="feature-card">
                    <div class="icon">üîê</div>
                    <h4>mTLS Authentication</h4>
                    <p>Mutual TLS with X.509 certificates</p>
                    <div class="check">‚úì</div>
                </div>
                <div class="feature-card">
                    <div class="icon">ü¶ã</div>
                    <h4>Butterfly Expansion</h4>
                    <p>Privacy-preserving batch ATs</p>
                    <div class="check">‚úì</div>
                </div>
                <div class="feature-card">
                    <div class="icon">üìú</div>
                    <h4>CRL Management</h4>
                    <p>Full & Delta CRL distribution</p>
                    <div class="check">‚úì</div>
                </div>
                <div class="feature-card">
                    <div class="icon">üîó</div>
                    <h4>Link Certificates</h4>
                    <p>ASN.1 OER ETSI-compliant</p>
                    <div class="check">‚úì</div>
                </div>
                <div class="feature-card">
                    <div class="icon">üìä</div>
                    <h4>Monitoring System</h4>
                    <p>Real-time metrics & health</p>
                    <div class="check">‚úì</div>
                </div>
                <div class="feature-card">
                    <div class="icon">üìñ</div>
                    <h4>OpenAPI/Swagger</h4>
                    <p>Interactive API docs</p>
                    <div class="check">‚úì</div>
                </div>
                <div class="feature-card">
                    <div class="icon">üöÄ</div>
                    <h4>Production Ready</h4>
                    <p>130/130 tests passing</p>
                    <div class="check">‚úì</div>
                </div>
                <div class="feature-card">
                    <div class="icon">üõ°Ô∏è</div>
                    <h4>Security Hardening</h4>
                    <p>API keys, CORS, Rate limiting</p>
                    <div class="check">‚úì</div>
                </div>
            </div>
        </div>

        <!-- System Log -->
        <div class="panel full-width">
            <h2>üìù System Log</h2>
            <div class="log-viewer" id="logViewer">
                <div class="log-line info">[INFO] Dashboard initialized</div>
                <div class="log-line info">[INFO] Checking entity status...</div>
            </div>
        </div>
    </div>

    <script>
        // Configuration - PORT RANGES FOR ENTITY TYPES
        // EA: 5000-5019 (20 instances)
        // AA: 5020-5039 (20 instances)
        // TLM: 5050 (1 instance)
        // RootCA: 5999 (1 instance)
        
        const ENTITY_PORTS = {
            'EA': Array.from({length: 20}, (_, i) => 5000 + i),   // 5000-5019
            'AA': Array.from({length: 20}, (_, i) => 5020 + i),   // 5020-5039
            'TLM': [5050],                                         // 5050
            'RootCA': [5999]                                       // 5999
        };

        // Helper function to generate port ranges
        function generatePortRange(start, end, step = 1) {
            const ports = [];
            for (let port = start; port <= end; port += step) {
                ports.push(port);
            }
            return ports;
        }

        // Legacy single entity config (kept for compatibility)
        const ENTITIES = {
            'EA': 'http://localhost:5000',
            'AA': 'http://localhost:5020',
            'TLM': 'http://localhost:5050',
            'RootCA': 'http://localhost:5999'
        };

        // Track active instances
        let activeInstances = {
            'EA': [],
            'AA': [],
            'TLM': [],
            'RootCA': []
        };

        // Initialize on load
        window.onload = function() {
            addLog('Dashboard loaded successfully', 'info');
            checkAllEntities();
            scanAllInstances();  // New: scan for all active instances
            refreshMetrics();
            
            // Auto-refresh every 5 seconds (pi√π frequente per UI reattiva)
            setInterval(checkAllEntities, 5000);
            setInterval(scanAllInstances, 5000);  // Ridotto da 10s a 5s
            setInterval(refreshMetrics, 15000);   // Metriche meno frequenti
        };

        // Check all entities
        function checkAllEntities() {
            addLog('Checking entity statuses...', 'info');
            Object.keys(ENTITIES).forEach(entity => {
                checkEntity(entity, ENTITIES[entity]);
            });
        }

        // Scan all instances for all entity types (ottimizzato con richieste parallele)
        async function scanAllInstances() {
            // Mostra indicatore scanning
            const indicator = document.getElementById('scanningIndicator');
            if (indicator) {
                indicator.style.display = 'inline';
            }
            
            addLog('Scanning for active instances...', 'info');
            
            // Crea array di promesse per controllare tutte le porte in parallelo
            const scanPromises = [];
            
            for (const entityType of Object.keys(ENTITY_PORTS)) {
                const ports = ENTITY_PORTS[entityType];
                
                // Crea una promessa per ogni tipo di entit√†
                const entityScanPromise = Promise.all(
                    ports.map(async (port) => {
                        const baseUrl = `http://localhost:${port}`;
                        const isActive = await checkInstanceHealth(baseUrl);
                        
                        if (isActive) {
                            // Try to get entity ID from health endpoint
                            const entityInfo = await getEntityInfo(baseUrl);
                            return {
                                port: port,
                                url: baseUrl,
                                id: entityInfo.id || `${entityType}_${port}`,
                                uptime: entityInfo.uptime || 'N/A'
                            };
                        }
                        return null;
                    })
                ).then(results => ({
                    entityType,
                    activeList: results.filter(r => r !== null)
                }));
                
                scanPromises.push(entityScanPromise);
            }
            
            // Attendi che tutte le scansioni siano completate
            const allResults = await Promise.all(scanPromises);
            
            // Aggiorna il display per ogni tipo di entit√†
            for (const {entityType, activeList} of allResults) {
                activeInstances[entityType] = activeList;
                updateInstanceDisplay(entityType, activeList);
            }
            
            // Update total count in status bar
            const totalActive = Object.values(activeInstances).reduce((sum, list) => sum + list.length, 0);
            
            // Update last scan time
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            const lastScanEl = document.getElementById('lastScanTime');
            if (lastScanEl) {
                lastScanEl.textContent = timeStr;
            }
            
            // Nascondi indicatore
            if (indicator) {
                indicator.style.display = 'none';
            }
            
            addLog(`Found ${totalActive} active instances (${allResults.length} types scanned)`, 'info');
        }

        // Check if instance is healthy (con timeout ridotto per velocit√†)
        async function checkInstanceHealth(baseUrl) {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000); // Aumentato a 3 secondi
                
                const response = await fetch(`${baseUrl}/health`, {
                    method: 'GET',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                return response.ok;
            } catch (error) {
                // Retry una volta se fallisce
                try {
                    const controller2 = new AbortController();
                    const timeoutId2 = setTimeout(() => controller2.abort(), 2000);
                    
                    const response2 = await fetch(`${baseUrl}/health`, {
                        method: 'GET',
                        signal: controller2.signal
                    });
                    
                    clearTimeout(timeoutId2);
                    return response2.ok;
                } catch (error2) {
                    return false;
                }
            }
        }

        // Get entity information from health endpoint
        async function getEntityInfo(baseUrl) {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 2000); // Aumentato a 2 secondi
                
                const response = await fetch(`${baseUrl}/health`, {
                    method: 'GET',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const data = await response.json();
                    return {
                        id: data.entity_id || data.id || null,
                        uptime: data.uptime || null
                    };
                }
            } catch (error) {
                // Silent fail
            }
            return {};
        }

        // Update instance display in UI
        function updateInstanceDisplay(entityType, instances) {
            const countEl = document.getElementById(`instanceCount-${entityType}`);
            const listEl = document.getElementById(`instanceList-${entityType}`);
            
            if (!countEl || !listEl) return;
            
            // Update count
            countEl.textContent = instances.length;
            
            // Update list
            if (instances.length === 0) {
                listEl.innerHTML = '<div style="padding: 5px; background: rgba(255,255,255,0.1); border-radius: 5px; opacity: 0.7;">No active instances</div>';
            } else {
                listEl.innerHTML = instances.map(inst => `
                    <div style="padding: 8px; background: rgba(255,255,255,0.15); border-radius: 5px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: bold;">${inst.id}</div>
                            <div style="font-size: 0.85em; opacity: 0.8;">Port ${inst.port}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.8em; opacity: 0.9;">üü¢ Online</div>
                            ${inst.uptime ? `<div style="font-size: 0.75em; opacity: 0.7;">${inst.uptime}</div>` : ''}
                        </div>
                    </div>
                `).join('');
            }
            
            // Update total count in status bar
            const totalActive = Object.values(activeInstances).reduce((sum, list) => sum + list.length, 0);
            const totalEl = document.getElementById('activeInstancesTotal');
            if (totalEl) {
                // Aggiorna solo il numero, non l'indicatore
                const numberSpan = totalEl.querySelector('span');
                if (numberSpan) {
                    numberSpan.textContent = totalActive;
                } else {
                    totalEl.textContent = totalActive;
                }
            }
        }

        // Check specific entity
        async function checkEntity(entityName, baseUrl) {
            const statusId = `status-${entityName.toLowerCase()}`;
            const statusEl = document.getElementById(statusId);
            
            if (!statusEl) return;
            
            statusEl.textContent = 'Checking...';
            statusEl.className = 'status offline';

            try {
                const response = await fetch(`${baseUrl}/health`, { 
                    method: 'GET',
                    timeout: 5000 
                });
                
                if (response.ok) {
                    statusEl.textContent = 'Online';
                    statusEl.className = 'status online';
                    addLog(`${entityName} is online at ${baseUrl}`, 'info');
                    
                    // Update system status
                    document.getElementById('systemStatus').textContent = '‚úì Healthy';
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                statusEl.textContent = 'Offline';
                statusEl.className = 'status offline';
                addLog(`${entityName} is offline: ${error.message}`, 'warning');
            }
        }

        // Refresh metrics
        async function refreshMetrics() {
            const baseUrl = 'http://localhost:5000'; // Try EA first (default port)
            
            try {
                const response = await fetch(`${baseUrl}/api/monitoring/metrics`);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update status bar
                    const uptime = Math.round(data.uptime_seconds);
                    document.getElementById('uptime').textContent = formatUptime(uptime);
                    document.getElementById('requestsPerSec').textContent = 
                        data.overall.requests_per_second.toFixed(2);
                    
                    // Update metrics panel
                    document.getElementById('metricTotalReq').textContent = 
                        data.overall.total_requests;
                    document.getElementById('metricErrorRate').textContent = 
                        data.overall.error_rate_percent.toFixed(1) + '%';
                    document.getElementById('metricLatency').textContent = 
                        Math.round(data.overall.avg_latency_ms) + 'ms';
                    document.getElementById('metricEnrollment').textContent = 
                        data.counters.enrollment_requests || 0;
                    
                    addLog('Metrics refreshed successfully', 'info');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                addLog(`Failed to fetch metrics: ${error.message}`, 'warning');
            }
        }

        // Format uptime
        function formatUptime(seconds) {
            if (seconds < 60) return seconds + 's';
            if (seconds < 3600) return Math.round(seconds / 60) + 'm';
            if (seconds < 86400) return Math.round(seconds / 3600) + 'h';
            return Math.round(seconds / 86400) + 'd';
        }

        // Add log entry
        function addLog(message, level = 'info') {
            const logViewer = document.getElementById('logViewer');
            const timestamp = new Date().toLocaleTimeString();
            const levelUpper = level.toUpperCase();
            
            const logLine = document.createElement('div');
            logLine.className = `log-line ${level}`;
            logLine.textContent = `[${timestamp}] [${levelUpper}] ${message}`;
            
            logViewer.appendChild(logLine);
            
            // Keep only last 50 logs
            while (logViewer.children.length > 50) {
                logViewer.removeChild(logViewer.firstChild);
            }
            
            // Auto-scroll to bottom
            logViewer.scrollTop = logViewer.scrollHeight;
        }

        // Open Swagger UI
        function openSwagger() {
            const url = 'http://localhost:5000/api/docs';  // EA default port
            window.open(url, '_blank');
            addLog('Opening Swagger UI...', 'info');
        }

        // Run tests
        function runTests() {
            addLog('Running test suite...', 'info');
            addLog('Execute: python -m pytest tests/ -v', 'info');
            alert('Run in terminal:\npython -m pytest tests/ -v');
        }

        // Start entity
        function startEntity(entityType, port) {
            addLog(`Starting ${entityType} on port ${port}...`, 'info');
            
            // Build command
            let command;
            if (entityType === 'RootCA') {
                command = `python server.py --entity RootCA --port ${port}`;
            } else {
                command = `python server.py --entity ${entityType} --port ${port}`;
            }
            
            // Show instructions in modal
            const instructions = `
To start ${entityType}, open a NEW PowerShell terminal and run:

${command}

Or click "Copy Command" below and paste it in your terminal.

The entity will start on port ${port}.
After starting, refresh this dashboard to see it online! üü¢
            `.trim();
            
            // Create modal
            showStartModal(entityType, command, instructions, port);
        }

        // Show modal with start instructions
        function showStartModal(entityType, command, instructions, port) {
            // Remove existing modal if any
            const existingModal = document.getElementById('startModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Create modal HTML
            const modal = document.createElement('div');
            modal.id = 'startModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                    <h2 style="color: #667eea; margin-bottom: 20px;">üöÄ Start ${entityType}</h2>
                    <pre style="background: #1f2937; color: #10b981; padding: 15px; border-radius: 8px; overflow-x: auto; font-family: 'Courier New', monospace; margin: 20px 0;">${command}</pre>
                    <p style="color: #666; margin-bottom: 20px; line-height: 1.6;">${instructions.replace(/\n/g, '<br>')}</p>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="copyCommand('${command}')" style="flex: 1; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1em;">
                            üìã Copy Command
                        </button>
                        <button onclick="closeStartModal()" style="flex: 1; padding: 12px; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1em;">
                            ‚úï Close
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close on background click
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeStartModal();
                }
            });
        }

        // Copy command to clipboard
        function copyCommand(command) {
            navigator.clipboard.writeText(command).then(() => {
                addLog('Command copied to clipboard!', 'info');
                alert('‚úÖ Command copied! Paste it in a PowerShell terminal.');
                closeStartModal();
            }).catch(err => {
                addLog('Failed to copy command', 'error');
                alert('‚ùå Failed to copy. Please copy manually.');
            });
        }

        // Close start modal
        function closeStartModal() {
            const modal = document.getElementById('startModal');
            if (modal) {
                modal.remove();
            }
        }

        // Show request form
        function showRequestForm(title, fields, onSubmit) {
            // Remove existing modal if any
            const existingModal = document.getElementById('requestFormModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Build form HTML
            let formHTML = '';
            fields.forEach(field => {
                if (field.type === 'textarea') {
                    formHTML += `
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; color: #333; font-weight: 600; margin-bottom: 5px;">${field.label}:</label>
                            <textarea name="${field.name}" placeholder="${field.placeholder || ''}" ${field.required ? 'required' : ''} style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 0.9em; min-height: 80px;">${field.value || ''}</textarea>
                        </div>
                    `;
                } else if (field.type === 'checkbox') {
                    formHTML += `
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; color: #333; font-weight: 600; cursor: pointer;">
                                <input type="checkbox" name="${field.name}" ${field.value ? 'checked' : ''} ${field.required ? 'required' : ''} style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer;">
                                <span>${field.label}</span>
                            </label>
                        </div>
                    `;
                } else {
                    formHTML += `
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; color: #333; font-weight: 600; margin-bottom: 5px;">${field.label}:</label>
                            <input type="${field.type}" name="${field.name}" value="${field.value || ''}" placeholder="${field.placeholder || ''}" min="${field.min || ''}" max="${field.max || ''}" ${field.required ? 'required' : ''} style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1em;">
                        </div>
                    `;
                }
            });
            
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'requestFormModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                overflow-y: auto;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3); margin: 20px;">
                    <h2 style="color: #667eea; margin-bottom: 20px;">üß™ ${title}</h2>
                    <form id="apiTestForm">
                        ${formHTML}
                        <div style="display: flex; gap: 10px; margin-top: 25px;">
                            <button type="submit" style="flex: 2; padding: 12px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1em;">
                                ‚ñ∂Ô∏è Send Request
                            </button>
                            <button type="button" onclick="generateRandomFormData(event)" style="flex: 1; padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9em;">
                                üé≤ Random
                            </button>
                            <button type="button" onclick="closeRequestForm()" style="flex: 1; padding: 12px; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1em;">
                                ‚úï Cancel
                            </button>
                        </div>
                    </form>
                    <div style="margin-top: 15px; padding: 10px; background: #f0f9ff; border-left: 3px solid #3b82f6; border-radius: 4px; font-size: 0.85em; color: #1e40af;">
                        <strong>‚ÑπÔ∏è Tip:</strong> Click "üé≤ Random" to generate valid random test data
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Handle form submission
            const form = document.getElementById('apiTestForm');
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Collect form data
                const formData = {};
                fields.forEach(field => {
                    const input = form.elements[field.name];
                    if (field.type === 'checkbox') {
                        formData[field.name] = input.checked;
                    } else {
                        formData[field.name] = input.value;
                    }
                });
                
                // Close modal and execute callback
                closeRequestForm();
                onSubmit(formData);
            });
            
            // Close on background click
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeRequestForm();
                }
            });
        }

        // Close request form
        function closeRequestForm() {
            const modal = document.getElementById('requestFormModal');
            if (modal) {
                modal.remove();
            }
        }

        // Generate a real ECDSA P-256 key pair using Web Crypto API
        async function generateRealPublicKey() {
            try {
                // Generate ECDSA key pair with P-256 curve
                const keyPair = await window.crypto.subtle.generateKey(
                    {
                        name: "ECDSA",
                        namedCurve: "P-256"
                    },
                    true,
                    ["sign", "verify"]
                );
                
                // Export public key in SPKI format (PEM-ready)
                const exported = await window.crypto.subtle.exportKey("spki", keyPair.publicKey);
                
                // Convert ArrayBuffer to base64
                const base64 = btoa(String.fromCharCode(...new Uint8Array(exported)));
                
                // Format as PEM
                const lines = base64.match(/.{1,64}/g) || [];
                const pem = `-----BEGIN PUBLIC KEY-----\n${lines.join('\n')}\n-----END PUBLIC KEY-----`;
                
                return pem;
            } catch (error) {
                console.error('Failed to generate key:', error);
                // Fallback to a known valid test key
                return `-----BEGIN PUBLIC KEY-----
MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEaxfR8uEsQkf4vObuVjpEDydz2BLe
szoPSqE5RdiYwpZP40Li/hp/m47nuk2g+eFivOM1drMV7Oy2tAaDe/UfWQ==
-----END PUBLIC KEY-----`;
            }
        }

        // Helper: Check if string is already in PEM format
        function isPEM(str) {
            return str.includes('-----BEGIN') && str.includes('-----END');
        }

        // Generate random form data
        function generateRandomFormData(event) {
            event.preventDefault();
            const form = document.getElementById('apiTestForm');
            if (!form) return;

            // Generate random hex string
            function randomHex(length) {
                let result = '';
                const chars = '0123456789ABCDEF';
                for (let i = 0; i < length; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return result;
            }

            // Generate random vehicle ID
            const timestamp = Date.now();
            const randomSuffix = Math.floor(Math.random() * 10000).toString().padStart(4, '0');

            // Fill form fields with random data
            Array.from(form.elements).forEach(input => {
                if (input.name === 'apiKey') {
                    // Skip API key - user must provide
                    return;
                }
                if (input.name === 'its_id') {
                    input.value = `IT-VEHICLE-${timestamp}-${randomSuffix}`;
                }
                else if (input.name === 'canonical_id') {
                    // Generate VIN-like canonical ID (17 chars)
                    input.value = `VIN-${randomHex(17)}`;
                }
                else if (input.name === 'public_key') {
                    // Generate a real ECDSA key pair and extract public key in PEM
                    generateRealPublicKey().then(pem => {
                        input.value = pem;
                    });
                }
                else if (input.name === 'enrollment_certificate') {
                    input.value = 'MOCK_EC_' + randomHex(32);
                }
                else if (input.name === 'permissions') {
                    const allPerms = ['CAM', 'DENM', 'SPATEM', 'MAPEM', 'IVIM', 'SREM', 'SSEM'];
                    const count = Math.floor(Math.random() * 3) + 2; // 2-4 permissions
                    const selected = [];
                    for (let i = 0; i < count; i++) {
                        const perm = allPerms[Math.floor(Math.random() * allPerms.length)];
                        if (!selected.includes(perm)) selected.push(perm);
                    }
                    input.value = selected.join(',');
                }
                else if (input.name === 'validity_period') {
                    input.value = Math.floor(Math.random() * 21) + 7; // 7-27 days
                }
                else if (input.name === 'batch_size') {
                    input.value = Math.floor(Math.random() * 16) + 5; // 5-20 ATs
                }
            });

            addLog('üé≤ Random test data generated', 'info');
        }

        // ========== API TESTING FUNCTIONS ==========

        // Test Enrollment - Simple
        async function testEnrollmentSimple() {
            // Show form to customize request
            const defaultItsId = "TestVehicle_" + Date.now();
            // Generate a real public key in PEM format
            const defaultPubKey = await generateRealPublicKey();
            
            showRequestForm('Enrollment Certificate Request', [
                { label: 'API Key', name: 'apiKey', type: 'password', placeholder: 'Enter EA API Key', required: true },
                { label: 'ITS ID (Logical ID - can change)', name: 'its_id', type: 'text', value: defaultItsId, required: true },
                { label: 'Canonical ID (Permanent HW ID - immutable)', name: 'canonical_id', type: 'text', value: "VIN-" + defaultItsId, required: true },
                { label: 'Public Key (PEM Format)', name: 'public_key', type: 'textarea', value: defaultPubKey, required: true }
            ], async (formData) => {
                showApiLoading('Testing Enrollment Certificate request...');
                addLog('Testing EA: POST /api/enrollment/request/simple', 'info');

                // Use public key as-is (already in PEM format from form or generated)
                const requestBody = {
                    "its_id": formData.its_id,
                    "canonical_id": formData.canonical_id,
                    "public_key": formData.public_key
                };

                try {
                    const headers = {
                        'Content-Type': 'application/json',
                        'X-API-Key': formData.apiKey
                    };

                    const response = await fetch('http://localhost:5000/api/enrollment/request/simple', {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(requestBody)
                    });

                    const data = await response.json();
                    showApiResponse(response.status, data, 'POST /api/enrollment/request/simple');
                    
                    if (response.ok) {
                        addLog(`‚úÖ Enrollment Certificate issued for ${formData.its_id}!`, 'info');
                        if (data.certificate) {
                            addLog(`   Serial: ${data.serial_number || 'N/A'}`, 'info');
                        }
                    } else {
                        addLog(`‚ùå Enrollment failed: ${response.status}`, 'error');
                    }
                } catch (error) {
                    showApiError(error, 'POST /api/enrollment/request/simple');
                    addLog(`‚ùå Request failed: ${error.message}`, 'error');
                }
            });
        }

        // Test Enrollment - ETSI Format
        async function testEnrollmentETSI() {
            const apiKey = prompt('Enter EA API Key (or leave empty to skip auth):');
            showApiLoading('Testing ETSI Enrollment request...');
            addLog('Testing EA: POST /api/enrollment/request', 'info');

            alert('‚ö†Ô∏è ETSI format requires ASN.1 OER encoded data.\nThis demo uses simplified format.\nUse Swagger UI for full ETSI testing.');
            
            // For demo purposes, show what the request would look like
            const mockRequest = {
                "format": "ETSI TS 102941",
                "message_type": "EnrollmentRequest",
                "canonical_id": "test_vehicle_" + Date.now(),
                "public_key_compressed": "03A1B2C3D4..."
            };

            showApiResponse(200, mockRequest, 'POST /api/enrollment/request (Mock)');
            addLog('‚ÑπÔ∏è Use Swagger UI for full ETSI compliance testing', 'info');
        }

        // Test Authorization - Single AT
        async function testAuthorizationSingle() {
            showRequestForm('Authorization Ticket Request', [
                { label: 'API Key', name: 'apiKey', type: 'password', placeholder: 'Enter AA API Key', required: true },
                { label: 'Enrollment Certificate (PEM)', name: 'enrollment_certificate', type: 'textarea', placeholder: 'Paste EC in PEM format or use mock data', value: 'MOCK_EC_DATA', required: true },
                { label: 'Requested Permissions (comma-separated)', name: 'permissions', type: 'text', value: 'CAM,DENM', required: true },
                { label: 'Validity Period (days)', name: 'validity_period', type: 'number', value: '7', required: true }
            ], async (formData) => {
                showApiLoading('Testing Authorization Ticket request...');
                addLog('Testing AA: POST /api/authorization/request', 'info');

                const requestBody = {
                    "enrollment_certificate": formData.enrollment_certificate,
                    "requested_permissions": formData.permissions.split(',').map(p => p.trim()),
                    "validity_period": parseInt(formData.validity_period)
                };

                try {
                    const headers = {
                        'Content-Type': 'application/json',
                        'X-API-Key': formData.apiKey
                    };

                    const response = await fetch('http://localhost:5001/api/authorization/request', {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(requestBody)
                    });

                    const data = await response.json();
                    showApiResponse(response.status, data, 'POST /api/authorization/request');
                    
                    if (response.ok) {
                        addLog('‚úÖ Authorization Ticket issued successfully!', 'info');
                    } else {
                        addLog(`‚ùå Authorization failed: ${response.status}`, 'error');
                    }
                } catch (error) {
                    showApiError(error, 'POST /api/authorization/request');
                    addLog(`‚ùå Request failed: ${error.message}`, 'error');
                }
            });
        }

        // Test Authorization - Butterfly
        async function testAuthorizationButterfly() {
            showRequestForm('Butterfly Key Expansion Request', [
                { label: 'API Key', name: 'apiKey', type: 'password', placeholder: 'Enter AA API Key', required: true },
                { label: 'Enrollment Certificate (PEM)', name: 'enrollment_certificate', type: 'textarea', placeholder: 'Paste EC in PEM format or use mock data', value: 'MOCK_EC_DATA', required: true },
                { label: 'Requested Permissions (comma-separated)', name: 'permissions', type: 'text', value: 'CAM,DENM', required: true },
                { label: 'Batch Size', name: 'batch_size', type: 'number', value: '5', required: true },
                { label: 'Validity Period (days)', name: 'validity_period', type: 'number', value: '7', required: true }
            ], async (formData) => {
                showApiLoading(`Testing Butterfly Key Expansion (${formData.batch_size} ATs)...`);
                addLog('Testing AA: POST /api/authorization/request/butterfly', 'info');

                const requestBody = {
                    "enrollment_certificate": formData.enrollment_certificate,
                    "requested_permissions": formData.permissions.split(',').map(p => p.trim()),
                    "batch_size": parseInt(formData.batch_size),
                    "validity_period": parseInt(formData.validity_period)
                };

                try {
                    const headers = {
                        'Content-Type': 'application/json',
                        'X-API-Key': formData.apiKey
                    };

                    const response = await fetch('http://localhost:5001/api/authorization/request/butterfly', {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(requestBody)
                    });

                    const data = await response.json();
                    showApiResponse(response.status, data, 'POST /api/authorization/request/butterfly');
                    
                    if (response.ok) {
                        addLog(`‚úÖ Butterfly expansion: ${data.batch_size || formData.batch_size} ATs issued!`, 'info');
                    } else {
                        addLog(`‚ùå Butterfly request failed: ${response.status}`, 'error');
                    }
                } catch (error) {
                    showApiError(error, 'POST /api/authorization/request/butterfly');
                    addLog(`‚ùå Request failed: ${error.message}`, 'error');
                }
            });
        }

        // Test CRL - Full
        async function testCRLFull() {
            showApiLoading('Fetching Full CRL...');
            addLog('Testing: GET /api/crl/full', 'info');

            try {
                const response = await fetch('http://localhost:5001/api/crl/full');
                const data = await response.json();
                showApiResponse(response.status, data, 'GET /api/crl/full');
                
                if (response.ok) {
                    addLog(`‚úÖ Full CRL retrieved: ${data.revoked_count || 0} revoked certs`, 'info');
                }
            } catch (error) {
                showApiError(error, 'GET /api/crl/full');
                addLog(`‚ùå Request failed: ${error.message}`, 'error');
            }
        }

        // Test CRL - Delta
        async function testCRLDelta() {
            showApiLoading('Fetching Delta CRL...');
            addLog('Testing: GET /api/crl/delta', 'info');

            try {
                const response = await fetch('http://localhost:5001/api/crl/delta');
                const data = await response.json();
                showApiResponse(response.status, data, 'GET /api/crl/delta');
                
                if (response.ok) {
                    addLog(`‚úÖ Delta CRL retrieved: ${data.revoked_count || 0} new revocations`, 'info');
                }
            } catch (error) {
                showApiError(error, 'GET /api/crl/delta');
                addLog(`‚ùå Request failed: ${error.message}`, 'error');
            }
        }

        // Test Trust List - Full
        async function testTrustListFull() {
            showApiLoading('Fetching Full Trust List...');
            addLog('Testing: GET /api/trust-list/full', 'info');

            try {
                const response = await fetch('http://localhost:5002/api/trust-list/full');
                const data = await response.json();
                showApiResponse(response.status, data, 'GET /api/trust-list/full');
                
                if (response.ok) {
                    addLog(`‚úÖ Full Trust List retrieved: ${data.trust_anchors?.length || 0} trust anchors`, 'info');
                }
            } catch (error) {
                showApiError(error, 'GET /api/trust-list/full');
                addLog(`‚ùå Request failed: ${error.message}`, 'error');
            }
        }

        // Test Trust List - Delta
        async function testTrustListDelta() {
            showApiLoading('Fetching Delta Trust List...');
            addLog('Testing: GET /api/trust-list/delta', 'info');

            try {
                const response = await fetch('http://localhost:5002/api/trust-list/delta');
                const data = await response.json();
                showApiResponse(response.status, data, 'GET /api/trust-list/delta');
                
                if (response.ok) {
                    addLog(`‚úÖ Delta Trust List retrieved: ${data.additions?.length || 0} additions`, 'info');
                }
            } catch (error) {
                showApiError(error, 'GET /api/trust-list/delta');
                addLog(`‚ùå Request failed: ${error.message}`, 'error');
            }
        }

        // Show API loading state
        function showApiLoading(message) {
            const viewer = document.getElementById('apiResponse');
            viewer.innerHTML = `<span style="color: #f59e0b;">‚è≥ ${message}</span>`;
        }

        // Store full response for toggle feature
        let fullResponseData = null;
        let showingFullResponse = false;

        // Show API response (con truncate intelligente per certificati lunghi)
        function showApiResponse(status, data, endpoint) {
            const viewer = document.getElementById('apiResponse');
            const statusColor = status >= 200 && status < 300 ? '#10b981' : '#ef4444';
            
            // Salva i dati completi per la funzione toggle
            fullResponseData = { status, data, endpoint };
            showingFullResponse = false;
            
            // Trunca i certificati lunghi per mantenere il layout pulito
            const truncatedData = truncateLongFields(data);
            const jsonString = JSON.stringify(truncatedData, null, 2);
            
            viewer.innerHTML = `
<span style="color: #3b82f6;">HTTP ${status}</span> <span style="color: #6b7280;">${endpoint}</span>

<span style="color: ${statusColor};">Response:</span>
${jsonString}
            `.trim();
            
            // Mostra il pulsante "Show Full Response" se ci sono campi troncati
            const hasLongFields = JSON.stringify(data).length > JSON.stringify(truncatedData).length;
            document.getElementById('toggleFullResponseBtn').style.display = hasLongFields ? 'inline-block' : 'none';
            document.getElementById('toggleFullResponseBtn').textContent = 'üìã Show Full Response';
        }

        // Toggle tra risposta troncata e completa
        function toggleFullResponse() {
            if (!fullResponseData) return;
            
            const viewer = document.getElementById('apiResponse');
            const btn = document.getElementById('toggleFullResponseBtn');
            const { status, data, endpoint } = fullResponseData;
            const statusColor = status >= 200 && status < 300 ? '#10b981' : '#ef4444';
            
            showingFullResponse = !showingFullResponse;
            
            if (showingFullResponse) {
                // Mostra risposta completa
                const jsonString = JSON.stringify(data, null, 2);
                viewer.innerHTML = `
<span style="color: #3b82f6;">HTTP ${status}</span> <span style="color: #6b7280;">${endpoint}</span>

<span style="color: ${statusColor};">Full Response:</span>
${jsonString}
                `.trim();
                btn.textContent = 'üìã Show Truncated Response';
            } else {
                // Mostra risposta troncata
                const truncatedData = truncateLongFields(data);
                const jsonString = JSON.stringify(truncatedData, null, 2);
                viewer.innerHTML = `
<span style="color: #3b82f6;">HTTP ${status}</span> <span style="color: #6b7280;">${endpoint}</span>

<span style="color: ${statusColor};">Response:</span>
${jsonString}
                `.trim();
                btn.textContent = 'üìã Show Full Response';
            }
        }

        // Trunca campi lunghi (certificati, chiavi) per mantenere il layout leggibile
        function truncateLongFields(obj, maxLength = 100) {
            if (typeof obj !== 'object' || obj === null) {
                return obj;
            }
            
            if (Array.isArray(obj)) {
                return obj.map(item => truncateLongFields(item, maxLength));
            }
            
            const truncated = {};
            for (const [key, value] of Object.entries(obj)) {
                if (typeof value === 'string' && value.length > maxLength) {
                    // Identifica se √® un certificato o chiave
                    if (value.includes('BEGIN CERTIFICATE') || value.includes('BEGIN PUBLIC KEY')) {
                        const lines = value.split('\n');
                        const header = lines[0];
                        const footer = lines[lines.length - 1] || lines[lines.length - 2];
                        truncated[key] = `${header}\n... [${value.length} chars, ${lines.length} lines] ...\n${footer}`;
                    } else {
                        // Trunca stringhe lunghe generiche
                        truncated[key] = value.substring(0, maxLength) + `... [${value.length} chars total]`;
                    }
                } else if (typeof value === 'object') {
                    truncated[key] = truncateLongFields(value, maxLength);
                } else {
                    truncated[key] = value;
                }
            }
            return truncated;
        }

        // Show API error
        function showApiError(error, endpoint) {
            const viewer = document.getElementById('apiResponse');
            viewer.innerHTML = `
<span style="color: #ef4444;">‚ùå ERROR</span> <span style="color: #6b7280;">${endpoint}</span>

<span style="color: #ef4444;">Error:</span>
${error.message}

<span style="color: #f59e0b;">Tip:</span> Make sure the entity is running on the correct port!
            `.trim();
        }

        // Show Entity Generator Form with custom names
        function showEntityGeneratorForm() {
            // Create custom modal for entity generator with dynamic name fields
            const modalContent = `
                <h3 style="color: #667eea; margin-bottom: 20px;">üèóÔ∏è Bulk Entity Generator</h3>
                
                <form id="entityGeneratorForm">
                    <!-- EA Section -->
                    <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #10b981;">
                        <h4 style="color: #10b981; margin-bottom: 10px;">üìù Enrollment Authorities (EA)</h4>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Number of EAs (0-20):</label>
                        <input type="number" id="num_ea" min="0" max="20" value="0" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px;" onchange="updateEntityNameFields()">
                        <div id="ea_names_container"></div>
                    </div>
                    
                    <!-- AA Section -->
                    <div style="background: #eff6ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #3b82f6;">
                        <h4 style="color: #3b82f6; margin-bottom: 10px;">üé´ Authorization Authorities (AA)</h4>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Number of AAs (0-20):</label>
                        <input type="number" id="num_aa" min="0" max="20" value="0" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px;" onchange="updateEntityNameFields()">
                        <div id="aa_names_container"></div>
                    </div>
                    
                    <!-- TLM Info Section -->
                    <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #f59e0b;">
                        <h4 style="color: #f59e0b; margin-bottom: 10px;">üìã Trust List Manager (TLM)</h4>
                        <p style="color: #92400e; font-size: 0.9em; font-style: italic;">
                            ‚ÑπÔ∏è TLM_MAIN will be automatically created if it doesn't exist already. TLM is always a single centralized instance for the entire PKI.
                        </p>
                    </div>
                    
                    <!-- Port Info -->
                    <div style="background: #f3f4f6; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #6b7280; margin-bottom: 10px;">‚ÑπÔ∏è Port Assignment Rules</h4>
                        <ul style="margin-left: 20px; color: #4b5563; font-size: 0.9em;">
                            <li><strong>RootCA:</strong> Port 5999 (1 instance)</li>
                            <li><strong>EA:</strong> Ports 5000-5019 (up to 20 instances)</li>
                            <li><strong>AA:</strong> Ports 5020-5039 (up to 20 instances)</li>
                            <li><strong>TLM:</strong> Port 5050 (1 instance)</li>
                        </ul>
                        <p style="color: #6b7280; font-size: 0.85em; margin-top: 8px; font-style: italic;">
                            Ports are automatically assigned from these ranges
                        </p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button type="button" class="btn btn-secondary" onclick="closeEntityGeneratorModal()" style="width: 100%;">
                            ‚ùå Cancel
                        </button>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">
                            ‚úÖ Generate
                        </button>
                    </div>
                </form>
            `;
            
            // Create modal
            let modal = document.getElementById('entityGeneratorModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'entityGeneratorModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.7);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;
                
                const modalContainer = document.createElement('div');
                modalContainer.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    padding: 30px;
                    max-width: 700px;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
                `;
                modalContainer.id = 'entityGeneratorModalBody';
                
                modal.appendChild(modalContainer);
                document.body.appendChild(modal);
            }
            
            document.getElementById('entityGeneratorModalBody').innerHTML = modalContent;
            
            // Add form submit handler
            document.getElementById('entityGeneratorForm').addEventListener('submit', function(e) {
                e.preventDefault();
                generateEntitiesWithNames();
            });
        }
        
        // Update entity name input fields dynamically
        function updateEntityNameFields() {
            const num_ea = parseInt(document.getElementById('num_ea').value) || 0;
            const num_aa = parseInt(document.getElementById('num_aa').value) || 0;
            
            // Generate EA name fields
            const eaContainer = document.getElementById('ea_names_container');
            eaContainer.innerHTML = '';
            if (num_ea > 0) {
                eaContainer.innerHTML = '<label style="display: block; margin-top: 10px; margin-bottom: 5px; font-weight: bold; color: #059669;">Entity Names (optional - auto-generated if empty):</label>';
                for (let i = 0; i < num_ea; i++) {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.id = `ea_name_${i}`;
                    input.placeholder = `EA name ${i+1} (e.g., EA_HIGHWAY_01, EA_CITY_01)`;
                    input.style.cssText = 'width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #10b981; border-radius: 5px;';
                    eaContainer.appendChild(input);
                }
            }
            
            // Generate AA name fields
            const aaContainer = document.getElementById('aa_names_container');
            aaContainer.innerHTML = '';
            if (num_aa > 0) {
                aaContainer.innerHTML = '<label style="display: block; margin-top: 10px; margin-bottom: 5px; font-weight: bold; color: #2563eb;">Entity Names (optional - auto-generated if empty):</label>';
                for (let i = 0; i < num_aa; i++) {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.id = `aa_name_${i}`;
                    input.placeholder = `AA name ${i+1} (e.g., AA_TRAFFIC, AA_PARKING)`;
                    input.style.cssText = 'width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #3b82f6; border-radius: 5px;';
                    aaContainer.appendChild(input);
                }
            }
        }
        
        // Close entity generator modal
        function closeEntityGeneratorModal() {
            const modal = document.getElementById('entityGeneratorModal');
            if (modal) {
                modal.remove();
            }
        }

        // Generate entities with custom names
        async function generateEntitiesWithNames() {
            const num_ea = parseInt(document.getElementById('num_ea').value) || 0;
            const num_aa = parseInt(document.getElementById('num_aa').value) || 0;
            
            if (num_ea === 0 && num_aa === 0) {
                alert('‚ö†Ô∏è Please specify at least one entity type to generate!');
                return;
            }
            
            // Collect custom names
            const ea_names = [];
            const aa_names = [];
            
            for (let i = 0; i < num_ea; i++) {
                const nameInput = document.getElementById(`ea_name_${i}`);
                const name = nameInput ? nameInput.value.trim() : '';
                if (name) {
                    // Validate name format (uppercase, alphanumeric + underscore)
                    if (!/^[A-Z][A-Z0-9_]*$/.test(name)) {
                        alert(`‚ö†Ô∏è Invalid EA name "${name}". Names must start with uppercase letter and contain only uppercase letters, numbers, and underscores.`);
                        return;
                    }
                    if (!name.startsWith('EA_')) {
                        alert(`‚ö†Ô∏è EA name "${name}" must start with "EA_"`);
                        return;
                    }
                }
                ea_names.push(name);
            }
            
            for (let i = 0; i < num_aa; i++) {
                const nameInput = document.getElementById(`aa_name_${i}`);
                const name = nameInput ? nameInput.value.trim() : '';
                if (name) {
                    // Validate name format
                    if (!/^[A-Z][A-Z0-9_]*$/.test(name)) {
                        alert(`‚ö†Ô∏è Invalid AA name "${name}". Names must start with uppercase letter and contain only uppercase letters, numbers, and underscores.`);
                        return;
                    }
                    if (!name.startsWith('AA_')) {
                        alert(`‚ö†Ô∏è AA name "${name}" must start with "AA_"`);
                        return;
                    }
                }
                aa_names.push(name);
            }
            
            // Close modal
            closeEntityGeneratorModal();
            
            // Show generating message (TLM is always included automatically)
            addLog(`Generating ${num_ea} EAs, ${num_aa} AAs + TLM with auto-start in separate terminals...`, 'info');
            
            // Build command with custom names (always include --tlm)
            let command = 'python setup.py';
            
            if (num_ea > 0) {
                command += ` --ea ${num_ea}`;
                // Add custom EA names if provided
                const customEaNames = ea_names.filter(n => n.length > 0);
                if (customEaNames.length > 0) {
                    command += ` --ea-names "${customEaNames.join(',')}"`;
                }
            }
            
            if (num_aa > 0) {
                command += ` --aa ${num_aa}`;
                // Add custom AA names if provided
                const customAaNames = aa_names.filter(n => n.length > 0);
                if (customAaNames.length > 0) {
                    command += ` --aa-names "${customAaNames.join(',')}"`;
                }
            }
            
            // Always include TLM (will be created if it doesn't exist)
            command += ' --tlm';
            
            // Show instructions modal (include_tlm is always true)
            showGeneratedEntitiesInstructions(command, num_ea, num_aa, true, ea_names, aa_names);
            
            addLog('Entity generation configured! Follow the instructions in the modal.', 'info');
        }

        // Show instructions for generated entities
        function showGeneratedEntitiesInstructions(command, num_ea, num_aa, include_tlm, ea_names = [], aa_names = []) {
            const totalEntities = num_ea + num_aa + (include_tlm ? 1 : 0);
            
            // Build entity list with port ranges
            let entityList = '';
            
            if (num_ea > 0) {
                entityList += '<h4 style="color: #10b981; margin-top: 15px;">üìù Enrollment Authorities</h4><ul style="margin-left: 20px;">';
                for (let i = 0; i < num_ea; i++) {
                    const displayName = ea_names[i] || `EA (auto-generated ID)`;
                    entityList += `<li>${displayName} - Port auto-assigned from range 5000-5019</li>`;
                }
                entityList += '</ul>';
            }
            
            if (num_aa > 0) {
                entityList += '<h4 style="color: #3b82f6; margin-top: 15px;">üé´ Authorization Authorities</h4><ul style="margin-left: 20px;">';
                for (let i = 0; i < num_aa; i++) {
                    const displayName = aa_names[i] || `AA (auto-generated ID)`;
                    entityList += `<li>${displayName} - Port auto-assigned from range 5020-5039</li>`;
                }
                entityList += '</ul>';
            }
            
            if (include_tlm) {
                entityList += '<h4 style="color: #f59e0b; margin-top: 15px;">üìã Trust List Manager (Central)</h4><ul style="margin-left: 20px;">';
                entityList += `<li>TLM_MAIN (unique central instance) - Port 5050</li>`;
                entityList += '</ul>';
                entityList += '<p style="color: #f59e0b; font-size: 0.9em; margin-top: 5px;"><em>‚ÑπÔ∏è Note: TLM will be created automatically if it doesn\'t exist. It is always a single, centralized instance for the entire PKI.</em></p>';
            }
            
            const modalContent = `
                <h3 style="color: #667eea; margin-bottom: 20px;">üöÄ Entity Generation & Auto-Start</h3>
                
                <div style="background: #f3f4f6; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="margin-bottom: 10px;"><strong>Total Entities to Generate:</strong> ${totalEntities}</p>
                    ${entityList}
                </div>
                
                <div style="background: #1f2937; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="color: #10b981; margin-bottom: 10px;"><strong>Step 1: Run this command in PowerShell</strong></p>
                    <code style="color: #60a5fa; display: block; padding: 10px; background: #111827; border-radius: 5px; cursor: pointer; user-select: all; word-wrap: break-word; white-space: pre-wrap;" onclick="copyToClipboard(this.textContent)">${command}</code>
                    <p style="color: #9ca3af; font-size: 0.85em; margin-top: 5px;">Click to copy</p>
                </div>
                
                <div style="background: #dcfce7; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #10b981;">
                    <p style="color: #065f46; margin-bottom: 10px;"><strong>‚ú® Automatic Start Feature</strong></p>
                    <p style="color: #047857; font-size: 0.9em;">
                        The command above will <strong>automatically start all entities</strong> in separate PowerShell terminals!
                    </p>
                    <ul style="margin-left: 20px; color: #047857; font-size: 0.9em; margin-top: 10px;">
                        <li>Each entity gets its own dedicated terminal window</li>
                        <li>No need to manually run start scripts</li>
                        <li>Configuration files and startup scripts are still generated for reference</li>
                    </ul>
                    <p style="color: #047857; font-size: 0.85em; margin-top: 10px; font-style: italic;">
                        üí° To disable auto-start and only generate configs, add <code>--no-auto-start</code> to the command
                    </p>
                </div>
                
                <div style="background: #dbeafe; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
                    <p style="color: #1e40af; margin-bottom: 10px;"><strong>Step 2: Monitor in Dashboard</strong></p>
                    <p style="color: #1e3a8a; font-size: 0.9em;">
                        Once started, all entities will appear in the "Active Instances" panel above within seconds.
                        The dashboard automatically scans the assigned port ranges.
                    </p>
                </div>
                
                <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f59e0b;">
                    <p style="color: #92400e; margin-bottom: 10px;"><strong>üìÅ Generated Files</strong></p>
                    <ul style="margin-left: 20px; color: #78350f; font-size: 0.9em;">
                        <li><code>entity_configs.json</code> - Configuration file</li>
                        <li><code>start_all_entities.bat</code> - Windows batch script (backup)</li>
                        <li><code>start_all_entities.ps1</code> - PowerShell script (backup)</li>
                    </ul>
                    <p style="color: #78350f; font-size: 0.85em; margin-top: 10px;">
                        These scripts are created as backups. You can use them to restart entities later if needed.
                    </p>
                </div>
                
                <button class="btn btn-primary" style="width: 100%; margin-top: 10px;" onclick="closeInstructionsModal()">
                    ‚úÖ Got it!
                </button>
            `;
            
            // Create or get modal
            let modal = document.getElementById('instructionsModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'instructionsModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.7);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;
                
                const modalContainer = document.createElement('div');
                modalContainer.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    padding: 30px;
                    max-width: 700px;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
                `;
                modalContainer.id = 'instructionsModalBody';
                
                modal.appendChild(modalContainer);
                document.body.appendChild(modal);
                
                // Close on background click
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeInstructionsModal();
                    }
                });
            }
            
            const modalBody = document.getElementById('instructionsModalBody');
            modalBody.innerHTML = modalContent;
            modal.style.display = 'flex';
        }

        // Copy text to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                addLog('Command copied to clipboard!', 'info');
            }).catch(err => {
                addLog('Failed to copy: ' + err.message, 'error');
            });
        }

        // Close instructions modal
        function closeInstructionsModal() {
            const modal = document.getElementById('instructionsModal');
            if (modal) {
                modal.style.display = 'none';
            }
            addLog('You can now run the generation command in your terminal', 'info');
        }

        // ============================================
        // Daily Use Test Scripts Functions
        // ============================================

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                addLog(`Command copied to clipboard: ${text}`, 'success');
                showNotification('‚úÖ Copied!', 'Command copied to clipboard', 'success');
            }).catch(err => {
                addLog(`Failed to copy: ${err}`, 'error');
            });
        }

        function runInteractiveTester() {
            addLog('Opening interactive PKI tester...', 'info');
            showNotification('üéÆ Interactive Tester', 'Open a terminal and run: python examples/interactive_pki_tester.py', 'info');
            copyToClipboard('python examples/interactive_pki_tester.py');
        }

        function runQuickTest() {
            addLog('Preparing quick test...', 'info');
            showNotification('‚ö° Quick Test', 'Open a terminal and run: python examples/quick_test.py --test all', 'info');
            copyToClipboard('python examples/quick_test.py --test all');
        }

        async function loadTestResults() {
            try {
                addLog('Loading test results...', 'info');
                
                // Try to fetch test results file
                const response = await fetch('data/test_results.json');
                
                if (response.ok) {
                    const results = await response.json();
                    
                    if (results && results.length > 0) {
                        // Update counter
                        document.getElementById('savedTestResults').textContent = results.length;
                        
                        // Show summary
                        const summary = document.getElementById('testResultsSummary');
                        const successCount = results.filter(r => r.status === 'success').length;
                        const failedCount = results.filter(r => r.status === 'failed' || r.status === 'error').length;
                        
                        const lastTest = results[results.length - 1];
                        const lastTestDate = new Date(lastTest.timestamp).toLocaleString();
                        
                        summary.innerHTML = `
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 1.8em; font-weight: bold;">‚úÖ ${successCount}</div>
                                    <div style="font-size: 0.8em; opacity: 0.9;">Success</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 1.8em; font-weight: bold;">‚ùå ${failedCount}</div>
                                    <div style="font-size: 0.8em; opacity: 0.9;">Failed</div>
                                </div>
                            </div>
                            <div style="font-size: 0.85em; opacity: 0.9;">
                                <strong>Last Test:</strong> ${lastTest.test}<br>
                                <strong>Time:</strong> ${lastTestDate}
                            </div>
                        `;
                        
                        addLog(`Loaded ${results.length} test results`, 'success');
                    } else {
                        document.getElementById('testResultsSummary').innerHTML = `
                            <div style="text-align: center; opacity: 0.7; padding: 20px;">
                                No results yet.<br>
                                Run tests first!
                            </div>
                        `;
                        addLog('No test results found', 'info');
                    }
                } else {
                    throw new Error('Results file not found');
                }
            } catch (error) {
                addLog(`Could not load test results: ${error.message}`, 'warning');
                document.getElementById('testResultsSummary').innerHTML = `
                    <div style="text-align: center; opacity: 0.7; padding: 20px;">
                        No results available.<br>
                        Run tests first!
                    </div>
                `;
            }
        }

        function showTestResultsModal() {
            addLog('Opening test results details...', 'info');
            
            fetch('data/test_results.json')
                .then(response => response.json())
                .then(results => {
                    if (!results || results.length === 0) {
                        showNotification('‚ÑπÔ∏è No Results', 'No test results available yet', 'info');
                        return;
                    }
                    
                    let modalHTML = `
                        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
                            <div style="background: white; border-radius: 15px; padding: 30px; max-width: 900px; max-height: 80vh; overflow-y: auto; width: 90%;" onclick="event.stopPropagation()">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                    <h2 style="color: #667eea; margin: 0;">üìä Test Results Details</h2>
                                    <button onclick="this.closest('div[style*=fixed]').remove()" style="background: #ef4444; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer;">‚úï Close</button>
                                </div>
                                <div style="display: grid; gap: 15px;">
                    `;
                    
                    results.reverse().forEach((result, index) => {
                        const statusColor = result.status === 'success' ? '#10b981' : '#ef4444';
                        const statusIcon = result.status === 'success' ? '‚úÖ' : '‚ùå';
                        const date = new Date(result.timestamp).toLocaleString();
                        
                        modalHTML += `
                            <div style="background: #f9fafb; padding: 20px; border-radius: 10px; border-left: 4px solid ${statusColor};">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                    <h3 style="color: #333; margin: 0;">${statusIcon} ${result.test}</h3>
                                    <span style="background: ${statusColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85em;">${result.status.toUpperCase()}</span>
                                </div>
                                <p style="color: #666; font-size: 0.9em; margin: 5px 0;">‚è±Ô∏è ${date}</p>
                                ${result.details && Object.keys(result.details).length > 0 ? `
                                    <div style="background: white; padding: 12px; border-radius: 6px; margin-top: 10px;">
                                        <strong style="color: #667eea;">Details:</strong>
                                        <pre style="margin: 8px 0 0 0; font-size: 0.85em; color: #555; overflow-x: auto;">${JSON.stringify(result.details, null, 2)}</pre>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                    
                    modalHTML += `
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.insertAdjacentHTML('beforeend', modalHTML);
                })
                .catch(error => {
                    showNotification('‚ùå Error', 'Could not load test results', 'error');
                });
        }

        function runScenario(scenarioType) {
            const scenarios = {
                'single_enrollment': {
                    command: 'python examples/quick_test.py --test enrollment',
                    description: 'Single vehicle enrollment test'
                },
                'fleet': {
                    command: 'python examples/interactive_pki_tester.py',
                    description: 'Fleet enrollment test (run Test 3 from menu)'
                },
                'v2v': {
                    command: 'python examples/interactive_pki_tester.py',
                    description: 'V2V communication test (run Test 4 from menu)'
                },
                'performance': {
                    command: 'python examples/interactive_pki_tester.py',
                    description: 'Performance test (run Test 6 from menu)'
                },
                'validation': {
                    command: 'python examples/interactive_pki_tester.py',
                    description: 'Certificate validation (run Test 5 from menu)'
                },
                'full_suite': {
                    command: 'python examples/interactive_pki_tester.py',
                    description: 'Full test suite (run Test 7 from menu)'
                }
            };
            
            const scenario = scenarios[scenarioType];
            if (scenario) {
                addLog(`Running scenario: ${scenario.description}`, 'info');
                showNotification('üéØ Test Scenario', `${scenario.description}\n\nCommand: ${scenario.command}`, 'info');
                copyToClipboard(scenario.command);
            }
        }

        function showNotification(title, message, type = 'info') {
            const colors = {
                success: '#10b981',
                error: '#ef4444',
                warning: '#f59e0b',
                info: '#667eea'
            };
            
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: white;
                border-left: 4px solid ${colors[type]};
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                min-width: 300px;
                max-width: 400px;
                animation: slideIn 0.3s ease-out;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <h4 style="margin: 0 0 8px 0; color: ${colors[type]};">${title}</h4>
                        <p style="margin: 0; color: #666; font-size: 0.9em; white-space: pre-line;">${message}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 1.2em; cursor: pointer; color: #999; padding: 0 0 0 10px;">√ó</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(400px)';
                notification.style.transition = 'all 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        // Add animation style
        if (!document.getElementById('notificationStyles')) {
            const style = document.createElement('style');
            style.id = 'notificationStyles';
            style.textContent = `
                @keyframes slideIn {
                    from {
                        transform: translateX(400px);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
            `;
            document.head.appendChild(style);
        }

        // Auto-load test results on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadTestResults();
            setInterval(loadTestResults, 30000); // Refresh every 30 seconds
        });
    </script>
</body>
</html>
